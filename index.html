--==================================================--
-- RSQ KEY SYSTEM ‚Äî FULL PASTEBIN API INTEGRATION
--==================================================--

-- SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local TeleportService = game:GetService("TeleportService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local MarketplaceService = game:GetService("MarketplaceService")
local GroupService = game:GetService("GroupService")
local player = Players.LocalPlayer
local USER_ID = tostring(player.UserId)
local USER_NAME = player.Name
local PLACE_ID = game.PlaceId

--==================================================--
-- PASTEBIN API CONFIG
--==================================================--
local PASTEBIN_API_KEY = "SJWH8ifyZxDYYZ3IAA-OrXDtqLk-o02_" -- YOUR API KEY
local PASTEBIN_API_URL = "https://pastebin.com/api/api_post.php"
local PASTEBIN_RAW_URL = "https://pastebin.com/raw/"

-- Database configuration
local DATABASE_PASTE_KEY = "" -- Will be created/loaded
local DATABASE_NAME = "RSQ_System_DB"
local DATABASE_EXPIRE = "N" -- N=Never

-- Local storage
local LOCAL_FOLDER = "RSQ_System"
local PASTE_KEY_FILE = "paste_key.txt"
local KEY_STATUS_FILE = "key_status.json"

-- Other URLs
local GET_KEY_URL = "https://realscripts-q.github.io/KEY-JSONHandler/"
local DISCORD_WEBHOOK = "https://webhook.lewisakura.moe/api/webhooks/1453515343833338017/7VwwcpKDpSvIYr0PA3Ceh8YgMwIEba47CoyISHCZkvdaF2hUsvyUYw3zNV_TbYyDFTMy"

local SCRIPT_URLS = {
    "https://raw.githubusercontent.com/RealScripts-q/KEY-JSONHandler/main/D.lua",
    "https://raw.githubusercontent.com/RealScripts-q/KEY-JSONHandler/main/I.lua",
    "https://raw.githubusercontent.com/RealScripts-q/KEY-JSONHandler/main/N.lua",
}

-- GROUP REQUIREMENT
local REQUIRED_GROUP_ID = 687789545
local GROUP_JOIN_URL = "https://www.roblox.com/communities/687789545/CASHGRAB-EXPERIENCE#!/about"
local MERCH_URL = "https://www.roblox.com/catalog/136243714765116/Sythics-Merch"

--==================================================--
-- GLOBAL STATE
--==================================================--
local CurrentKey = nil
local KeyActive = false
local LastNotifTime = 0
local CachedData = nil
local GamesList = {}
local IsGuiOpen = false
local OpenButton = nil
local CurrentGUI = nil
local IsInitializing = true
local HasShownGUIAlready = false
local IsInRequiredGroup = false
local IsAdmin = false
local AdminUsers = {}
local CHECK_INTERVAL = 1

--==================================================--
-- HELPER FUNCTIONS
--==================================================--
local function string_trim(s)
    return s:match("^%s*(.-)%s*$")
end

local function createNotify(msg, color)
    local notifyGui = Instance.new("ScreenGui", CoreGui)
    notifyGui.Name = "RSQ_Notifications_" .. tostring(math.random(1, 1000))
    notifyGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    local frame = Instance.new("Frame", notifyGui)
    frame.Size = UDim2.new(0, 300, 0, 60)
    frame.Position = UDim2.new(1, 10, 0.8, 0)
    frame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    frame.BorderSizePixel = 0
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)
    
    local accent = Instance.new("Frame", frame)
    accent.Size = UDim2.new(0, 5, 1, 0)
    accent.BackgroundColor3 = color
    accent.BorderSizePixel = 0
    Instance.new("UICorner", accent).CornerRadius = UDim.new(0, 2)

    local label = Instance.new("TextLabel", frame)
    label.Size = UDim2.new(1, -20, 1, 0)
    label.Position = UDim2.new(0, 15, 0, 0)
    label.Text = msg
    label.TextColor3 = Color3.new(1, 1, 1)
    label.Font = Enum.Font.GothamBold
    label.TextSize = 13
    label.BackgroundTransparency = 1
    label.TextXAlignment = Enum.TextXAlignment.Left

    frame:TweenPosition(UDim2.new(1, -310, 0.8, 0), "Out", "Back", 0.5)
    task.delay(5, function()
        pcall(function()
            frame:TweenPosition(UDim2.new(1, 10, 0.8, 0), "In", "Sine", 0.5)
            task.wait(0.5)
            notifyGui:Destroy()
        end)
    end)
end

local function kickBanned(reason)
    pcall(function() setclipboard(GET_KEY_URL) end)
    local kickMsg = "üõë [RSQ RESTRICTION]\n\nReason: " .. (reason or "Blacklisted")
    while true do player:Kick(kickMsg) task.wait(0.5) end
end

local function isGUILoaded()
    for _, gui in pairs(CoreGui:GetChildren()) do
        if gui.Name == "RSQ_KeySystem" or gui.Name == "RSQ_AdvancedGamesGUI" or gui.Name == "RSQ_GameIdConfirm" then
            return true
        end
    end
    
    if player.PlayerGui then
        for _, gui in pairs(player.PlayerGui:GetChildren()) do
            if gui.Name == "RSQ_KeySystem" or gui.Name == "RSQ_AdvancedGamesGUI" or gui.Name == "RSQ_GameIdConfirm" then
                return true
            end
        end
    end
    
    return false
end

local function makeDraggable(frame, dragHandle)
    local dragging = false
    local dragInput
    local dragStart
    local startPos
    
    local function update(input)
        if dragging then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale, 
                startPos.X.Offset + delta.X,
                startPos.Y.Scale, 
                startPos.Y.Offset + delta.Y
            )
        end
    end
    
    dragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or 
           input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    dragHandle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or 
           input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input == dragInput or input.UserInputType == Enum.UserInputType.Touch) then
            update(input)
        end
    end)
    
    if UserInputService.TouchEnabled then
        RunService.Heartbeat:Connect(function()
            if dragging and UserInputService:IsMouseButtonPressed(Enum.UserInputType.Touch) then
                local touchPos = UserInputService:GetMouseLocation()
                local delta = touchPos - dragStart
                frame.Position = UDim2.new(
                    startPos.X.Scale, 
                    startPos.X.Offset + delta.X,
                    startPos.Y.Scale, 
                    startPos.Y.Offset + delta.Y
                )
            end
        end)
    end
end

--==================================================--
-- PASTEBIN API FUNCTIONS
--==================================================--
local function urlEncode(str)
    if str then
        str = string.gsub(str, "\n", "\r\n")
        str = string.gsub(str, "([^%w %-%_%.%~])",
            function(c) return string.format("%%%02X", string.byte(c)) end)
        str = string.gsub(str, " ", "+")
    end
    return str
end

local function makePastebinRequest(params)
    local postData = ""
    
    for key, value in pairs(params) do
        if postData ~= "" then
            postData = postData .. "&"
        end
        postData = postData .. key .. "=" .. urlEncode(tostring(value))
    end
    
    local success, result = pcall(function()
        return game:HttpPost(PASTEBIN_API_URL, postData, Enum.HttpContentType.ApplicationUrlEncoded)
    end)
    
    return success, result
end

local function createNewPaste(content, pasteName)
    local params = {
        api_dev_key = PASTEBIN_API_KEY,
        api_option = "paste",
        api_paste_code = content,
        api_paste_name = pasteName or DATABASE_NAME,
        api_paste_format = "json",
        api_paste_private = 1,
        api_paste_expire_date = DATABASE_EXPIRE
    }
    
    local success, response = makePastebinRequest(params)
    
    if success and response and not response:find("Bad API request") then
        local pasteKey = response:match("pastebin%.com/([%w]+)$")
        if pasteKey then
            return pasteKey, response
        end
    end
    
    return nil, response or "Unknown error"
end

local function updatePaste(pasteKey, content)
    local params = {
        api_dev_key = PASTEBIN_API_KEY,
        api_option = "paste",
        api_paste_code = content,
        api_paste_name = DATABASE_NAME,
        api_paste_format = "json",
        api_paste_private = 1,
        api_paste_expire_date = DATABASE_EXPIRE,
        api_paste_key = pasteKey
    }
    
    local success, response = makePastebinRequest(params)
    
    if success and response and not response:find("Bad API request") then
        return true, response
    end
    
    return false, response or "Update failed"
end

local function deletePaste(pasteKey)
    local params = {
        api_dev_key = PASTEBIN_API_KEY,
        api_option = "delete",
        api_paste_key = pasteKey
    }
    
    local success, response = makePastebinRequest(params)
    
    if success and response == "Paste Removed" then
        return true
    end
    
    return false, response or "Delete failed"
end

local function getPasteRaw(pasteKey)
    local url = PASTEBIN_RAW_URL .. pasteKey
    local success, response = pcall(function()
        return game:HttpGet(url)
    end)
    
    if success and response then
        return response
    end
    
    return nil
end

--==================================================--
-- DATABASE MANAGEMENT
--==================================================--
local function getDataFolder()
    if writefile and isfolder then
        if not isfolder(LOCAL_FOLDER) then
            makefolder(LOCAL_FOLDER)
        end
        return LOCAL_FOLDER
    end
    return nil
end

local function loadPasteKey()
    local folder = getDataFolder()
    if not folder then return nil end
    
    local filePath = folder .. "/" .. PASTE_KEY_FILE
    
    if isfile(filePath) then
        local key = readfile(filePath)
        if key and key ~= "" then
            DATABASE_PASTE_KEY = key
            return key
        end
    end
    
    return nil
end

local function savePasteKey(pasteKey)
    local folder = getDataFolder()
    if not folder then return end
    
    DATABASE_PASTE_KEY = pasteKey
    
    local filePath = folder .. "/" .. PASTE_KEY_FILE
    writefile(filePath, pasteKey)
    
    print("[PASTEBIN] Saved paste key:", pasteKey)
end

local function saveKeyStatus()
    local folder = getDataFolder()
    if not folder then return end
    
    local status = {
        key = CurrentKey,
        active = KeyActive,
        userId = USER_ID,
        timestamp = os.time()
    }
    
    local success, err = pcall(function()
        writefile(folder .. "/" .. KEY_STATUS_FILE, HttpService:JSONEncode(status))
    end)
    
    if not success then
        warn("[RSQ] Failed to save key status:", err)
    end
end

local function loadKeyStatus()
    local folder = getDataFolder()
    if not folder then return false end
    
    local filePath = folder .. "/" .. KEY_STATUS_FILE
    
    if not isfile(filePath) then
        return false
    end
    
    local success, data = pcall(function()
        local content = readfile(filePath)
        return HttpService:JSONDecode(content)
    end)
    
    if success and data and data.userId == USER_ID then
        if data.active and data.key then
            CurrentKey = data.key
            KeyActive = true
            return true
        end
    end
    
    return false
end

local function clearKeyStatus()
    local folder = getDataFolder()
    if not folder then return end
    
    local filePath = folder .. "/" .. KEY_STATUS_FILE
    
    if isfile(filePath) then
        delfile(filePath)
    end
end

local function initializeDatabase()
    print("[PASTEBIN] Initializing database...")
    
    local savedKey = loadPasteKey()
    
    if savedKey then
        print("[PASTEBIN] Found saved paste key:", savedKey)
        
        local content = getPasteRaw(savedKey)
        if content then
            DATABASE_PASTE_KEY = savedKey
            print("[PASTEBIN] Database loaded successfully")
            return true
        else
            print("[PASTEBIN] Saved paste no longer exists, creating new...")
        end
    end
    
    print("[PASTEBIN] Creating new database...")
    
    local initialData = {
        keys = {},
        games = {
            {
                id = "687789545",
                name = "CASHGRAB EXPERIENCE",
                scripts = {
                    {
                        name = "Main Script",
                        url = "https://raw.githubusercontent.com/RealScripts-q/KEY-JSONHandler/main/main.lua"
                    }
                }
            }
        },
        bans = {},
        notifications = {},
        admins = {
            [USER_ID] = {
                name = USER_NAME,
                added = os.time(),
                level = 3
            }
        },
        settings = {
            version = "2.0",
            created = os.time(),
            last_updated = os.time()
        }
    }
    
    local jsonData = HttpService:JSONEncode(initialData)
    local pasteKey, response = createNewPaste(jsonData, DATABASE_NAME)
    
    if pasteKey then
        savePasteKey(pasteKey)
        print("[PASTEBIN] Database created with key:", pasteKey)
        print("[PASTEBIN] URL: https://pastebin.com/" .. pasteKey)
        return true
    else
        print("[PASTEBIN] Failed to create database:", response)
        return false
    end
end

local function fetchDataFromDatabase()
    if not DATABASE_PASTE_KEY or DATABASE_PASTE_KEY == "" then
        if not initializeDatabase() then
            return nil
        end
    end
    
    local content = getPasteRaw(DATABASE_PASTE_KEY)
    if not content then
        if initializeDatabase() then
            content = getPasteRaw(DATABASE_PASTE_KEY)
        end
    end
    
    if content then
        local success, data = pcall(function()
            return HttpService:JSONDecode(content)
        end)
        
        if success and data then
            CachedData = data
            
            GamesList = {}
            if data.games and type(data.games) == "table" then
                for _, game in pairs(data.games) do
                    if type(game) == "table" and game.id and game.name then
                        table.insert(GamesList, game)
                    end
                end
            end
            
            IsAdmin = (data.admins and data.admins[USER_ID] ~= nil)
            if data.admins then
                AdminUsers = {}
                for userId, _ in pairs(data.admins) do
                    table.insert(AdminUsers, userId)
                end
            end
            
            return data
        else
            print("[PASTEBIN] Failed to parse JSON data")
        end
    end
    
    return nil
end

local function saveDataToDatabase(data)
    if not DATABASE_PASTE_KEY or DATABASE_PASTE_KEY == "" then
        return false
    end
    
    if not data then
        return false
    end
    
    if not data.settings then
        data.settings = {}
    end
    data.settings.last_updated = os.time()
    
    local jsonData = HttpService:JSONEncode(data)
    local success, response = updatePaste(DATABASE_PASTE_KEY, jsonData)
    
    if success then
        print("[PASTEBIN] Database updated successfully")
        CachedData = data
        return true
    else
        print("[PASTEBIN] Failed to update database:", response)
        return false
    end
end

--==================================================--
-- DATABASE OPERATIONS
--==================================================--
local function addKeyToDatabase(keyValue, userId, expireTime, addedBy)
    local data = fetchDataFromDatabase()
    if not data then return false end
    
    if not data.keys then
        data.keys = {}
    end
    
    data.keys[keyValue] = {
        rbx = userId,
        exp = expireTime or "INF",
        created = os.time(),
        added_by = addedBy or "system"
    }
    
    if not data.notifications then
        data.notifications = {}
    end
    data.notifications[userId] = {
        type = "KEY_ADDED",
        time = os.time(),
        message = "New key added by " .. (addedBy or "system")
    }
    
    return saveDataToDatabase(data)
end

local function deleteKeyFromDatabase(keyValue, deletedBy)
    local data = fetchDataFromDatabase()
    if not data then return false end
    
    if data.keys and data.keys[keyValue] then
        local userId = data.keys[keyValue].rbx
        data.keys[keyValue] = nil
        
        if not data.notifications then
            data.notifications = {}
        end
        data.notifications[userId] = {
            type = "KEY_DELETED",
            time = os.time(),
            message = "Key deleted by " .. (deletedBy or "system")
        }
        
        return saveDataToDatabase(data)
    end
    
    return false
end

local function banUserInDatabase(userId, reason, bannedBy)
    local data = fetchDataFromDatabase()
    if not data then return false end
    
    if not data.bans then
        data.bans = {}
    end
    
    data.bans[userId] = {
        reason = reason or "Violation of terms",
        banned_by = bannedBy or "system",
        time = os.time()
    }
    
    return saveDataToDatabase(data)
end

local function unbanUserInDatabase(userId)
    local data = fetchDataFromDatabase()
    if not data then return false end
    
    if data.bans and data.bans[userId] then
        data.bans[userId] = nil
        return saveDataToDatabase(data)
    end
    
    return false
end

--==================================================--
-- VALIDATION LOGIC
--==================================================--
local function validate(keyToVerify, skipFetch)
    local data = skipFetch and CachedData or fetchDataFromDatabase()
    if not data then return false, "Database Error" end

    if data.bans and (data.bans[USER_NAME] or data.bans[USER_ID]) then
        local banInfo = data.bans[USER_NAME] or data.bans[USER_ID]
        kickBanned(banInfo.reason)
        return false, "Banned"
    end

    if data.notifications and data.notifications[USER_NAME] then
        local n = data.notifications[USER_NAME]
        if n.time > LastNotifTime then
            LastNotifTime = n.time
            if n.type == "DELETED" then createNotify("‚ö†Ô∏è Admin has revoked your key!", Color3.fromRGB(255, 50, 50))
            elseif n.type == "KEY_ADDED" then createNotify("‚úÖ New key added for you!", Color3.fromRGB(50, 255, 50))
            end
        end
    end

    if not keyToVerify then return false, "" end

    local entry = data.keys and data.keys[keyToVerify]
    if not entry then return false, "‚ùå Invalid Key" end
    if tostring(entry.rbx) ~= USER_ID then return false, "‚ùå ID Mismatch" end
    if entry.exp ~= "INF" and os.time() > tonumber(entry.exp) then return false, "‚ùå Expired" end

    return true, entry
end

--==================================================--
-- GAME ID CHECK FUNCTION
--==================================================--
local function showGameIdCheckConfirmation(scriptData, gameData)
    local currentGameId = tostring(game.PlaceId)
    local requiredGameId = tostring(gameData.id)
    
    if currentGameId == requiredGameId then
        return true
    end
    
    local confirmGui = Instance.new("ScreenGui", CoreGui)
    confirmGui.Name = "RSQ_GameIdConfirm"
    confirmGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    local overlay = Instance.new("Frame", confirmGui)
    overlay.Size = UDim2.new(1, 0, 1, 0)
    overlay.BackgroundColor3 = Color3.new(0, 0, 0)
    overlay.BackgroundTransparency = 0.7
    overlay.BorderSizePixel = 0
    
    local confirmFrame = Instance.new("Frame", confirmGui)
    confirmFrame.Size = UDim2.new(0, 350, 0, 220)
    confirmFrame.Position = UDim2.new(0.5, -175, 0.5, -110)
    confirmFrame.BackgroundColor3 = Color3.fromRGB(20, 25, 40)
    confirmFrame.BorderSizePixel = 0
    Instance.new("UICorner", confirmFrame).CornerRadius = UDim.new(0, 12)
    
    makeDraggable(confirmFrame, confirmFrame)
    
    local titleBar = Instance.new("Frame", confirmFrame)
    titleBar.Size = UDim2.new(1, 0, 0, 30)
    titleBar.BackgroundColor3 = Color3.fromRGB(30, 35, 50)
    titleBar.BackgroundTransparency = 0.3
    titleBar.BorderSizePixel = 0
    Instance.new("UICorner", titleBar).CornerRadius = UDim.new(0, 12, 0, 0)
    
    local title = Instance.new("TextLabel", titleBar)
    title.Size = UDim2.new(1, -40, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.Text = "‚ö†Ô∏è Wrong Game ID Detected"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 14
    title.TextColor3 = Color3.fromRGB(255, 140, 0)
    title.BackgroundTransparency = 1
    title.TextXAlignment = Enum.TextXAlignment.Left
    
    local closeBtn = Instance.new("TextButton", titleBar)
    closeBtn.Size = UDim2.new(0, 25, 0, 25)
    closeBtn.Position = UDim2.new(1, -30, 0.5, -12.5)
    closeBtn.Text = "‚úï"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 14
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.BackgroundColor3 = Color3.fromRGB(255, 59, 48)
    closeBtn.BorderSizePixel = 0
    Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 6)
    
    closeBtn.MouseButton1Click:Connect(function()
        confirmGui:Destroy()
    end)
    
    local message = Instance.new("TextLabel", confirmFrame)
    message.Size = UDim2.new(1, -20, 0, 80)
    message.Position = UDim2.new(0, 10, 0, 40)
    message.Text = "Script '" .. scriptData.name .. "' requires Game ID: " .. requiredGameId .. "\n\nCurrent Game ID: " .. currentGameId .. "\n\nDo you want to teleport to the correct game or use it in current game?"
    message.Font = Enum.Font.Gotham
    message.TextSize = 14
    message.TextColor3 = Color3.new(1, 1, 1)
    message.BackgroundTransparency = 1
    message.TextWrapped = true
    message.TextXAlignment = Enum.TextXAlignment.Left
    
    local teleportBtn = Instance.new("TextButton", confirmFrame)
    teleportBtn.Size = UDim2.new(0, 140, 0, 40)
    teleportBtn.Position = UDim2.new(0.5, -150, 1, -70)
    teleportBtn.Text = "üöÄ Teleport"
    teleportBtn.Font = Enum.Font.GothamBold
    teleportBtn.TextSize = 14
    teleportBtn.TextColor3 = Color3.new(1, 1, 1)
    teleportBtn.BackgroundColor3 = Color3.fromRGB(79, 124, 255)
    teleportBtn.BorderSizePixel = 0
    Instance.new("UICorner", teleportBtn).CornerRadius = UDim.new(0, 8)
    
    local useCurrentBtn = Instance.new("TextButton", confirmFrame)
    useCurrentBtn.Size = UDim2.new(0, 140, 0, 40)
    useCurrentBtn.Position = UDim2.new(0.5, 10, 1, -70)
    useCurrentBtn.Text = "üéÆ Use Here"
    useCurrentBtn.Font = Enum.Font.GothamBold
    useCurrentBtn.TextSize = 14
    useCurrentBtn.TextColor3 = Color3.new(1, 1, 1)
    useCurrentBtn.BackgroundColor3 = Color3.fromRGB(40, 200, 80)
    useCurrentBtn.BorderSizePixel = 0
    Instance.new("UICorner", useCurrentBtn).CornerRadius = UDim.new(0, 8)
    
    local cancelBtn = Instance.new("TextButton", confirmFrame)
    cancelBtn.Size = UDim2.new(0, 100, 0, 30)
    cancelBtn.Position = UDim2.new(0.5, -50, 1, -120)
    cancelBtn.Text = "‚ùå Cancel"
    cancelBtn.Font = Enum.Font.GothamBold
    cancelBtn.TextSize = 12
    cancelBtn.TextColor3 = Color3.new(1, 1, 1)
    cancelBtn.BackgroundColor3 = Color3.fromRGB(255, 59, 48)
    cancelBtn.BorderSizePixel = 0
    Instance.new("UICorner", cancelBtn).CornerRadius = UDim.new(0, 6)
    
    local userChoice = nil
    
    teleportBtn.MouseButton1Click:Connect(function()
        userChoice = "teleport"
        createNotify("Teleporting to Game ID: " .. requiredGameId, Color3.fromRGB(79, 124, 255))
        confirmGui:Destroy()
        
        local gameIdNumber = tonumber(requiredGameId)
        if gameIdNumber then
            local success, err = pcall(function()
                TeleportService:Teleport(gameIdNumber, player)
            end)
            
            if not success then
                createNotify("‚ùå Teleport failed: " .. tostring(err), Color3.fromRGB(255, 50, 50))
            end
        else
            createNotify("‚ùå Invalid Game ID format", Color3.fromRGB(255, 50, 50))
        end
    end)
    
    useCurrentBtn.MouseButton1Click:Connect(function()
        userChoice = "use_current"
        createNotify("Using script in current game (ID: " .. currentGameId .. ")", Color3.fromRGB(40, 200, 80))
        confirmGui:Destroy()
        return true
    end)
    
    cancelBtn.MouseButton1Click:Connect(function()
        userChoice = "cancel"
        createNotify("Script execution cancelled", Color3.fromRGB(255, 59, 48))
        confirmGui:Destroy()
    end)
    
    confirmFrame.BackgroundTransparency = 1
    TweenService:Create(confirmFrame, TweenInfo.new(0.3), {BackgroundTransparency = 0}):Play()
    
    while confirmGui.Parent do
        task.wait()
    end
    
    return userChoice == "use_current"
end

local function validateScriptExecution(scriptData, gameData)
    local currentGameId = tostring(game.PlaceId)
    local requiredGameId = tostring(gameData.id)
    
    if currentGameId == requiredGameId then
        return true
    else
        local proceed = showGameIdCheckConfirmation(scriptData, gameData)
        return proceed
    end
end

--==================================================--
-- GROUP CHECK FUNCTIONS
--==================================================--
local function checkGroupMembership()
    local success, result = pcall(function()
        local inGroup = false
        
        local success1, groups = pcall(function()
            return GroupService:GetGroupsAsync(USER_ID)
        end)
        
        if success1 and groups then
            for _, groupInfo in ipairs(groups) do
                if groupInfo.Id == REQUIRED_GROUP_ID then
                    inGroup = true
                    break
                end
            end
        end
        
        if not inGroup then
            local success2 = pcall(function()
                local isInGroup = GroupService:UserInGroup(USER_ID, REQUIRED_GROUP_ID)
                return isInGroup
            end)
            
            if success2 then
                inGroup = success2
            end
        end
        
        return inGroup
    end)
    
    if success then
        IsInRequiredGroup = result
        return result
    end
    
    return false
end

local function createGroupRequirementNotification()
    local groupNotification = Instance.new("ScreenGui", CoreGui)
    groupNotification.Name = "RSQ_GroupRequirement"
    groupNotification.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    local notificationFrame = Instance.new("Frame", groupNotification)
    notificationFrame.Size = UDim2.new(0, 400, 0, 250)
    notificationFrame.Position = UDim2.new(0.5, -200, 0.5, -125)
    notificationFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    notificationFrame.BackgroundTransparency = 0.1
    notificationFrame.BorderSizePixel = 0
    Instance.new("UICorner", notificationFrame).CornerRadius = UDim.new(0, 12)
    
    makeDraggable(notificationFrame, notificationFrame)
    
    local glassFrame = Instance.new("Frame", notificationFrame)
    glassFrame.Size = UDim2.new(1, 0, 1, 0)
    glassFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    glassFrame.BackgroundTransparency = 0.95
    glassFrame.BorderSizePixel = 0
    Instance.new("UICorner", glassFrame).CornerRadius = UDim.new(0, 12)

    local titleBar = Instance.new("Frame", notificationFrame)
    titleBar.Size = UDim2.new(1, 0, 0, 40)
    titleBar.BackgroundColor3 = Color3.fromRGB(255, 59, 48)
    titleBar.BorderSizePixel = 0
    Instance.new("UICorner", titleBar).CornerRadius = UDim.new(0, 12, 0, 0)
    
    local title = Instance.new("TextLabel", titleBar)
    title.Size = UDim2.new(1, -20, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.Text = "üö´ ACCESS DENIED"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 16
    title.TextColor3 = Color3.new(1, 1, 1)
    title.BackgroundTransparency = 1
    title.TextXAlignment = Enum.TextXAlignment.Left
    
    local messageFrame = Instance.new("Frame", notificationFrame)
    messageFrame.Size = UDim2.new(1, -20, 1, -120)
    messageFrame.Position = UDim2.new(0, 10, 0, 50)
    messageFrame.BackgroundTransparency = 1
    
    local warningIcon = Instance.new("TextLabel", messageFrame)
    warningIcon.Size = UDim2.new(0, 40, 0, 40)
    warningIcon.Position = UDim2.new(0, 10, 0, 10)
    warningIcon.Text = "‚ö†Ô∏è"
    warningIcon.Font = Enum.Font.GothamBold
    warningIcon.TextSize = 24
    warningIcon.TextColor3 = Color3.fromRGB(255, 59, 48)
    warningIcon.BackgroundTransparency = 1
    
    local messageText = Instance.new("TextLabel", messageFrame)
    messageText.Size = UDim2.new(1, -60, 0, 80)
    messageText.Position = UDim2.new(0, 60, 0, 10)
    messageText.Text = "ùôîùôäùôê ùôàùôêùôéùôè ùôÖùôäùôÑùôâ ùôèùôÉùôÄ ùôÇùôçùôäùôêùôã ùòΩùôÄùôÅùôäùôçùôÄ ùòºùòæùòæùôÄùôéùôéùôÑùôâùôÇ ùôèùôÉùôÄ ùôêùôÑ!\n\nùôâùô§ ùôõùôßùôñùô¢ùôöùô® ùô¨ùôûùô°ùô° ùô®ùôùùô§ùô¨ ùô™ùô£ùô©ùôûùôá ùôÆùô§ùô™ ùôüùô§ùôûùô£ ùô©ùôùùôö ùôúùôßùô§ùô™ùô•."
    messageText.Font = Enum.Font.GothamBold
    messageText.TextSize = 14
    messageText.TextColor3 = Color3.new(1, 1, 1)
    messageText.BackgroundTransparency = 1
    messageText.TextWrapped = true
    messageText.TextXAlignment = Enum.TextXAlignment.Left
    
    local groupInfo = Instance.new("TextLabel", messageFrame)
    groupInfo.Size = UDim2.new(1, -20, 0, 40)
    groupInfo.Position = UDim2.new(0, 10, 0, 100)
    groupInfo.Text = "üìã Group ID: 687789545\nüè∑Ô∏è Group Name: CASHGRAB-EXPERIENCE"
    groupInfo.Font = Enum.Font.Gotham
    groupInfo.TextSize = 12
    groupInfo.TextColor3 = Color3.fromRGB(200, 200, 200)
    groupInfo.BackgroundTransparency = 1
    groupInfo.TextWrapped = true
    groupInfo.TextXAlignment = Enum.TextXAlignment.Left
    
    local groupBtn = Instance.new("TextButton", notificationFrame)
    groupBtn.Size = UDim2.new(0, 180, 0, 40)
    groupBtn.Position = UDim2.new(0.5, -190, 1, -65)
    groupBtn.Text = "üìã Copy Group Link"
    groupBtn.Font = Enum.Font.GothamBold
    groupBtn.TextSize = 13
    groupBtn.TextColor3 = Color3.new(1, 1, 1)
    groupBtn.BackgroundColor3 = Color3.fromRGB(79, 124, 255)
    groupBtn.BorderSizePixel = 0
    Instance.new("UICorner", groupBtn).CornerRadius = UDim.new(0, 8)
    
    groupBtn.MouseButton1Click:Connect(function()
        setclipboard(GROUP_JOIN_URL)
        createNotify("‚úÖ Group link copied to clipboard!", Color3.fromRGB(79, 124, 255))
    end)
    
    local merchBtn = Instance.new("TextButton", notificationFrame)
    merchBtn.Size = UDim2.new(0, 180, 0, 40)
    merchBtn.Position = UDim2.new(0.5, 10, 1, -65)
    merchBtn.Text = "üõí Buy My Merch"
    merchBtn.Font = Enum.Font.GothamBold
    merchBtn.TextSize = 13
    merchBtn.TextColor3 = Color3.new(1, 1, 1)
    merchBtn.BackgroundColor3 = Color3.fromRGB(255, 140, 0)
    merchBtn.BorderSizePixel = 0
    Instance.new("UICorner", merchBtn).CornerRadius = UDim.new(0, 8)
    
    local refreshBtn = Instance.new("TextButton", notificationFrame)
    refreshBtn.Size = UDim2.new(0, 120, 0, 30)
    refreshBtn.Position = UDim2.new(0.5, -60, 1, -115)
    refreshBtn.Text = "üîÑ Check Membership"
    refreshBtn.Font = Enum.Font.GothamBold
    refreshBtn.TextSize = 12
    refreshBtn.TextColor3 = Color3.new(1, 1, 1)
    refreshBtn.BackgroundColor3 = Color3.fromRGB(40, 200, 80)
    refreshBtn.BorderSizePixel = 0
    Instance.new("UICorner", refreshBtn).CornerRadius = UDim.new(0, 6)
    
    refreshBtn.MouseButton1Click:Connect(function()
        createNotify("Checking group membership...", Color3.fromRGB(79, 124, 255))
        local isInGroup = checkGroupMembership()
        if isInGroup then
            createNotify("‚úÖ You're in the group! GUI will now show.", Color3.fromRGB(40, 200, 80))
            groupNotification:Destroy()
            
            local hasSavedKey = loadKeyStatus()
            if hasSavedKey then
                local ok, res = validate(CurrentKey, false)
                if ok then
                    showAdvancedGamesGUI()
                else
                    showKeyGUI()
                end
            else
                showKeyGUI()
            end
        else
            createNotify("‚ùå Still not in the group. Please join first!", Color3.fromRGB(255, 59, 48))
        end
    end)
    
    notificationFrame.BackgroundTransparency = 1
    TweenService:Create(notificationFrame, TweenInfo.new(0.3), {BackgroundTransparency = 0.1}):Play()
    
    return groupNotification
end

local function createMerchReminder()
    local reminderGui = Instance.new("ScreenGui", CoreGui)
    reminderGui.Name = "RSQ_MerchReminder"
    reminderGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    local frame = Instance.new("Frame", reminderGui)
    frame.Size = UDim2.new(0, 300, 0, 100)
    frame.Position = UDim2.new(1, 10, 0.8, 0)
    frame.BackgroundColor3 = Color3.fromRGB(30, 35, 50)
    frame.BorderSizePixel = 0
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)
    
    local accent = Instance.new("Frame", frame)
    accent.Size = UDim2.new(0, 5, 1, 0)
    accent.BackgroundColor3 = Color3.fromRGB(255, 140, 0)
    accent.BorderSizePixel = 0
    Instance.new("UICorner", accent).CornerRadius = UDim.new(0, 2)

    local icon = Instance.new("TextLabel", frame)
    icon.Size = UDim2.new(0, 30, 0, 30)
    icon.Position = UDim2.new(0, 15, 0, 15)
    icon.Text = "üõçÔ∏è"
    icon.Font = Enum.Font.GothamBold
    icon.TextSize = 18
    icon.TextColor3 = Color3.fromRGB(255, 140, 0)
    icon.BackgroundTransparency = 1

    local label = Instance.new("TextLabel", frame)
    label.Size = UDim2.new(1, -60, 0, 40)
    label.Position = UDim2.new(0, 50, 0, 10)
    label.Text = "Support the developer!"
    label.Font = Enum.Font.GothamBold
    label.TextSize = 13
    label.TextColor3 = Color3.new(1, 1, 1)
    label.BackgroundTransparency = 1
    label.TextXAlignment = Enum.TextXAlignment.Left

    local subLabel = Instance.new("TextLabel", frame)
    subLabel.Size = UDim2.new(1, -20, 0, 30)
    subLabel.Position = UDim2.new(0, 10, 0, 50)
    subLabel.Text = "Buy merch & join the group"
    subLabel.Font = Enum.Font.Gotham
    subLabel.TextSize = 11
    subLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    subLabel.BackgroundTransparency = 1
    subLabel.TextXAlignment = Enum.TextXAlignment.Left

    frame:TweenPosition(UDim2.new(1, -310, 0.8, 0), "Out", "Back", 0.5)
    task.delay(8, function()
        pcall(function()
            frame:TweenPosition(UDim2.new(1, 10, 0.8, 0), "In", "Sine", 0.5)
            task.wait(0.5)
            reminderGui:Destroy()
        end)
    end)
    
    return reminderGui
end

--==================================================--
-- ADVANCED GAMES GUI
--==================================================--
local function showAdvancedGamesGUI()
    if not IsInRequiredGroup then
        createNotify("‚ùå You must join the group first!", Color3.fromRGB(255, 59, 48))
        createGroupRequirementNotification()
        return
    end
    
    if isGUILoaded() then
        createNotify("‚ö†Ô∏è GUI is already open!", Color3.fromRGB(255, 140, 0))
        return
    end
    
    if CurrentGUI and CurrentGUI.Parent then
        CurrentGUI:Destroy()
        CurrentGUI = nil
    end
    
    IsGuiOpen = true
    HasShownGUIAlready = true
    
    fetchDataFromDatabase()
    
    local gui = Instance.new("ScreenGui")
    gui.Name = "RSQ_AdvancedGamesGUI"
    gui.IgnoreGuiInset = true
    gui.ResetOnSpawn = false
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    gui.Parent = CoreGui
    CurrentGUI = gui

    local mainFrame = Instance.new("Frame", gui)
    mainFrame.Size = UDim2.new(0, 450, 0, 400)
    mainFrame.Position = UDim2.new(0.5, -225, 0.5, -200)
    mainFrame.BackgroundColor3 = Color3.fromRGB(15, 20, 30)
    mainFrame.BackgroundTransparency = 0.1
    mainFrame.BorderSizePixel = 0
    
    local mainCorner = Instance.new("UICorner", mainFrame)
    mainCorner.CornerRadius = UDim.new(0, 12)
    
    makeDraggable(mainFrame, mainFrame)
    
    local glassFrame = Instance.new("Frame", mainFrame)
    glassFrame.Size = UDim2.new(1, 0, 1, 0)
    glassFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    glassFrame.BackgroundTransparency = 0.95
    glassFrame.BorderSizePixel = 0
    Instance.new("UICorner", glassFrame).CornerRadius = UDim.new(0, 12)

    local titleBar = Instance.new("Frame", mainFrame)
    titleBar.Size = UDim2.new(1, 0, 0, 40)
    titleBar.BackgroundColor3 = Color3.fromRGB(20, 25, 40)
    titleBar.BorderSizePixel = 0
    
    local titleCorner = Instance.new("UICorner", titleBar)
    titleCorner.CornerRadius = UDim.new(0, 12, 0, 0)
    
    local title = Instance.new("TextLabel", titleBar)
    title.Size = UDim2.new(1, -60, 1, 0)
    title.Position = UDim2.new(0, 15, 0, 0)
    title.Text = "üéÆ RSQ GAMES LIBRARY"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 14
    title.TextColor3 = Color3.fromRGB(79, 124, 255)
    title.BackgroundTransparency = 1
    title.TextXAlignment = Enum.TextXAlignment.Left
    
    local closeBtn = Instance.new("TextButton", titleBar)
    closeBtn.Size = UDim2.new(0, 25, 0, 25)
    closeBtn.Position = UDim2.new(1, -30, 0.5, -12.5)
    closeBtn.Text = "‚úï"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 14
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.BackgroundColor3 = Color3.fromRGB(255, 59, 48)
    closeBtn.BorderSizePixel = 0
    Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 6)
    
    closeBtn.MouseButton1Click:Connect(function()
        IsGuiOpen = false
        gui:Destroy()
        CurrentGUI = nil
    end)

    local contentFrame = Instance.new("Frame", mainFrame)
    contentFrame.Size = UDim2.new(1, -20, 1, -60)
    contentFrame.Position = UDim2.new(0, 10, 0, 50)
    contentFrame.BackgroundTransparency = 1
    contentFrame.ClipsDescendants = true

    local scrollFrame = Instance.new("ScrollingFrame", contentFrame)
    scrollFrame.Size = UDim2.new(1, 0, 1, 0)
    scrollFrame.BackgroundTransparency = 1
    scrollFrame.ScrollBarThickness = 4
    scrollFrame.ScrollBarImageColor3 = Color3.fromRGB(79, 124, 255)
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    scrollFrame.Visible = true

    local gamesListLayout = Instance.new("UIListLayout", scrollFrame)
    gamesListLayout.Padding = UDim.new(0, 8)
    gamesListLayout.SortOrder = Enum.SortOrder.LayoutOrder

    local currentGameData = nil
    local currentScriptsFrame = nil

    local function executeScriptWithGameIdCheck(scriptData, gameData)
        local canExecute = validateScriptExecution(scriptData, gameData)
        
        if canExecute then
            createNotify("‚ö° Loading script: " .. scriptData.name, Color3.fromRGB(79, 124, 255))
            
            local success, err = pcall(function()
                local scriptContent = game:HttpGet(scriptData.url)
                loadstring(scriptContent)()
            end)
            
            if success then
                createNotify("‚úÖ Script loaded successfully!", Color3.fromRGB(40, 200, 80))
            else
                createNotify("‚ùå Failed to load script: " .. tostring(err), Color3.fromRGB(255, 59, 48))
            end
        else
            createNotify("Script execution cancelled", Color3.fromRGB(200, 200, 200))
        end
    end
    
    local function showGameScripts(gameData)
        currentGameData = gameData
        
        scrollFrame.Visible = false
        
        if currentScriptsFrame then
            currentScriptsFrame:Destroy()
            currentScriptsFrame = nil
        end
        
        currentScriptsFrame = Instance.new("ScrollingFrame", contentFrame)
        currentScriptsFrame.Name = "RSQ_ScriptsScroll"
        currentScriptsFrame.Size = UDim2.new(1, 0, 1, 0)
        currentScriptsFrame.Position = UDim2.new(0, 0, 0, 0)
        currentScriptsFrame.BackgroundTransparency = 1
        currentScriptsFrame.ScrollBarThickness = 4
        currentScriptsFrame.ScrollBarImageColor3 = Color3.fromRGB(79, 124, 255)
        currentScriptsFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
        currentScriptsFrame.Visible = true
        
        local scriptsLayout = Instance.new("UIListLayout", currentScriptsFrame)
        scriptsLayout.Padding = UDim.new(0, 8)
        scriptsLayout.SortOrder = Enum.SortOrder.LayoutOrder
        
        title.Text = "üìú Scripts - " .. gameData.name
        
        local scripts = gameData.scripts or {}
        
        if #scripts == 0 then
            local emptyLabel = Instance.new("TextLabel", currentScriptsFrame)
            emptyLabel.Size = UDim2.new(1, 0, 0, 80)
            emptyLabel.Text = "üì≠ No scripts available for this game."
            emptyLabel.Font = Enum.Font.Gotham
            emptyLabel.TextSize = 13
            emptyLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
            emptyLabel.BackgroundTransparency = 1
            emptyLabel.TextWrapped = true
            emptyLabel.LayoutOrder = 1
        else
            for index, scriptData in ipairs(scripts) do
                if scriptData and scriptData.name and scriptData.url then
                    local scriptCard = Instance.new("Frame", currentScriptsFrame)
                    scriptCard.Size = UDim2.new(1, 0, 0, 70)
                    scriptCard.BackgroundColor3 = Color3.fromRGB(30, 35, 50)
                    scriptCard.BackgroundTransparency = 0.3
                    scriptCard.BorderSizePixel = 0
                    Instance.new("UICorner", scriptCard).CornerRadius = UDim.new(0, 8)
                    scriptCard.LayoutOrder = index
                    
                    local scriptInfo = Instance.new("Frame", scriptCard)
                    scriptInfo.Size = UDim2.new(0.7, 0, 1, 0)
                    scriptInfo.Position = UDim2.new(0, 10, 0, 0)
                    scriptInfo.BackgroundTransparency = 1
                    
                    local scriptName = Instance.new("TextLabel", scriptInfo)
                    scriptName.Size = UDim2.new(1, -10, 0, 25)
                    scriptName.Position = UDim2.new(0, 0, 0, 5)
                    scriptName.Text = scriptData.name
                    scriptName.Font = Enum.Font.GothamBold
                    scriptName.TextSize = 13
                    scriptName.TextColor3 = Color3.new(1, 1, 1)
                    scriptName.TextXAlignment = Enum.TextXAlignment.Left
                    scriptName.BackgroundTransparency = 1
                    
                    local urlPreview = Instance.new("TextLabel", scriptInfo)
                    urlPreview.Size = UDim2.new(1, -10, 0, 20)
                    urlPreview.Position = UDim2.new(0, 0, 0, 30)
                    urlPreview.Text = "üìé " .. string.sub(scriptData.url, 1, 25) .. "..."
                    urlPreview.Font = Enum.Font.Gotham
                    urlPreview.TextSize = 11
                    urlPreview.TextColor3 = Color3.fromRGB(150, 150, 150)
                    urlPreview.TextXAlignment = Enum.TextXAlignment.Left
                    urlPreview.BackgroundTransparency = 1
                    
                    local gameIdIndicator = Instance.new("TextLabel", scriptInfo)
                    gameIdIndicator.Size = UDim2.new(1, -10, 0, 15)
                    gameIdIndicator.Position = UDim2.new(0, 0, 0, 50)
                    gameIdIndicator.Text = "üéÆ Game ID: " .. gameData.id
                    gameIdIndicator.Font = Enum.Font.Gotham
                    gameIdIndicator.TextSize = 10
                    gameIdIndicator.TextColor3 = Color3.fromRGB(79, 124, 255)
                    gameIdIndicator.TextXAlignment = Enum.TextXAlignment.Left
                    gameIdIndicator.BackgroundTransparency = 1
                    
                    local executeBtn = Instance.new("TextButton", scriptCard)
                    executeBtn.Size = UDim2.new(0, 80, 0, 25)
                    executeBtn.Position = UDim2.new(1, -85, 0.5, -12.5)
                    executeBtn.Text = "‚ö° Execute"
                    executeBtn.Font = Enum.Font.GothamBold
                    executeBtn.TextSize = 11
                    executeBtn.TextColor3 = Color3.new(1, 1, 1)
                    executeBtn.BackgroundColor3 = Color3.fromRGB(40, 200, 80)
                    executeBtn.BackgroundTransparency = 0.2
                    executeBtn.BorderSizePixel = 0
                    Instance.new("UICorner", executeBtn).CornerRadius = UDim.new(0, 6)
                    
                    do
                        local capturedScriptData = scriptData
                        local capturedGameData = gameData
                        
                        executeBtn.MouseButton1Click:Connect(function()
                            executeScriptWithGameIdCheck(capturedScriptData, capturedGameData)
                        end)
                    end
                end
            end
        end
        
        task.wait(0.1)
        local totalHeight = 0
        for _, child in ipairs(currentScriptsFrame:GetChildren()) do
            if child:IsA("Frame") then
                totalHeight = totalHeight + child.Size.Y.Offset + scriptsLayout.Padding.Offset
            end
        end
        currentScriptsFrame.CanvasSize = UDim2.new(0, 0, 0, totalHeight + 20)
    end
    
    local function showGamesList()
        if currentScriptsFrame then
            currentScriptsFrame.Visible = false
        end
        
        scrollFrame.Visible = true
        title.Text = "üéÆ RSQ GAMES LIBRARY"
    end

    local function loadGames()
        for _, child in ipairs(scrollFrame:GetChildren()) do
            if child:IsA("Frame") then
                child:Destroy()
            end
        end
        
        if not GamesList or #GamesList == 0 then
            local emptyLabel = Instance.new("TextLabel", scrollFrame)
            emptyLabel.Size = UDim2.new(1, 0, 0, 80)
            emptyLabel.Text = "üì≠ No games available\nCheck back later!"
            emptyLabel.Font = Enum.Font.Gotham
            emptyLabel.TextSize = 13
            emptyLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
            emptyLabel.BackgroundTransparency = 1
            emptyLabel.TextWrapped = true
            emptyLabel.LayoutOrder = 1
            return
        end
        
        for _, gameData in ipairs(GamesList) do
            if gameData and gameData.id and gameData.name then
                local gameCard = Instance.new("Frame", scrollFrame)
                gameCard.Size = UDim2.new(1, 0, 0, 70)
                gameCard.BackgroundColor3 = Color3.fromRGB(30, 35, 50)
                gameCard.BackgroundTransparency = 0.3
                gameCard.BorderSizePixel = 0
                Instance.new("UICorner", gameCard).CornerRadius = UDim.new(0, 8)
                
                local gameInfo = Instance.new("Frame", gameCard)
                gameInfo.Size = UDim2.new(0.7, 0, 1, 0)
                gameInfo.Position = UDim2.new(0, 10, 0, 0)
                gameInfo.BackgroundTransparency = 1
                
                local gameName = Instance.new("TextLabel", gameInfo)
                gameName.Size = UDim2.new(1, -10, 0, 25)
                gameName.Position = UDim2.new(0, 0, 0, 5)
                gameName.Text = gameData.name
                gameName.Font = Enum.Font.GothamBold
                gameName.TextSize = 13
                gameName.TextColor3 = Color3.new(1, 1, 1)
                gameName.TextXAlignment = Enum.TextXAlignment.Left
                gameName.BackgroundTransparency = 1
                
                local gameId = Instance.new("TextLabel", gameInfo)
                gameId.Size = UDim2.new(1, -10, 0, 20)
                gameId.Position = UDim2.new(0, 0, 0, 30)
                gameId.Text = "üÜî ID: " .. gameData.id
                gameId.Font = Enum.Font.Gotham
                gameId.TextSize = 11
                gameId.TextColor3 = Color3.fromRGB(150, 150, 150)
                gameId.TextXAlignment = Enum.TextXAlignment.Left
                gameId.BackgroundTransparency = 1
                
                local scriptCount = Instance.new("TextLabel", gameInfo)
                scriptCount.Size = UDim2.new(1, -10, 0, 15)
                scriptCount.Position = UDim2.new(0, 0, 0, 50)
                local scripts = gameData.scripts or {}
                scriptCount.Text = "üìú " .. #scripts .. " script" .. (#scripts == 1 and "" or "s")
                scriptCount.Font = Enum.Font.Gotham
                scriptCount.TextSize = 10
                scriptCount.TextColor3 = Color3.fromRGB(0, 200, 255)
                scriptCount.TextXAlignment = Enum.TextXAlignment.Left
                scriptCount.BackgroundTransparency = 1
                
                local scriptsBtn = Instance.new("TextButton", gameCard)
                scriptsBtn.Size = UDim2.new(0, 80, 0, 25)
                scriptsBtn.Position = UDim2.new(1, -85, 0.5, -12.5)
                scriptsBtn.Text = "üìú View"
                scriptsBtn.Font = Enum.Font.GothamBold
                scriptsBtn.TextSize = 11
                scriptsBtn.TextColor3 = Color3.new(1, 1, 1)
                scriptsBtn.BackgroundColor3 = Color3.fromRGB(79, 124, 255)
                scriptsBtn.BackgroundTransparency = 0.2
                scriptsBtn.BorderSizePixel = 0
                Instance.new("UICorner", scriptsBtn).CornerRadius = UDim.new(0, 6)
                
                do
                    local capturedGameData = {
                        id = gameData.id,
                        name = gameData.name,
                        scripts = gameData.scripts or {}
                    }
                    
                    scriptsBtn.MouseButton1Click:Connect(function()
                        showGameScripts(capturedGameData)
                    end)
                end
            end
        end
        
        task.wait(0.1)
        local totalHeight = 0
        for _, child in ipairs(scrollFrame:GetChildren()) do
            if child:IsA("Frame") then
                totalHeight = totalHeight + child.Size.Y.Offset + gamesListLayout.Padding.Offset
            end
        end
        scrollFrame.CanvasSize = UDim2.new(0, 0, 0, totalHeight)
    end
    
    local backBtn = Instance.new("TextButton", titleBar)
    backBtn.Name = "RSQ_BackBtn"
    backBtn.Size = UDim2.new(0, 80, 0, 25)
    backBtn.Position = UDim2.new(0, 10, 0.5, -12.5)
    backBtn.Text = "‚Üê Back"
    backBtn.Font = Enum.Font.GothamBold
    backBtn.TextSize = 11
    backBtn.TextColor3 = Color3.new(1, 1, 1)
    backBtn.BackgroundColor3 = Color3.fromRGB(60, 65, 80)
    backBtn.Visible = false
    backBtn.BorderSizePixel = 0
    Instance.new("UICorner", backBtn).CornerRadius = UDim.new(0, 6)
    
    backBtn.MouseButton1Click:Connect(function()
        showGamesList()
        backBtn.Visible = false
    end)
    
    local originalShowGameScripts = showGameScripts
    showGameScripts = function(gameData)
        originalShowGameScripts(gameData)
        backBtn.Visible = true
    end
    
    local refreshBtn = Instance.new("TextButton", mainFrame)
    refreshBtn.Size = UDim2.new(0, 100, 0, 25)
    refreshBtn.Position = UDim2.new(0.5, -50, 1, -35)
    refreshBtn.Text = "üîÑ Refresh"
    refreshBtn.Font = Enum.Font.GothamBold
    refreshBtn.TextSize = 11
    refreshBtn.TextColor3 = Color3.new(1, 1, 1)
    refreshBtn.BackgroundColor3 = Color3.fromRGB(79, 124, 255)
    refreshBtn.BackgroundTransparency = 0.2
    refreshBtn.BorderSizePixel = 0
    Instance.new("UICorner", refreshBtn).CornerRadius = UDim.new(0, 6)
    
    refreshBtn.MouseButton1Click:Connect(function()
        createNotify("Refreshing games list...", Color3.fromRGB(79, 124, 255))
        fetchDataFromDatabase()
        loadGames()
        showGamesList()
        backBtn.Visible = false
    end)
    
    loadGames()
    
    mainFrame.BackgroundTransparency = 1
    TweenService:Create(mainFrame, TweenInfo.new(0.3), {BackgroundTransparency = 0.1}):Play()
end

--==================================================--
-- KEY GUI
--==================================================--
local function showKeyGUI()
    if not IsInRequiredGroup then
        createNotify("‚ùå You must join the group first!", Color3.fromRGB(255, 59, 48))
        createGroupRequirementNotification()
        return
    end
    
    if isGUILoaded() then
        createNotify("‚ö†Ô∏è GUI is already open!", Color3.fromRGB(255, 140, 0))
        return
    end
    
    if CurrentGUI and CurrentGUI.Parent then
        CurrentGUI:Destroy()
        CurrentGUI = nil
    end
    
    IsGuiOpen = true
    HasShownGUIAlready = true
    
    local gui = Instance.new("ScreenGui")
    gui.Name = "RSQ_KeySystem"
    gui.IgnoreGuiInset = true
    gui.ResetOnSpawn = false
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    gui.Parent = CoreGui
    CurrentGUI = gui

    local card = Instance.new("Frame", gui)
    card.Size = UDim2.new(0, 350, 0, 250)
    card.Position = UDim2.new(0.5, -175, 0.5, -125)
    card.BackgroundColor3 = Color3.fromRGB(20, 24, 36)
    card.BackgroundTransparency = 1
    card.BorderSizePixel = 0
    Instance.new("UICorner", card).CornerRadius = UDim.new(0, 12)
    
    makeDraggable(card, card)

    local titleBar = Instance.new("Frame", card)
    titleBar.Size = UDim2.new(1, 0, 0, 35)
    titleBar.BackgroundColor3 = Color3.fromRGB(30, 35, 50)
    titleBar.BackgroundTransparency = 0.3
    titleBar.BorderSizePixel = 0
    Instance.new("UICorner", titleBar).CornerRadius = UDim.new(0, 12, 0, 0)
    
    local title = Instance.new("TextLabel", titleBar)
    title.Size = UDim2.new(1, -45, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.Text = "üîê RSQ Key System"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 14
    title.TextColor3 = Color3.new(1,1,1)
    title.BackgroundTransparency = 1
    
    local closeBtn = Instance.new("TextButton", titleBar)
    closeBtn.Size = UDim2.new(0, 22, 0, 22)
    closeBtn.Position = UDim2.new(1, -25, 0.5, -11)
    closeBtn.Text = "‚úï"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 12
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.BackgroundColor3 = Color3.fromRGB(255, 59, 48)
    closeBtn.BorderSizePixel = 0
    Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 6)
    
    closeBtn.MouseButton1Click:Connect(function()
        IsGuiOpen = false
        gui:Destroy()
        CurrentGUI = nil
    end)

    local input = Instance.new("TextBox", card)
    input.PlaceholderText = "Paste your key here"
    input.Size = UDim2.new(1, -30, 0, 35)
    input.Position = UDim2.new(0, 15, 0, 45)
    input.Font = Enum.Font.Gotham
    input.TextSize = 13
    input.TextColor3 = Color3.new(1,1,1)
    input.BackgroundColor3 = Color3.fromRGB(14,18,30)
    input.BorderSizePixel = 0
    Instance.new("UICorner", input).CornerRadius = UDim.new(0,8)

    local unlock = Instance.new("TextButton", card)
    unlock.Text = "Unlock / Check Key"
    unlock.Size = UDim2.new(1, -30, 0, 35)
    unlock.Position = UDim2.new(0, 15, 0, 90)
    unlock.Font = Enum.Font.GothamBold
    unlock.TextSize = 13
    unlock.TextColor3 = Color3.new(1,1,1)
    unlock.BackgroundColor3 = Color3.fromRGB(0,140,255)
    unlock.BorderSizePixel = 0
    Instance.new("UICorner", unlock).CornerRadius = UDim.new(0,8)

    local getKey = Instance.new("TextButton", card)
    getKey.Text = "üåê Get Key"
    getKey.Size = UDim2.new(1, -30, 0, 30)
    getKey.Position = UDim2.new(0, 15, 0, 135)
    getKey.Font = Enum.Font.GothamBold
    getKey.TextSize = 12
    getKey.TextColor3 = Color3.new(1,1,1)
    getKey.BackgroundColor3 = Color3.fromRGB(255,140,0)
    getKey.BorderSizePixel = 0
    Instance.new("UICorner", getKey).CornerRadius = UDim.new(0,8)

    local status = Instance.new("TextLabel", card)
    status.Position = UDim2.new(0, 15, 0, 175)
    status.Size = UDim2.new(1, -30, 0, 50)
    status.TextWrapped = true
    status.Font = Enum.Font.Gotham
    status.TextSize = 12
    status.TextColor3 = Color3.fromRGB(210,210,210)
    status.BackgroundTransparency = 1
    status.Text = "Enter your key to continue"

    TweenService:Create(card, TweenInfo.new(0.4), {BackgroundTransparency = 0}):Play()

    unlock.MouseButton1Click:Connect(function()
        local inputKey = string_trim(input.Text)
        if inputKey == "" then return end

        status.Text = "‚ö° Checking..."
        
        local ok, res = validate(inputKey, true) 
        
        if not ok then
            ok, res = validate(inputKey, false)
        end

        if ok then
            CurrentKey = inputKey
            KeyActive = true
            status.Text = "‚úÖ Success! Loading..."
            
            saveKeyStatus()
            
            TweenService:Create(card, TweenInfo.new(0.3), {BackgroundTransparency = 1, Size = UDim2.new(0,0,0,0)}):Play()
            task.delay(0.3, function() 
                gui:Destroy() 
                CurrentGUI = nil
                IsGuiOpen = false
                showAdvancedGamesGUI()
            end)

            for _, url in ipairs(SCRIPT_URLS) do
                task.spawn(function()
                    pcall(function() 
                        local scriptContent = game:HttpGet(url)
                        loadstring(scriptContent)() 
                    end)
                end)
            end
        else
            status.Text = res
            if res == "‚ùå Expired" or res == "‚ùå Invalid Key" then
                clearKeyStatus()
                CurrentKey = nil
                KeyActive = false
            end
        end
    end)

    getKey.MouseButton1Click:Connect(function()
        setclipboard(GET_KEY_URL)
        status.Text = "üìã Link Copied!"
    end)
end

--==================================================--
-- INITIALIZATION
--==================================================--
local function initializeWithGroupCheck()
    IsInitializing = true
    
    task.wait(1)
    
    local isInGroup = checkGroupMembership()
    
    if not isInGroup then
        createGroupRequirementNotification()
        
        local reminderInterval = 30
        task.spawn(function()
            while not IsInRequiredGroup do
                task.wait(reminderInterval)
                createNotify("üì¢ REMINDER: Join the group to access the UI!", Color3.fromRGB(255, 140, 0))
                createMerchReminder()
                checkGroupMembership()
            end
        end)
        
        repeat
            task.wait(5)
            checkGroupMembership()
        until IsInRequiredGroup
        
        createNotify("‚úÖ You're now in the group! Loading UI...", Color3.fromRGB(40, 200, 80))
    end
    
    local hasSavedKey = loadKeyStatus()
    if hasSavedKey then
        createNotify("Loading saved key...", Color3.fromRGB(79, 124, 255))
        
        local ok, res = validate(CurrentKey, false)
        if ok then
            createNotify("‚úÖ Key validated successfully!", Color3.fromRGB(40, 200, 80))
            
            task.wait(1)
            showAdvancedGamesGUI()
            
            for _, url in ipairs(SCRIPT_URLS) do
                task.spawn(function()
                    pcall(function() 
                        local scriptContent = game:HttpGet(url)
                        loadstring(scriptContent)() 
                    end)
                end)
            end
        else
            createNotify("‚ùå Saved key is invalid: " .. res, Color3.fromRGB(255, 50, 50))
            clearKeyStatus()
            CurrentKey = nil
            KeyActive = false
            showKeyGUI()
        end
    else
        showKeyGUI()
    end
    
    IsInitializing = false
end

--==================================================--
-- ADMIN PANEL (Optional - Uncomment if needed)
--==================================================--
--[[
local function createAdminGUI()
    if not IsAdmin then return end
    
    -- Admin GUI code here
    -- Allows adding/deleting keys, banning users, etc.
end
--]]

--==================================================--
-- MAIN INITIALIZATION
--==================================================--
task.spawn(function()
    print("[SYSTEM] Initializing Pastebin database...")
    local success = initializeDatabase()
    if success then
        print("[SYSTEM] Database initialized successfully")
        fetchDataFromDatabase()
        
        if IsAdmin then
            createNotify("üëë Admin privileges detected", Color3.fromRGB(255, 204, 0))
        end
    else
        warn("[SYSTEM] Failed to initialize database")
    end
    
    initializeWithGroupCheck()
end)

--==================================================--
-- SECURITY LOOP
--==================================================--
task.spawn(function()
    while true do
        task.wait(CHECK_INTERVAL)
        
        if IsInRequiredGroup then
            checkGroupMembership()
        end
        
        if KeyActive and CurrentKey then
            local ok, res = validate(CurrentKey, false)
            if not ok then
                createNotify("‚ùå Key is no longer valid: " .. res, Color3.fromRGB(255, 50, 50))
                KeyActive = false
                CurrentKey = nil
                clearKeyStatus()
                
                if CurrentGUI and CurrentGUI.Parent then
                    CurrentGUI:Destroy()
                    CurrentGUI = nil
                end
                
                IsGuiOpen = false
                
                if IsInRequiredGroup then
                    showKeyGUI()
                else
                    createGroupRequirementNotification()
                end
            end
        end
    end
end)

--==================================================--
-- OPEN BUTTON
--==================================================--
local function createOpenButton()
    if not IsInRequiredGroup then
        return
    end
    
    if OpenButton and OpenButton.Parent then
        OpenButton:Destroy()
        OpenButton = nil
    end
    
    OpenButton = Instance.new("ScreenGui")
    OpenButton.Name = "RSQ_OpenButton"
    OpenButton.IgnoreGuiInset = true
    OpenButton.ResetOnSpawn = false
    OpenButton.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    OpenButton.Parent = CoreGui
    
    local button = Instance.new("TextButton", OpenButton)
    button.Name = "ToggleButton"
    button.Size = UDim2.new(0, 60, 0, 60)
    button.Position = UDim2.new(1, -70, 0, 20)
    button.Text = IsGuiOpen and "üîí" or "üîì"
    button.Font = Enum.Font.GothamBold
    button.TextSize = 24
    button.TextColor3 = Color3.new(1, 1, 1)
    button.BackgroundColor3 = IsGuiOpen and Color3.fromRGB(255, 140, 0) or Color3.fromRGB(79, 124, 255)
    button.BackgroundTransparency = 0.2
    button.BorderSizePixel = 0
    Instance.new("UICorner", button).CornerRadius = UDim.new(1, 0)
    
    local shadow = Instance.new("UIStroke", button)
    shadow.Color = Color3.fromRGB(0, 0, 0)
    shadow.Transparency = 0.5
    shadow.Thickness = 2
    
    local function toggleGUI()
        if IsGuiOpen then
            local existingGuis = {}
            
            for _, gui in pairs(CoreGui:GetChildren()) do
                if (gui.Name == "RSQ_KeySystem" or gui.Name == "RSQ_AdvancedGamesGUI" or 
                    gui.Name:find("RSQ_GameIdConfirm") or gui.Name:find("RSQ_Notifications") or
                    gui.Name:find("RSQ_GroupRequirement") or gui.Name:find("RSQ_MerchReminder")) then
                    table.insert(existingGuis, gui)
                end
            end
            
            if player.PlayerGui then
                for _, gui in pairs(player.PlayerGui:GetChildren()) do
                    if (gui.Name == "RSQ_KeySystem" or gui.Name == "RSQ_AdvancedGamesGUI" or 
                        gui.Name:find("RSQ_GameIdConfirm") or gui.Name:find("RSQ_Notifications") or
                        gui.Name:find("RSQ_GroupRequirement") or gui.Name:find("RSQ_MerchReminder")) then
                        table.insert(existingGuis, gui)
                    end
                end
            end
            
            for _, gui in ipairs(existingGuis) do
                gui:Destroy()
            end
            
            IsGuiOpen = false
            CurrentGUI = nil
            button.Text = "üîì"
            button.BackgroundColor3 = Color3.fromRGB(79, 124, 255)
        else
            if isGUILoaded() then
                createNotify("‚ö†Ô∏è GUI is already open!", Color3.fromRGB(255, 140, 0))
                return
            end
            
            if KeyActive and CurrentKey then
                showAdvancedGamesGUI()
            else
                showKeyGUI()
            end
            IsGuiOpen = true
            button.Text = "üîí"
            button.BackgroundColor3 = Color3.fromRGB(255, 140, 0)
        end
    end
    
    local dragging = false
    local dragInput
    local dragStart
    local startPos
    
    local function update(input)
        if dragging then
            local delta = input.Position - dragStart
            button.Position = UDim2.new(
                startPos.X.Scale, 
                startPos.X.Offset + delta.X,
                startPos.Y.Scale, 
                startPos.Y.Offset + delta.Y
            )
        end
    end
    
    button.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or 
           input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = button.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    button.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or 
           input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input == dragInput or input.UserInputType == Enum.UserInputType.Touch) then
            update(input)
        end
    end)
    
    button.MouseButton1Click:Connect(function()
        if not dragging then
            toggleGUI()
        end
    end)
    
    button.MouseEnter:Connect(function()
        if not dragging then
            TweenService:Create(button, TweenInfo.new(0.2), {Size = UDim2.new(0, 65, 0, 65)}):Play()
        end
    end)
    
    button.MouseLeave:Connect(function()
        if not dragging then
            TweenService:Create(button, TweenInfo.new(0.2), {Size = UDim2.new(0, 60, 0, 60)}):Play()
        end
    end)
    
    button.Position = UDim2.new(1, 100, 0, 20)
    TweenService:Create(button, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
        Position = UDim2.new(1, -70, 0, 20)
    }):Play()
    
    return OpenButton
end

task.spawn(function()
    repeat
        task.wait(5)
        checkGroupMembership()
    until IsInRequiredGroup
    
    createOpenButton()
    
    local function addMerchRemindersToGUI()
        if IsGuiOpen then
            while IsGuiOpen do
                task.wait(300)
                if IsGuiOpen then
                    createMerchReminder()
                end
            end
        end
    end
    
    local originalShowAdvancedGamesGUI = showAdvancedGamesGUI
    showAdvancedGamesGUI = function(...)
        local result = originalShowAdvancedGamesGUI(...)
        task.spawn(addMerchRemindersToGUI)
        return result
    end
end)
