<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RSQ Elite | System Overseer</title>

<style>
:root {
    --primary: #4f7cff;
    --secondary: #00d2ff;
    --danger: #ff3b30;
    --success: #28cd41;
    --warning: #ffcc00;
    --glass: rgba(15, 20, 30, 0.95);
    --border: rgba(255, 255, 255, 0.08);
    --chat-bg: rgba(10, 12, 18, 0.95);
    --notification: #ff4d6d;
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    background: #05070a;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    color: #f0f0f0;
    overflow: hidden;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Animations */
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes notificationPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
@keyframes glow {
    0% { box-shadow: 0 0 5px rgba(255, 77, 109, 0.5); }
    50% { box-shadow: 0 0 20px rgba(255, 77, 109, 0.8); }
    100% { box-shadow: 0 0 5px rgba(255, 77, 109, 0.5); }
}

.animate-fade { animation: fadeIn 0.3s ease forwards; }
.animate-slide { animation: slideIn 0.3s ease forwards; }
.animate-slide-right { animation: slideInRight 0.3s ease forwards; }

#bg-wrap { 
    position: fixed; 
    inset: 0; 
    background: radial-gradient(ellipse at top, #0a0e1a 0%, #05070a 70%); 
    z-index: -2; 
}

/* Particle Background */
#particles {
    position: fixed;
    inset: 0;
    z-index: -1;
    pointer-events: none;
}

/* Stats Bar */
.stats-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(10, 12, 18, 0.9);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 8px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    z-index: 9999;
    height: 36px;
}

.stats-item {
    display: flex;
    align-items: center;
    gap: 6px;
    opacity: 0.8;
    transition: opacity 0.2s;
}

.stats-item:hover {
    opacity: 1;
}

.stats-icon {
    font-size: 11px;
}

.stats-value {
    font-weight: 600;
    color: var(--secondary);
    font-family: 'Monaco', 'Consolas', monospace;
}

.stats-label {
    font-size: 10px;
    opacity: 0.7;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Panel Styling */
.panel {
    position: relative;
    z-index: 10;
    width: 420px;
    background: var(--glass);
    backdrop-filter: blur(30px);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.hidden { display: none !important; }

/* Notification Center */
#notificationCenter {
    position: fixed;
    top: 50px;
    right: 20px;
    width: 350px;
    max-height: 500px;
    background: var(--glass);
    backdrop-filter: blur(30px);
    border: 1px solid var(--border);
    border-radius: 16px;
    z-index: 10001;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

.notification-header {
    padding: 15px 20px;
    background: rgba(255, 255, 255, 0.03);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-header h3 {
    margin: 0;
    font-size: 14px;
    color: var(--secondary);
}

.notification-actions {
    display: flex;
    gap: 10px;
}

.notification-actions button {
    margin: 0;
    padding: 4px 10px;
    font-size: 11px;
    width: auto;
}

#notificationsList {
    flex: 1;
    overflow-y: auto;
    max-height: 400px;
    padding: 10px;
}

.notification-item {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    animation: slideInRight 0.3s ease;
}

.notification-item:hover {
    background: rgba(255, 255, 255, 0.05);
    transform: translateX(-2px);
}

.notification-item.unread {
    border-left: 3px solid var(--notification);
    background: rgba(255, 77, 109, 0.05);
}

.notification-item.unread:hover {
    background: rgba(255, 77, 109, 0.08);
}

.notification-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--secondary);
    margin-bottom: 4px;
    display: flex;
    justify-content: space-between;
}

.notification-message {
    font-size: 11px;
    opacity: 0.9;
    margin-bottom: 6px;
    word-break: break-word;
}

.notification-time {
    font-size: 9px;
    opacity: 0.5;
    font-family: monospace;
}

.notification-badge {
    position: fixed;
    top: 45px;
    right: 20px;
    background: var(--notification);
    color: white;
    font-size: 10px;
    font-weight: 700;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    animation: notificationPulse 2s infinite, glow 2s infinite;
    z-index: 10002;
    cursor: pointer;
}

/* Floating Notification */
.floating-notification {
    position: fixed;
    top: 50px;
    right: 20px;
    background: var(--glass);
    backdrop-filter: blur(30px);
    border: 1px solid var(--border);
    border-left: 3px solid var(--notification);
    border-radius: 10px;
    padding: 12px 15px;
    z-index: 10003;
    animation: slideInRight 0.3s ease, fadeOut 5s forwards;
    max-width: 300px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    cursor: pointer;
}

.floating-notification .title {
    font-weight: 600;
    font-size: 12px;
    color: var(--secondary);
    margin-bottom: 4px;
}

.floating-notification .message {
    font-size: 11px;
    opacity: 0.9;
}

@keyframes fadeOut {
    0% { opacity: 1; transform: translateX(0); }
    70% { opacity: 1; transform: translateX(0); }
    100% { opacity: 0; transform: translateX(100%); }
}

/* Form Elements */
input, select, textarea {
    width: 100%;
    padding: 12px 16px;
    margin-top: 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: white;
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s;
    outline: none;
}

input:focus, select:focus, textarea:focus {
    border-color: var(--primary);
    background: rgba(0, 0, 0, 0.4);
    box-shadow: 0 0 0 2px rgba(79, 124, 255, 0.1);
}

/* Buttons */
button {
    width: 100%;
    padding: 12px 20px;
    margin-top: 16px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
}

button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: 0.5s;
}

button:hover::before {
    left: 100%;
}

button:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(79, 124, 255, 0.2);
}

button:active {
    transform: translateY(0);
}

button.danger { background: linear-gradient(135deg, #ff3b30, #ff6b52); }
button.warning { background: linear-gradient(135deg, #ffcc00, #ffaa00); color: #000; }
button.success { background: linear-gradient(135deg, #28cd41, #2ee058); }
button.mini { 
    padding: 4px 10px; 
    font-size: 11px; 
    margin-top: 0; 
    width: auto; 
    border-radius: 8px; 
}

/* Notification Toggle Button */
#notification-toggle {
    position: fixed;
    top: 45px;
    right: 20px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10001;
    transition: all 0.2s;
}

#notification-toggle:hover {
    transform: scale(1.1);
    border-color: var(--secondary);
}

#notification-toggle svg {
    width: 18px;
    height: 18px;
    fill: white;
}

/* Chat Toggle */
#chat-toggle {
    position: fixed; 
    bottom: 25px; 
    right: 25px; 
    width: 56px; 
    height: 56px;
    border-radius: 50%; 
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    display: flex;
    align-items: center; 
    justify-content: center; 
    cursor: pointer; 
    z-index: 1000;
    box-shadow: 
        0 6px 20px rgba(0,0,0,0.3),
        0 0 0 1px rgba(255, 255, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
}

#chat-toggle:hover {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 
        0 10px 30px rgba(79, 124, 255, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.2);
}

#chat-toggle svg { 
    width: 24px; 
    height: 24px; 
    fill: white; 
}

#unread-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--danger);
    color: white;
    font-size: 10px;
    font-weight: 700;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

/* Chat Window */
#chat-window {
    position: fixed;
    bottom: 100px;
    right: 25px;
    width: 380px;
    height: 520px;
    background: var(--chat-bg);
    backdrop-filter: blur(30px);
    border: 1px solid var(--border);
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    z-index: 999;
    overflow: hidden;
    box-shadow: 
        0 25px 80px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.chat-fullscreen {
    bottom: 0 !important; 
    right: 0 !important;
    width: 100vw !important; 
    height: 100vh !important;
    border-radius: 0 !important;
    z-index: 5000 !important;
}

/* Chat Header */
.chat-header {
    padding: 16px 20px;
    background: rgba(255, 255, 255, 0.03);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
}

.chat-header-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--secondary);
    letter-spacing: 0.5px;
}

.chat-header-stats {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 11px;
    opacity: 0.7;
}

.chat-header-stats span {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Chat Messages Container */
#chat-msgs {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    scroll-behavior: smooth;
    background: rgba(5, 7, 10, 0.4);
}

/* Pinned Message */
#pinned-area {
    background: linear-gradient(90deg, rgba(255, 204, 0, 0.1), rgba(255, 204, 0, 0.05));
    border-bottom: 1px solid rgba(255, 204, 0, 0.3);
    padding: 10px 16px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
}

#pinned-area .pin-icon {
    color: var(--warning);
    font-size: 12px;
    flex-shrink: 0;
}

#pinned-area .pin-text {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Message Items */
.msg-item {
    margin-bottom: 12px;
    padding: 12px;
    border-radius: 12px;
    animation: fadeIn 0.2s ease forwards;
    position: relative;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.2s;
}

.msg-item:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

.msg-item.system {
    background: rgba(79, 124, 255, 0.08);
    border-color: rgba(79, 124, 255, 0.2);
    border-left: 3px solid var(--primary);
}

.msg-item.owner-msg {
    background: rgba(255, 204, 0, 0.05);
    border-color: rgba(255, 204, 0, 0.15);
    border-left: 3px solid var(--warning);
}

.msg-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
}

.msg-user {
    font-weight: 600;
    font-size: 12px;
    color: var(--secondary);
    display: flex;
    align-items: center;
    gap: 6px;
}

.msg-user .owner-badge {
    color: var(--warning);
    font-size: 10px;
}

.msg-time {
    font-size: 10px;
    opacity: 0.5;
    font-family: 'Monaco', 'Consolas', monospace;
}

.msg-content {
    font-size: 13px;
    line-height: 1.4;
    margin-bottom: 8px;
    word-break: break-word;
}

/* Reply Quote */
.reply-quote {
    font-size: 11px;
    opacity: 0.7;
    padding-left: 10px;
    border-left: 2px solid var(--primary);
    margin-bottom: 8px;
    font-style: italic;
    background: rgba(79, 124, 255, 0.05);
    padding: 6px 10px;
    border-radius: 6px;
}

/* Message Actions */
.msg-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: none;
    gap: 4px;
    background: rgba(20, 25, 35, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px;
    z-index: 10;
}

.msg-item:hover .msg-actions {
    display: flex;
}

.action-btn {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 11px;
    transition: all 0.2s;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    padding: 0;
    margin: 0;
}

.action-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    transform: scale(1.1);
}

.action-btn.delete:hover {
    background: rgba(255, 59, 48, 0.2);
    color: var(--danger);
}

/* Emoji Picker */
.emoji-picker {
    position: absolute;
    bottom: 45px;
    right: 8px;
    background: rgba(20, 25, 35, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 8px;
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 4px;
    z-index: 100;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    animation: fadeIn 0.2s ease;
}

.emoji-btn {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    background: transparent;
    border: none;
    padding: 0;
}

.emoji-btn:hover {
    background: rgba(79, 124, 255, 0.2);
    transform: scale(1.2);
}

/* Reactions */
.reactions-container {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.reaction-btn-small {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    padding: 1px 6px;
    background: rgba(79, 124, 255, 0.1);
    border: 1px solid rgba(79, 124, 255, 0.15);
    border-radius: 8px;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
    height: 20px;
    line-height: 1;
}

.reaction-btn-small:hover {
    background: rgba(79, 124, 255, 0.2);
    border-color: rgba(79, 124, 255, 0.3);
    transform: translateY(-1px);
}

.reaction-btn-small.active {
    background: rgba(79, 124, 255, 0.25);
    border-color: var(--primary);
    box-shadow: 0 0 0 1px rgba(79, 124, 255, 0.3);
}

.reaction-emoji-small {
    font-size: 10px;
}

.reaction-count-small {
    font-weight: 600;
    color: var(--secondary);
    font-size: 9px;
    min-width: 8px;
}

/* Chat Input Area */
.chat-input-area {
    padding: 16px;
    background: rgba(255, 255, 255, 0.02);
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex-shrink: 0;
}

.reply-preview {
    background: rgba(79, 124, 255, 0.1);
    border-radius: 8px;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 11px;
    animation: slideIn 0.2s ease;
}

.reply-preview-text {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    opacity: 0.9;
}

.cancel-reply {
    cursor: pointer;
    color: var(--danger);
    font-size: 12px;
    padding: 2px;
    border-radius: 4px;
    transition: all 0.2s;
}

.cancel-reply:hover {
    background: rgba(255, 59, 48, 0.1);
}

.chat-input-row {
    display: flex;
    gap: 10px;
    align-items: center;
}

#chat-input {
    flex: 1;
    margin: 0;
    padding: 12px 16px;
    font-size: 13px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border);
    border-radius: 10px;
    min-height: 40px;
    resize: none;
    line-height: 1.4;
}

#chat-input:focus {
    background: rgba(0, 0, 0, 0.4);
    border-color: var(--primary);
}

#send-chat-btn {
    margin: 0;
    width: 80px;
    padding: 10px;
    font-size: 12px;
    font-weight: 600;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
}

/* Scrollbar Styling */
#chat-msgs::-webkit-scrollbar, #notificationsList::-webkit-scrollbar {
    width: 6px;
}

#chat-msgs::-webkit-scrollbar-track, #notificationsList::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 3px;
}

#chat-msgs::-webkit-scrollbar-thumb, #notificationsList::-webkit-scrollbar-thumb {
    background: rgba(79, 124, 255, 0.2);
    border-radius: 3px;
}

#chat-msgs::-webkit-scrollbar-thumb:hover, #notificationsList::-webkit-scrollbar-thumb:hover {
    background: rgba(79, 124, 255, 0.3);
}

/* Admin Panel */
.adminFull {
    position: fixed;
    inset: 0;
    background: rgba(5, 7, 10, 0.98);
    backdrop-filter: blur(30px);
    padding: 20px;
    z-index: 20000;
    overflow-y: auto;
    display: block !important;
}

.adminFull.hidden {
    display: none !important;
}

.log-box {
    background: rgba(255, 255, 255, 0.03);
    padding: 15px;
    border-radius: 12px;
    height: 250px;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

/* Toast Notifications - Admin Only */
.toast {
    position: fixed;
    top: 50px;
    right: 20px;
    background: rgba(20, 25, 35, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 18px;
    z-index: 10000;
    animation: slideIn 0.3s ease;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    max-width: 300px;
    border-left: 3px solid var(--primary);
}

.toast.success { border-left-color: var(--success); }
.toast.warning { border-left-color: var(--warning); }
.toast.error { border-left-color: var(--danger); }

/* Spinner */
.spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 0.8s linear infinite;
}

/* Back Button */
.back-btn-container {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 100;
}

/* Typing Indicator */
.typing-indicator {
    font-size: 11px;
    opacity: 0.7;
    padding: 0 16px 8px;
    font-style: italic;
    color: var(--secondary);
}

.typing-dots {
    display: inline-block;
}

.typing-dots span {
    animation: pulse 1.4s infinite;
    display: inline-block;
}

.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }

/* Empty State */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: rgba(255, 255, 255, 0.5);
    font-size: 13px;
}

.empty-state-icon {
    font-size: 32px;
    margin-bottom: 10px;
    opacity: 0.3;
}

/* Connection Status */
.connection-status {
    position: fixed;
    bottom: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    padding: 4px 10px;
    border-radius: 10px;
    font-size: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
    z-index: 10000;
    opacity: 0.7;
    transition: opacity 0.3s;
}

.connection-status:hover {
    opacity: 1;
}

.connection-status.connected .status-dot {
    background: var(--success);
    box-shadow: 0 0 8px var(--success);
}

.connection-status.disconnected .status-dot {
    background: var(--danger);
    box-shadow: 0 0 8px var(--danger);
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

/* GAME MANAGEMENT STYLES */
.game-management-section {
    background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.3s ease;
}

.game-management-section:hover {
    border-color: rgba(255,255,255,0.1);
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.game-create-container {
    max-width: 500px;
    margin: 0 auto;
    padding: 25px;
    background: rgba(255,255,255,0.02);
    border-radius: 15px;
    border: 1px solid var(--border);
}

.image-preview-container {
    width: 120px;
    height: 120px;
    border-radius: 12px;
    border: 2px dashed var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 15px auto;
    overflow: hidden;
    background: rgba(0,0,0,0.3);
    cursor: pointer;
    transition: all 0.3s ease;
}

.image-preview-container:hover {
    border-color: var(--primary);
    background: rgba(79, 124, 255, 0.05);
}

.image-preview {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
}

.image-placeholder {
    text-align: center;
    color: rgba(255,255,255,0.5);
    font-size: 12px;
    padding: 10px;
}

.image-placeholder .icon {
    font-size: 24px;
    margin-bottom: 8px;
    display: block;
}

/* Games Dashboard */
.games-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.game-card {
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    padding: 15px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.game-card:hover {
    background: rgba(255,255,255,0.05);
    border-color: var(--primary);
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(79, 124, 255, 0.1);
}

.game-card-image {
    width: 100%;
    height: 100px;
    border-radius: 8px;
    object-fit: cover;
    margin-bottom: 10px;
    background: rgba(0,0,0,0.3);
}

.game-card-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 5px;
    color: white;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.game-card-id {
    font-size: 10px;
    opacity: 0.7;
    font-family: monospace;
    margin-bottom: 8px;
}

.game-card-scripts {
    font-size: 11px;
    opacity: 0.8;
    background: rgba(79, 124, 255, 0.1);
    padding: 3px 8px;
    border-radius: 10px;
    display: inline-block;
}

/* Script Management View */
.script-management-view {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.script-management-section {
    background: rgba(255,255,255,0.02);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(255,255,255,0.05);
}

.current-game-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
}

.current-game-image {
    width: 80px;
    height: 80px;
    border-radius: 12px;
    object-fit: cover;
    border: 2px solid var(--border);
}

.current-game-info h3 {
    margin: 0;
    font-size: 22px;
    color: white;
}

.current-game-info p {
    margin: 8px 0 0;
    font-size: 13px;
    opacity: 0.7;
    font-family: monospace;
}

.scripts-list {
    max-height: 400px;
    overflow-y: auto;
    margin: 20px 0;
    padding-right: 10px;
}

.script-item {
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.2s ease;
}

.script-item:hover {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.1);
}

.script-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.script-name {
    font-weight: 600;
    color: var(--secondary);
    font-size: 14px;
}

.script-url {
    font-family: monospace;
    font-size: 12px;
    color: rgba(255,255,255,0.8);
    word-break: break-all;
    margin-bottom: 8px;
    padding: 8px;
    background: rgba(0,0,0,0.2);
    border-radius: 6px;
    border-left: 3px solid var(--primary);
}

.script-meta {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
}

.script-actions {
    display: flex;
    gap: 8px;
}

/* Add Script Form */
.add-script-form {
    background: rgba(79, 124, 255, 0.05);
    border-radius: 12px;
    padding: 20px;
    margin-top: 25px;
    border: 1px solid rgba(79, 124, 255, 0.1);
}

.add-script-form h4 {
    margin-top: 0;
    margin-bottom: 15px;
    color: var(--secondary);
    font-size: 16px;
}

/* File Input */
.file-input-wrapper {
    position: relative;
    margin: 15px 0;
}

.file-input-wrapper input[type="file"] {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.file-input-label {
    display: block;
    padding: 12px 20px;
    background: rgba(79, 124, 255, 0.1);
    border: 2px dashed rgba(79, 124, 255, 0.3);
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--secondary);
    font-weight: 500;
}

.file-input-label:hover {
    background: rgba(79, 124, 255, 0.15);
    border-color: var(--primary);
}

.file-input-label .icon {
    margin-right: 8px;
}

/* Back Navigation */
.back-nav {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 30px;
    cursor: pointer;
    color: var(--secondary);
    font-weight: 500;
    transition: all 0.2s ease;
}

.back-nav:hover {
    color: white;
    transform: translateX(-3px);
}

.back-nav .icon {
    font-size: 20px;
}

/* Game Actions */
.game-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.game-card:hover .game-actions {
    opacity: 1;
}

.game-action-btn {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    color: rgba(255,255,255,0.7);
    transition: all 0.2s ease;
}

.game-action-btn:hover {
    background: rgba(255,255,255,0.1);
    color: white;
    transform: scale(1.1);
}

.game-action-btn.delete:hover {
    background: rgba(255, 59, 48, 0.2);
    color: var(--danger);
}

/* Dashboard Header */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.dashboard-header h3 {
    margin: 0;
}

.dashboard-stats {
    display: flex;
    gap: 15px;
    font-size: 12px;
    opacity: 0.8;
}

.dashboard-stats span {
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(5, 7, 10, 0.9);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    flex-direction: column;
    gap: 20px;
}

.loading-spinner-large {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255,255,255,0.1);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s linear infinite;
}

.loading-text {
    color: var(--secondary);
    font-size: 14px;
    font-weight: 500;
}

/* Feedback UI */
.fb-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    margin-bottom: 8px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.2s ease;
}

.fb-item:hover {
    background: rgba(255,255,255,0.08);
    border-color: rgba(255,255,255,0.1);
}

/* Gradient Text */
.gradient-text {
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Modal Overlay */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

/* Ban Now Modal */
.ban-modal-content {
    background: var(--glass);
    border: 1px solid var(--danger);
    border-radius: 15px;
    padding: 25px;
    width: 90%;
    max-width: 500px;
}

/* Script Empty State */
.script-empty-state {
    text-align: center;
    padding: 50px 20px;
    color: rgba(255,255,255,0.5);
    font-size: 14px;
}

.script-empty-state .icon {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.3;
    display: block;
}

/* Cooldown indicator */
.cooldown-indicator {
    font-size: 11px;
    text-align: center;
    margin-top: 8px;
    color: var(--warning);
}

.cooldown-time {
    font-family: monospace;
    font-weight: bold;
    color: var(--danger);
}
</style>
</head>
<body>

<!-- Stats Bar -->
<div class="stats-bar">
    <div class="stats-item">
        <span class="stats-icon">üëÅÔ∏è</span>
        <span class="stats-label">Views:</span>
        <span class="stats-value" id="viewCount">0</span>
    </div>
    <div class="stats-item">
        <span class="stats-icon">‚ö°</span>
        <span class="stats-label">Live Active:</span>
        <span class="stats-value" id="activeCount">0</span>
    </div>
    <div class="stats-item">
        <span class="stats-icon">üïí</span>
        <span class="stats-label" id="currentTime">00:00</span>
    </div>
</div>

<!-- Particle Background -->
<canvas id="particles"></canvas>
<div id="bg-wrap"></div>

<!-- Connection Status -->
<div class="connection-status connected" id="connectionStatus">
    <div class="status-dot"></div>
    <span>Connected</span>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner-large"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
</div>

<!-- Notification Toggle -->
<div id="notification-toggle" onclick="toggleNotificationCenter()">
    <svg viewBox="0 0 24 24">
        <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
    </svg>
    <div id="notificationBadge" class="hidden">0</div>
</div>

<!-- Notification Center -->
<div id="notificationCenter" class="hidden">
    <div class="notification-header">
        <h3>üîî Notifications</h3>
        <div class="notification-actions">
            <button class="mini success" onclick="markAllNotificationsRead()">‚úì Mark all read</button>
            <button class="mini" onclick="toggleNotificationCenter()">‚úï</button>
        </div>
    </div>
    <div id="notificationsList">
        <div class="empty-state">
            <div class="empty-state-icon">üîî</div>
            <div>No notifications</div>
        </div>
    </div>
</div>

<!-- Auth Panel -->
<div id="authPanel" class="panel animate-fade">
    <div style="text-align:center; margin-bottom:30px;">
        <h1 style="margin:0; font-size:32px;" class="gradient-text">RSQ GATE</h1>
        <p style="font-size:12px; opacity:0.7; margin-top:8px;">Secure Access System</p>
    </div>
    
    <div id="loginView">
        <input id="l-user" placeholder="Username" autocomplete="username">
        <input id="l-pass" type="password" placeholder="Password" autocomplete="current-password">
        <button onclick="handleAuth('login')">
            <span>Sign In</span>
            <span class="spinner" style="display:none; margin-left:10px;" id="loginSpinner"></span>
        </button>
        <p style="text-align:center; font-size:12px; margin-top:20px; opacity:0.7;">
            New here? <a href="#" onclick="toggleAuth(true)" style="color:var(--secondary); text-decoration:none; font-weight:600;">Create Account</a>
        </p>
    </div>
    
    <div id="signupView" class="hidden">
        <input id="s-user" placeholder="Choose Username" autocomplete="username">
        <input id="s-pass" type="password" placeholder="Choose Password" autocomplete="new-password">
        <button onclick="handleAuth('signup')">
            <span>Sign Up</span>
            <span class="spinner" style="display:none; margin-left:10px;" id="signupSpinner"></span>
        </button>
        <p style="text-align:center; font-size:12px; margin-top:20px; opacity:0.7;">
            Have account? <a href="#" onclick="toggleAuth(false)" style="color:var(--secondary); text-decoration:none; font-weight:600;">Sign In</a>
        </p>
    </div>
    
    <div id="authStatus" style="text-align:center; color:var(--danger); font-size:12px; margin-top:15px; min-height:18px;"></div>
</div>

<!-- User Feedback UI -->
<div id="userFeedbackUI" class="panel animate-fade hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;" class="gradient-text">üìù FEEDBACK</h2>
        <button class="mini danger" onclick="toggleFeedbackUI(false)" style="padding:6px 12px;">‚úï Exit</button>
    </div>
    
    <input id="fb-user" placeholder="Roblox Username" style="margin-bottom:10px;">
    <input id="fb-id" placeholder="Roblox UserID" style="margin-bottom:15px;">
    
    <div style="position:relative;">
        <textarea id="fb-msg" placeholder="Write your feedback here..." style="width:100%; height:120px; background:rgba(0,0,0,0.3); color:white; border:1px solid var(--border); border-radius:10px; padding:12px; resize:none; font-size:13px;"></textarea>
        <div style="position:absolute; right:12px; bottom:12px; font-size:10px; opacity:0.5;" id="fbCharCount">0/500</div>
    </div>
    
    <button onclick="submitFeedback()" style="margin-top:15px;">
        <span>Submit Feedback</span>
        <span class="spinner" style="display:none; margin-left:10px;" id="fbSpinner"></span>
    </button>
</div>

<!-- Main System -->
<div id="mainSystem" class="hidden">
    <div id="mainContentWrapper">
        <div id="userPanel" class="panel animate-fade">
            <div style="text-align:center; margin-bottom:25px;">
                <h1 style="margin:0; font-size:28px;" class="gradient-text">RSQ ELITE</h1>
                <p id="welcomeUser" style="font-size:11px; opacity:0.5; margin-top:5px;"></p>
            </div>
            
            <input id="userid" placeholder="Roblox UserID">
            <button id="genBtn" onclick="generateKey()">
                <span>Generate Access Key</span>
                <span class="spinner" style="display:none; margin-left:10px;" id="keySpinner"></span>
            </button>
            
            <div id="statusMsg" style="text-align:center; margin-top:15px; font-size:12px; min-height:18px;"></div>
            
            <div id="keyOut" style="text-align:center; margin-top:15px; color:var(--secondary); font-family:monospace; font-weight:bold; font-size:16px; padding:12px; background:rgba(0,0,0,0.3); border-radius:10px; border:1px solid rgba(79, 124, 255, 0.3); word-break: break-all;"></div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:25px;">
                <button id="adminBtn" class="danger" onclick="toggleAdmin()" style="display:none;">üëë Admin</button>
                <div style="display:flex; gap:10px;">
                    <button onclick="toggleFeedbackUI(true)" style="background:linear-gradient(135deg, #8a2be2, #4f7cff);">üí¨ Feedback</button>
                    <button onclick="logout()" style="background:rgba(255,255,255,0.05); border:1px solid var(--border);">üö™ Logout</button>
                </div>
            </div>
            
            <input id="adminInput" type="password" placeholder="Enter Admin Password" style="margin-top:15px;">
        </div>
    </div>

    <!-- Chat Toggle -->
    <div id="chat-toggle" onclick="toggleChat(true)">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
        <div id="unread-badge" class="hidden">0</div>
    </div>

    <!-- Chat Window -->
    <div id="chat-window" class="hidden">
        <div class="back-btn-container">
            <button onclick="toggleChat(false)" class="mini danger" style="background:rgba(255,59,48,0.2); border:1px solid var(--danger);">‚Üê BACK</button>
        </div>
        
        <div class="chat-header">
            <div class="chat-header-title">NETWORK CHAT</div>
            <div class="chat-header-stats">
                <span><span class="stats-icon">üë§</span> <span id="chatOnlineCount">0</span></span>
                <span><span class="stats-icon">üí¨</span> <span id="chatMessageCount">0</span></span>
            </div>
        </div>
        
        <div id="pinned-area" class="hidden">
            <span class="pin-icon">üìå</span>
            <span class="pin-text" id="pinnedText"></span>
        </div>
        
        <div id="chat-msgs"></div>
        
        <!-- Typing Indicator -->
        <div id="typingIndicator" class="typing-indicator hidden">
            <span id="typingUsers"></span>
            <span class="typing-dots">
                <span>.</span><span>.</span><span>.</span>
            </span>
        </div>
        
        <!-- Input Area -->
        <div class="chat-input-area">
            <div id="reply-preview" class="reply-preview hidden">
                <span class="reply-preview-text" id="replyPreviewText"></span>
                <span class="cancel-reply" onclick="cancelReply()">‚úï</span>
            </div>
            
            <div class="chat-input-row">
                <textarea id="chat-input" placeholder="Type a message..." rows="1"></textarea>
                <button id="send-chat-btn" onclick="sendChat()">SEND</button>
            </div>
        </div>
    </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="adminFull hidden">
    <!-- Default Admin View -->
    <div id="adminDefaultView">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding:20px; background:rgba(255,255,255,0.03); border-radius:12px;">
            <div>
                <h2 style="margin:0; font-size:24px;" class="gradient-text">üëë ADMIN CONTROL PANEL</h2>
                <p style="font-size:11px; opacity:0.7; margin-top:5px;">Welcome back, plstealme2 | Full System Access</p>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="success" onclick="showGameCreateView()" style="width:auto; margin:0; padding:10px 20px;">
                    üéÆ Create Game
                </button>
                <button class="danger" onclick="showBanNowModal()" style="width:auto; margin:0; padding:10px 20px;">
                    ‚ö° BAN NOW
                </button>
                <button class="warning" onclick="openAdminFeedbacks()" style="width:auto; margin:0; padding:10px 20px;">
                    üì© Feedbacks
                </button>
                <button onclick="closeAdmin()" style="width:auto; margin:0; background:#444; padding:10px 20px;">
                    üö™ Exit Admin
                </button>
            </div>
        </div>

        <!-- Games Dashboard -->
        <div class="game-management-section">
            <div class="dashboard-header">
                <h3>üéÆ Game Management</h3>
                <div class="dashboard-stats">
                    <span><span class="stats-icon">üìÅ</span> <span id="totalGames">0 games</span></span>
                    <span><span class="stats-icon">üìú</span> <span id="totalScripts">0 scripts</span></span>
                </div>
            </div>
            
            <div id="gamesDashboard" class="games-dashboard">
                <div style="text-align:center; padding:40px; color:rgba(255,255,255,0.5); grid-column:1/-1;">
                    Loading games database...
                </div>
            </div>
            
            <div id="noGamesMessage" class="hidden" style="text-align:center; padding:40px; color:rgba(255,255,255,0.5);">
                <div style="font-size:48px; margin-bottom:15px; opacity:0.3;">üéÆ</div>
                <p>No games created yet. Create your first game to get started!</p>
                <button class="success" onclick="showGameCreateView()" style="width:auto; margin:20px 0 0; padding:10px 25px;">
                    üéÆ Create First Game
                </button>
            </div>
        </div>

        <!-- Broadcast & Chat Controls -->
        <div class="game-management-section">
            <h3 style="margin-top:0; display:flex; align-items:center; gap:10px;">üî® Broadcast & Chat Controls</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div>
                    <input id="globalMsgInput" placeholder="Broadcast Text" style="margin:0;">
                    <p style="font-size:10px; opacity:0.7; margin-top:5px;">Maximum 200 characters</p>
                </div>
                <div style="display:flex; gap:10px; align-items:flex-start;">
                    <button class="warning" onclick="sendGlobalMsg(true)" style="margin:0; flex:1; padding:12px;">üìå PIN LIVE</button>
                    <button class="warning" onclick="sendGlobalMsg(false)" style="margin:0; flex:1; padding:12px;">üì¢ ANNOUNCE</button>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                <button class="danger" onclick="clearGlobals()" style="padding:12px;">üßπ PURGE GLOBALS</button>
                <button class="danger" onclick="clearAllChat()" style="padding:12px;">üí• WIPE CHAT</button>
            </div>
        </div>

        <!-- Global Access Control -->
        <div class="game-management-section" style="border-color:var(--danger); background:linear-gradient(145deg, rgba(255,59,48,0.1), rgba(255,59,48,0.05));">
            <h3 style="margin-top:0; color:var(--danger); display:flex; align-items:center; gap:10px;">‚ö†Ô∏è GLOBAL ACCESS CONTROL</h3>
            <p style="font-size:11px; opacity:0.8; margin-top:-5px; margin-bottom:15px;">Warning: These actions affect all users system-wide.</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <button class="danger" onclick="banAllKeyHolders()" style="margin:0; padding:12px;">‚õî BAN ALL KEY HOLDERS</button>
                <button class="success" onclick="unbanEveryone()" style="margin:0; padding:12px;">‚úÖ UNBAN ALL USERS</button>
            </div>
        </div>

        <!-- System Reset -->
        <div class="game-management-section" style="border-color:var(--danger);">
            <h3 style="margin-top:0; color:var(--danger); display:flex; align-items:center; gap:10px;">‚ò¢Ô∏è SYSTEM RESET</h3>
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px; align-items:center;">
                <div>
                    <select id="resetTarget" style="margin:0; padding:12px; width:100%;">
                        <option value="chat">üóëÔ∏è Clear Chat History Only</option>
                        <option value="bans">üö´ Clear All Blacklists (Bans)</option>
                        <option value="users">üë• Clear All User Accounts</option>
                        <option value="all">üí£ FACTORY RESET (Wipe Everything)</option>
                    </select>
                    <p style="font-size:10px; opacity:0.7; margin-top:5px;">Select reset target</p>
                </div>
                <button class="danger" onclick="masterReset()" style="margin:0; padding:12px;">üöÄ EXECUTE</button>
            </div>
        </div>

        <!-- Blacklist and Keys -->
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
            <div class="game-management-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0;">üö´ Active Blacklist</h3>
                    <span style="font-size:10px; opacity:0.7;" id="banCount">0 banned</span>
                </div>
                <div id="banLogs" class="log-box" style="height:250px;"></div>
            </div>
            <div class="game-management-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0;">üîë System Keys</h3>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <span style="font-size:10px; opacity:0.7;" id="keyCount">0 keys</span>
                        <button class="mini" onclick="renderAdminKeys()" style="padding:4px 8px;">üîÑ</button>
                    </div>
                </div>
                <div id="keyLogs" class="log-box" style="height:250px;"></div>
            </div>
        </div>
    </div>

    <!-- Game Creation View -->
    <div id="gameCreateView" class="hidden">
        <div class="back-nav" onclick="showGamesDashboard()">
            <span class="icon">‚Üê</span>
            <span>Back to Dashboard</span>
        </div>
        
        <div class="game-create-container">
            <h2 style="margin-top:0; text-align:center; margin-bottom:25px;">üéÆ Create New Game</h2>
            
            <!-- Image Preview -->
            <div class="image-preview-container" onclick="document.getElementById('gameImageInput').click()">
                <img id="gameImagePreview" class="image-preview" alt="Game Image">
                <div class="image-placeholder" id="imagePlaceholder">
                    <span class="icon">üìÅ</span>
                    Click to upload image
                    <br>
                    <small style="font-size:10px;">Max 2MB ‚Ä¢ JPG, PNG, GIF</small>
                </div>
            </div>
            
            <input type="file" id="gameImageInput" accept="image/*" class="hidden">
            
            <!-- Game Name -->
            <div style="margin: 20px 0;">
                <label style="font-size:12px; opacity:0.8; margin-bottom:5px; display:block;">Game Name</label>
                <input type="text" id="gameNameInput" placeholder="Enter game name" maxlength="50">
            </div>
            
            <!-- Game ID -->
            <div style="margin: 20px 0;">
                <label style="font-size:12px; opacity:0.8; margin-bottom:5px; display:block;">Roblox Game ID</label>
                <input type="text" id="gameIdInput" placeholder="Enter Roblox Place ID" pattern="\d+" maxlength="10">
                <p style="font-size:10px; opacity:0.7; margin-top:5px;">Enter the numeric Place ID from Roblox</p>
            </div>
            
            <!-- Create Button -->
            <button class="success" onclick="createGame()" style="margin-top:25px;">
                <span>üéÆ Create Game</span>
            </button>
            
            <div id="gameCreateStatus" style="text-align:center; margin-top:15px; font-size:12px; color:var(--danger); min-height:18px;"></div>
        </div>
    </div>

    <!-- Script Management View -->
    <div id="scriptManagementView" class="hidden">
        <div class="back-nav" onclick="showGamesDashboard()">
            <span class="icon">‚Üê</span>
            <span>Back to Dashboard</span>
        </div>
        
        <div id="currentGameInfo" class="current-game-header">
            <img id="currentGameImage" class="current-game-image" src="" alt="Game Image">
            <div class="current-game-info">
                <h3 id="currentGameName">Game Name</h3>
                <p id="currentGameId">ID: 000000</p>
            </div>
        </div>
        
        <div class="script-management-view">
            <div class="script-management-section">
                <h3>üìú Current Scripts</h3>
                <div id="scriptsList" class="scripts-list">
                    <!-- Scripts will be loaded here -->
                </div>
                
                <div class="add-script-form">
                    <h4>‚ûï Add New Script</h4>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size:12px; opacity:0.8; margin-bottom:5px; display:block;">Script Name</label>
                        <input type="text" id="newScriptName" placeholder="Enter script name (e.g., Auto Farm, ESP, etc.)">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="font-size:12px; opacity:0.8; margin-bottom:5px; display:block;">Script URL</label>
                        <textarea id="newScriptUrl" placeholder="Paste raw script URL (must start with http:// or https://)" rows="3"></textarea>
                    </div>
                    <button class="success" onclick="addScriptToGame()" style="margin:0;">
                        <span>‚ûï Add Script</span>
                    </button>
                    <div id="addScriptStatus" style="text-align:center; margin-top:10px; font-size:12px; color:var(--danger);"></div>
                </div>
            </div>
            
            <div style="display:flex; gap:15px; margin-top:30px;">
                <button onclick="showGamesDashboard()" style="flex:1; background:#444;">‚Üê Back to Games</button>
                <button class="danger" onclick="deleteCurrentGame()" style="flex:1;">üóëÔ∏è Delete Game</button>
            </div>
        </div>
    </div>
</div>

<!-- Ban Now Modal -->
<div id="banNowModal" class="modal-overlay hidden">
    <div class="ban-modal-content">
        <div style="text-align:center; margin-bottom:25px;">
            <h2 style="color:var(--danger); margin:0; font-size:24px;" class="gradient-text">üî® RESTRICT USER</h2>
            <p style="font-size:11px; opacity:0.7; margin-top:5px;">Immediate action required</p>
        </div>
        
        <input id="focusBanId" placeholder="Roblox UserID" style="margin-bottom:15px;">
        <input id="focusBanUser" placeholder="Username to Ban" style="margin-bottom:15px;">
        
        <div style="position:relative;">
            <textarea id="focusBanReason" placeholder="Reason for restriction..." style="height:100px; resize:none; margin-bottom:20px;"></textarea>
            <div style="position:absolute; right:12px; bottom:30px; font-size:10px; opacity:0.5;" id="reasonCharCount">0/200</div>
        </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <button class="danger" onclick="executeFocusBan()" style="padding:12px;">‚ö° BAN USER</button>
            <button onclick="hideBanNowModal()" style="background:#444; padding:12px;">‚Ü©Ô∏è CANCEL</button>
        </div>
    </div>
</div>

<!-- Feedback Management Modal -->
<div id="feedbackModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;" class="gradient-text">üì© USER FEEDBACKS</h2>
            <button onclick="hideFeedbackModal()" style="width:auto; margin:0; background:#444; padding:10px 20px;">‚úï Close</button>
        </div>
        
        <div style="position:relative; margin-bottom:15px;">
            <input id="fbSearch" placeholder="Search UserID or Username..." oninput="renderAdminFeedbacks()" style="padding:12px; font-size:13px;">
            <div style="position:absolute; right:12px; top:50%; transform:translateY(-50%); opacity:0.5;">üîç</div>
        </div>
        
        <div id="fbLogs" class="log-box" style="height: 400px;"></div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyAupBkllyicDPD9O6CmX4mS4sF5z96mqxc",
    authDomain: "vertexpaste.firebaseapp.com",
    projectId: "vertexpaste",
    storageBucket: "vertexpaste.firebasestorage.app",
    messagingSenderId: "255275350380",
    appId: "1:255275350380:web:7be4e8add2cb5b04045b49"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const storage = firebase.storage();

// Enable offline persistence
db.enablePersistence().catch((err) => {
    if (err.code == 'failed-precondition') {
        console.log('Multiple tabs open, persistence enabled in first tab only');
    } else if (err.code == 'unimplemented') {
        console.log('Browser doesn\'t support persistence');
    }
});

// Global variables
let dataCache = null;
let lastFetchTime = 0;
const CACHE_TTL = 30000; // 30 seconds
let isAdminAuthenticated = false;
let currentUser = null;
const ADMIN_USERNAME = 'plstealme2';
const ADMIN_PASSWORD = 'Livetopimo';
let currentGameIndex = -1;
let lastSeenMessageTime = 0;
let unreadCount = 0;
let chatUnreadCount = 0;
let userKeys = {};

// Notifications array
let notifications = [];
let notificationListeners = [];

// Initialize database with default structure
async function initializeDatabase() {
    showLoading('Initializing database...');
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        
        if (!doc.exists) {
            // Create initial database structure
            const initialData = {
                users: {},
                keys: {},
                games: [],
                bans: {},
                feedbacks: [],
                chats: [],
                pinned: null,
                admins: {
                    [ADMIN_USERNAME]: {
                        password: ADMIN_PASSWORD,
                        created: Date.now(),
                        role: 'SUPER_ADMIN'
                    }
                },
                settings: {
                    version: '2.0',
                    created: Date.now(),
                    last_updated: Date.now()
                }
            };
            
            await docRef.set(initialData);
            dataCache = initialData;
            addNotification('System', '‚úÖ New database created with Firebase', 'success');
        } else {
            dataCache = doc.data();
        }
        
        // Set up real-time listeners
        setupRealtimeListeners();
        
        hideLoading();
        return true;
    } catch (error) {
        console.error('Database initialization failed:', error);
        if (isAdmin()) {
            showToast('‚ùå Failed to initialize database', 'error');
        }
        hideLoading();
        return false;
    }
}

// Check if current user is admin
function isAdmin() {
    return currentUser?.username === ADMIN_USERNAME;
}

// Add notification
function addNotification(title, message, type = 'info', data = null) {
    const notification = {
        id: Date.now() + Math.random(),
        title: title,
        message: message,
        type: type,
        timestamp: Date.now(),
        read: false,
        data: data
    };
    
    notifications.unshift(notification);
    
    // Keep only last 50 notifications
    if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
    }
    
    // Update badge
    updateNotificationBadge();
    
    // Show floating notification for all users
    showFloatingNotification(notification);
    
    // Trigger listeners
    notificationListeners.forEach(listener => listener(notifications));
    
    return notification;
}

// Show floating notification
function showFloatingNotification(notification) {
    const floating = document.createElement('div');
    floating.className = 'floating-notification';
    floating.onclick = () => {
        toggleNotificationCenter();
        markNotificationRead(notification.id);
        floating.remove();
    };
    
    floating.innerHTML = `
        <div class="title">${notification.title}</div>
        <div class="message">${notification.message}</div>
    `;
    
    document.body.appendChild(floating);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (floating.parentNode) {
            floating.remove();
        }
    }, 5000);
}

// Update notification badge
function updateNotificationBadge() {
    const badge = document.getElementById('notificationBadge');
    const unreadCount = notifications.filter(n => !n.read).length;
    
    if (badge) {
        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
}

// Toggle notification center
function toggleNotificationCenter() {
    const center = document.getElementById('notificationCenter');
    if (center) {
        center.classList.toggle('hidden');
        if (!center.classList.contains('hidden')) {
            renderNotifications();
        }
    }
}

// Render notifications
function renderNotifications() {
    const list = document.getElementById('notificationsList');
    if (!list) return;
    
    if (notifications.length === 0) {
        list.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üîî</div>
                <div>No notifications</div>
            </div>
        `;
        return;
    }
    
    const notificationsHtml = notifications.map(notif => {
        const time = new Date(notif.timestamp).toLocaleTimeString();
        const unreadClass = notif.read ? '' : 'unread';
        
        return `
            <div class="notification-item ${unreadClass}" onclick="markNotificationRead(${notif.id})">
                <div class="notification-title">
                    <span>${notif.title}</span>
                    ${!notif.read ? '<span style="color: var(--notification);">‚óè</span>' : ''}
                </div>
                <div class="notification-message">${notif.message}</div>
                <div class="notification-time">${time}</div>
            </div>
        `;
    }).join('');
    
    list.innerHTML = notificationsHtml;
}

// Mark notification as read
function markNotificationRead(id) {
    const notification = notifications.find(n => n.id === id);
    if (notification) {
        notification.read = true;
        renderNotifications();
        updateNotificationBadge();
    }
}

// Mark all notifications as read
function markAllNotificationsRead() {
    notifications.forEach(n => n.read = true);
    renderNotifications();
    updateNotificationBadge();
}

// Set up real-time Firestore listeners
function setupRealtimeListeners() {
    // Listen for chat changes
    db.collection('system').doc('config')
        .onSnapshot((doc) => {
            if (doc.exists) {
                const oldData = dataCache;
                dataCache = doc.data();
                lastFetchTime = Date.now();
                updateConnectionStatus(true);
                
                // Check for new messages
                if (oldData && oldData.chats && dataCache.chats) {
                    const lastMessage = oldData.chats[oldData.chats.length - 1];
                    const newMessages = dataCache.chats.filter(msg => 
                        msg.timestamp > (lastMessage?.timestamp || 0) &&
                        msg.user !== 'SYSTEM' &&
                        msg.user !== getUserIdentifier()
                    );
                    
                    if (newMessages.length > 0) {
                        newMessages.forEach(msg => {
                            addNotification(
                                'üí¨ New Message',
                                `${msg.user}: ${msg.txt.substring(0, 50)}${msg.txt.length > 50 ? '...' : ''}`,
                                'chat',
                                msg
                            );
                        });
                        
                        // Update chat unread count
                        if (!document.getElementById('chat-window').classList.contains('hidden')) {
                            chatUnreadCount = 0;
                        } else {
                            chatUnreadCount += newMessages.length;
                        }
                        updateUnreadBadge();
                    }
                }
                
                updateChat();
                if (isAdmin()) {
                    renderAdminKeys();
                    renderAdminBans();
                    loadGamesDashboard();
                }
            }
        }, (error) => {
            console.error('Firestore listener error:', error);
            updateConnectionStatus(false);
            if (isAdmin()) {
                showToast('‚ö†Ô∏è Connection issues. Using cached data.', 'warning');
            }
        });
}

// Update unread badge
function updateUnreadBadge() {
    const badge = document.getElementById('unread-badge');
    if (badge) {
        if (chatUnreadCount > 0) {
            badge.textContent = chatUnreadCount;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
}

// Update connection status
function updateConnectionStatus(isConnected) {
    const statusEl = document.getElementById('connectionStatus');
    if (!statusEl) return;
    
    if (isConnected) {
        statusEl.className = 'connection-status connected';
        statusEl.innerHTML = '<div class="status-dot"></div><span>Connected</span>';
    } else {
        statusEl.className = 'connection-status disconnected';
        statusEl.innerHTML = '<div class="status-dot"></div><span>Disconnected</span>';
        if (isAdmin()) {
            addNotification('‚ö†Ô∏è Connection Lost', 'Reconnecting to server...', 'warning');
        }
    }
}

// Show loading overlay
function showLoading(text = 'Loading...') {
    const overlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    if (overlay && loadingText) {
        loadingText.textContent = text;
        overlay.classList.remove('hidden');
    }
}

// Hide loading overlay
function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.classList.add('hidden');
    }
}

// Show toast notification (admin only)
function showToast(message, type = 'info', duration = 3000) {
    if (!isAdmin()) return; // Only show toasts for admin
    
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

// Moderate message content
function moderate(text) {
    if (!text) return false;
    const blockedWords = ['badword1', 'badword2'];
    const lowerText = text.toLowerCase();
    for (const word of blockedWords) {
        if (lowerText.includes(word)) return true;
    }
    return false;
}

// Get user identifier
function getUserIdentifier() {
    return currentUser?.username || 'anonymous';
}

// Handle authentication
async function handleAuth(action) {
    const spinnerId = action === 'login' ? 'loginSpinner' : 'signupSpinner';
    const spinner = document.getElementById(spinnerId);
    const authStatus = document.getElementById('authStatus');
    
    if (spinner) spinner.style.display = 'inline-block';
    if (authStatus) authStatus.textContent = '';
    
    let username, password;
    
    if (action === 'login') {
        username = document.getElementById('l-user').value.trim();
        password = document.getElementById('l-pass').value.trim();
    } else {
        username = document.getElementById('s-user').value.trim();
        password = document.getElementById('s-pass').value.trim();
        
        if (username.length < 3) {
            authStatus.textContent = 'Username must be at least 3 characters';
            authStatus.style.color = 'var(--danger)';
            if (spinner) spinner.style.display = 'none';
            return;
        }
        
        if (password.length < 4) {
            authStatus.textContent = 'Password must be at least 4 characters';
            authStatus.style.color = 'var(--danger)';
            if (spinner) spinner.style.display = 'none';
            return;
        }
    }
    
    if (!username || !password) {
        authStatus.textContent = 'Please fill in all fields';
        authStatus.style.color = 'var(--danger)';
        if (spinner) spinner.style.display = 'none';
        return;
    }
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        if (!data.users) data.users = {};
        
        if (action === 'signup') {
            if (data.users[username]) {
                authStatus.textContent = 'Username already exists';
                authStatus.style.color = 'var(--danger)';
                if (spinner) spinner.style.display = 'none';
                return;
            }
            
            data.users[username] = {
                password: password,
                created: Date.now(),
                role: username === ADMIN_USERNAME ? 'SUPER_ADMIN' : 'user'
            };
            
            await docRef.update({ users: data.users });
            authStatus.textContent = 'Account created! Please login.';
            authStatus.style.color = 'var(--success)';
            toggleAuth(false);
            addNotification('Welcome!', 'Account created successfully. Please login.', 'success');
        } else {
            const user = data.users[username];
            
            if (!user || user.password !== password) {
                authStatus.textContent = 'Invalid username or password';
                authStatus.style.color = 'var(--danger)';
                if (spinner) spinner.style.display = 'none';
                return;
            }
            
            currentUser = {
                username: username,
                role: user.role || 'user'
            };
            
            localStorage.setItem('RSQ_CURRENT_USER', JSON.stringify(currentUser));
            
            if (username === ADMIN_USERNAME) {
                const adminInput = document.getElementById('adminInput');
                if (adminInput) adminInput.value = ADMIN_PASSWORD;
            }
            
            document.getElementById('authPanel').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            
            const welcomeEl = document.getElementById('welcomeUser');
            if (welcomeEl) welcomeEl.textContent = 'Logged in as: ' + username;
            
            const adminBtn = document.getElementById('adminBtn');
            if (adminBtn) {
                adminBtn.style.display = username === ADMIN_USERNAME ? 'block' : 'none';
            }
            
            addNotification('Welcome!', 'Logged in as ' + username, 'success');
        }
    } catch (error) {
        console.error('Auth error:', error);
        authStatus.textContent = 'Error: ' + error.message;
        authStatus.style.color = 'var(--danger)';
        if (isAdmin()) {
            showToast('Authentication failed', 'error');
        }
        addNotification('‚ùå Auth Error', error.message, 'error');
    } finally {
        if (spinner) spinner.style.display = 'none';
    }
}

// Toggle between login and signup views
function toggleAuth(showSignup) {
    const loginView = document.getElementById('loginView');
    const signupView = document.getElementById('signupView');
    const authStatus = document.getElementById('authStatus');
    
    if (authStatus) authStatus.textContent = '';
    
    if (showSignup) {
        loginView.classList.add('hidden');
        signupView.classList.remove('hidden');
    } else {
        signupView.classList.add('hidden');
        loginView.classList.remove('hidden');
    }
}

// Generate access key
async function generateKey() {
    if (!currentUser) {
        addNotification('‚ùå Access Denied', 'Please login first', 'error');
        return;
    }
    
    const userIdInput = document.getElementById('userid');
    const statusEl = document.getElementById('statusMsg');
    const keyOut = document.getElementById('keyOut');
    const spinner = document.getElementById('keySpinner');
    
    if (!userIdInput || !statusEl || !keyOut) return;
    
    const userId = userIdInput.value.trim();
    
    if (!userId) {
        statusEl.textContent = 'Please enter a Roblox UserID';
        statusEl.style.color = 'var(--danger)';
        return;
    }
    
    if (!/^\d+$/.test(userId)) {
        statusEl.textContent = 'Invalid UserID. Must be numeric';
        statusEl.style.color = 'var(--danger)';
        return;
    }
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        const keys = data.keys || {};
        
        // Check if user already has a key
        const existingKey = Object.entries(keys).find(([_, keyData]) => 
            String(keyData.rbx) === String(userId)
        );
        
        if (existingKey) {
            const [keyId, keyData] = existingKey;
            const timeSinceCreation = Date.now() - keyData.created;
            const hoursSinceCreation = timeSinceCreation / (1000 * 60 * 60);
            
            if (keyData.generatedBy === currentUser.username) {
                if (hoursSinceCreation < 24) {
                    const hoursLeft = Math.ceil(24 - hoursSinceCreation);
                    statusEl.innerHTML = `
                        <span style="color: var(--warning);">
                            ‚è≥ You can generate a new key for this UserID in ${hoursLeft} hours ${Math.ceil(24 * 60 - hoursSinceCreation * 60)} minutes
                        </span>
                    `;
                    keyOut.textContent = keyId;
                    return;
                }
            } else {
                statusEl.textContent = '‚ùå This UserID already has a key (generated by ' + keyData.generatedBy + ')';
                statusEl.style.color = 'var(--danger)';
                keyOut.textContent = keyId;
                return;
            }
        }
        
        if (spinner) spinner.style.display = 'inline-block';
        statusEl.textContent = 'Generating key...';
        
        // Generate random key
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
        let newKey = '';
        for (let i = 0; i < 16; i++) {
            newKey += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        
        // Save to Firestore
        keys[newKey] = {
            rbx: parseInt(userId, 10),
            exp: 'INF',
            created: Date.now(),
            generatedBy: currentUser.username,
            userRole: currentUser.role,
            originalUserId: userId
        };
        
        await docRef.update({ keys: keys });
        
        keyOut.textContent = newKey;
        statusEl.textContent = '‚úÖ Key generated successfully!';
        statusEl.style.color = 'var(--success)';
        userIdInput.value = '';
        
        addNotification('üîë Key Generated', `New access key created for UserID ${userId}`, 'success');
        
    } catch (error) {
        console.error('Error generating key:', error);
        statusEl.textContent = '‚ùå Failed to generate key';
        statusEl.style.color = 'var(--danger)';
        addNotification('‚ùå Key Generation Failed', error.message, 'error');
    } finally {
        if (spinner) spinner.style.display = 'none';
    }
}

// Check session on load
function checkSession() {
    const saved = localStorage.getItem('RSQ_CURRENT_USER');
    if (saved) {
        try {
            currentUser = JSON.parse(saved);
            document.getElementById('authPanel').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            
            const welcomeEl = document.getElementById('welcomeUser');
            if (welcomeEl) welcomeEl.textContent = 'Logged in as: ' + currentUser.username;
            
            const adminBtn = document.getElementById('adminBtn');
            if (adminBtn) {
                adminBtn.style.display = currentUser.username === ADMIN_USERNAME ? 'block' : 'none';
            }
            
            if (currentUser.username === ADMIN_USERNAME) {
                const adminInput = document.getElementById('adminInput');
                if (adminInput) adminInput.value = ADMIN_PASSWORD;
            }
            
            addNotification('Welcome Back!', 'Session restored for ' + currentUser.username, 'info');
        } catch (e) {
            console.error('Session restore error:', e);
            localStorage.removeItem('RSQ_CURRENT_USER');
        }
    }
}

// Logout function
function logout() {
    if (confirm('Logout from the system?')) {
        currentUser = null;
        localStorage.removeItem('RSQ_CURRENT_USER');
        
        document.getElementById('mainSystem').classList.add('hidden');
        document.getElementById('authPanel').classList.remove('hidden');
        
        // Clear inputs
        document.getElementById('l-user').value = '';
        document.getElementById('l-pass').value = '';
        document.getElementById('s-user').value = '';
        document.getElementById('s-pass').value = '';
        document.getElementById('authStatus').textContent = '';
        
        toggleAuth(false);
        
        const adminInput = document.getElementById('adminInput');
        if (adminInput) {
            adminInput.style.display = 'block';
            adminInput.value = '';
        }
        
        const keyOut = document.getElementById('keyOut');
        if (keyOut) keyOut.textContent = '';
        
        const statusMsg = document.getElementById('statusMsg');
        if (statusMsg) statusMsg.textContent = '';
        
        addNotification('üëã Goodbye!', 'Logged out successfully', 'info');
    }
}

// Toggle admin panel
function toggleAdmin() {
    if (!currentUser || currentUser.username !== ADMIN_USERNAME) {
        addNotification('‚ùå Access Denied', 'Admin access required', 'error');
        return;
    }
    
    const adminInput = document.getElementById('adminInput');
    const password = adminInput.value.trim();
    
    if (password === ADMIN_PASSWORD) {
        isAdminAuthenticated = true;
        adminInput.style.display = 'none';
        addNotification('üëë Admin Access', 'Admin panel unlocked', 'success');
        openAdminPanel();
    } else {
        addNotification('‚ùå Access Denied', 'Invalid admin password', 'error');
        adminInput.value = '';
        adminInput.focus();
    }
}

// Open admin panel
function openAdminPanel() {
    if (!isAdminAuthenticated) {
        addNotification('‚ùå Access Denied', 'Admin authentication required', 'error');
        return;
    }
    
    const mainSystem = document.getElementById('mainSystem');
    if (mainSystem) mainSystem.classList.add('hidden');
    
    const adminPanel = document.getElementById('adminPanel');
    if (adminPanel) {
        adminPanel.classList.remove('hidden');
        document.getElementById('adminDefaultView').classList.remove('hidden');
        document.getElementById('gameCreateView').classList.add('hidden');
        document.getElementById('scriptManagementView').classList.add('hidden');
        
        loadGamesDashboard();
        renderAdminKeys();
        renderAdminBans();
        
        addNotification('üëë Admin Panel', 'Admin panel loaded successfully', 'success');
    }
}

// Close admin panel
function closeAdmin() {
    const adminPanel = document.getElementById('adminPanel');
    if (adminPanel) adminPanel.classList.add('hidden');
    
    const mainSystem = document.getElementById('mainSystem');
    if (mainSystem) mainSystem.classList.remove('hidden');
    
    const adminInput = document.getElementById('adminInput');
    if (adminInput) {
        adminInput.style.display = 'block';
        adminInput.value = '';
    }
    
    isAdminAuthenticated = false;
    addNotification('üëã Admin Panel', 'Exited admin panel', 'info');
}

// Show game creation view
function showGameCreateView() {
    document.getElementById('adminDefaultView').classList.add('hidden');
    document.getElementById('gameCreateView').classList.remove('hidden');
    document.getElementById('scriptManagementView').classList.add('hidden');
    
    document.getElementById('gameNameInput').value = '';
    document.getElementById('gameIdInput').value = '';
    document.getElementById('gameImagePreview').style.display = 'none';
    document.getElementById('imagePlaceholder').style.display = 'block';
    document.getElementById('gameCreateStatus').textContent = '';
}

// Show games dashboard
function showGamesDashboard() {
    document.getElementById('gameCreateView').classList.add('hidden');
    document.getElementById('scriptManagementView').classList.add('hidden');
    document.getElementById('adminDefaultView').classList.remove('hidden');
    loadGamesDashboard();
}

// Open game scripts management
function openGameScripts(index) {
    currentGameIndex = index;
    
    if (!dataCache || !dataCache.games || !dataCache.games[index]) {
        addNotification('‚ùå Error', 'Game not found', 'error');
        return;
    }
    
    const game = dataCache.games[index];
    
    document.getElementById('adminDefaultView').classList.add('hidden');
    document.getElementById('gameCreateView').classList.add('hidden');
    document.getElementById('scriptManagementView').classList.remove('hidden');
    
    document.getElementById('currentGameName').textContent = game.name;
    document.getElementById('currentGameId').textContent = 'ID: ' + game.id;
    
    const gameImage = document.getElementById('currentGameImage');
    if (game.image) {
        gameImage.src = game.image;
        gameImage.style.display = 'block';
    } else {
        gameImage.style.display = 'none';
    }
    
    renderGameScripts();
}

// Load games dashboard
async function loadGamesDashboard() {
    try {
        if (!dataCache) return;
        
        const games = dataCache.games || [];
        const dashboard = document.getElementById('gamesDashboard');
        const noGamesMsg = document.getElementById('noGamesMessage');
        const totalGamesEl = document.getElementById('totalGames');
        const totalScriptsEl = document.getElementById('totalScripts');
        
        if (totalGamesEl) {
            totalGamesEl.textContent = games.length + ' game' + (games.length !== 1 ? 's' : '');
        }
        
        let scriptCount = 0;
        games.forEach(game => {
            scriptCount += (game.scripts || []).length;
        });
        
        if (totalScriptsEl) {
            totalScriptsEl.textContent = scriptCount + ' script' + (scriptCount !== 1 ? 's' : '');
        }
        
        if (games.length === 0) {
            if (dashboard) dashboard.innerHTML = '';
            if (noGamesMsg) noGamesMsg.classList.remove('hidden');
            return;
        }
        
        if (noGamesMsg) noGamesMsg.classList.add('hidden');
        
        const gamesHtml = games.map((game, index) => {
            const scriptCount = (game.scripts || []).length;
            return `
                <div class="game-card" onclick="openGameScripts(${index})">
                    ${game.image ? '<img src="' + game.image + '" class="game-card-image" alt="' + game.name + '">' : '<div class="game-card-image"></div>'}
                    <div class="game-card-title">${game.name}</div>
                    <div class="game-card-id">ID: ${game.id}</div>
                    <div class="game-card-scripts">${scriptCount} script${scriptCount !== 1 ? 's' : ''}</div>
                    <div class="game-actions">
                        <button class="game-action-btn delete" onclick="event.stopPropagation(); deleteGame(${index})" title="Delete Game">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }).join('');
        
        if (dashboard) dashboard.innerHTML = gamesHtml;
        
    } catch (error) {
        console.error('Error loading games dashboard:', error);
        addNotification('‚ùå Error', 'Failed to load games', 'error');
    }
}

// Create new game
async function createGame() {
    const gameName = document.getElementById('gameNameInput').value.trim();
    const gameId = document.getElementById('gameIdInput').value.trim();
    const statusEl = document.getElementById('gameCreateStatus');
    
    if (!gameName || !gameId) {
        if (statusEl) {
            statusEl.textContent = 'Please fill in all fields';
            statusEl.style.color = 'var(--danger)';
        }
        return;
    }
    
    if (!/^\d+$/.test(gameId)) {
        if (statusEl) {
            statusEl.textContent = 'Game ID must be numeric';
            statusEl.style.color = 'var(--danger)';
        }
        return;
    }
    
    showLoading('Creating game...');
    if (statusEl) statusEl.textContent = '';
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        // Check if game ID already exists
        if (data.games?.some(g => g.id === gameId)) {
            throw new Error('Game with this ID already exists');
        }
        
        // Handle image upload if present
        const imageInput = document.getElementById('gameImageInput');
        let imageData = '';
        
        if (imageInput.files && imageInput.files[0]) {
            const file = imageInput.files[0];
            if (file.size > 2 * 1024 * 1024) {
                throw new Error('Image must be less than 2MB');
            }
            
            // Convert to base64 for storage (Firestore has 1MB document limit)
            imageData = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        const newGame = {
            id: gameId,
            name: gameName,
            image: imageData,
            scripts: [],
            created: Date.now(),
            createdBy: getUserIdentifier()
        };
        
        if (!data.games) data.games = [];
        data.games.push(newGame);
        data.settings.last_updated = Date.now();
        
        await docRef.update({
            games: data.games,
            settings: data.settings
        });
        
        // Clear form
        document.getElementById('gameNameInput').value = '';
        document.getElementById('gameIdInput').value = '';
        document.getElementById('gameImagePreview').style.display = 'none';
        document.getElementById('imagePlaceholder').style.display = 'block';
        imageInput.value = '';
        
        if (statusEl) {
            statusEl.textContent = '‚úÖ Game created successfully!';
            statusEl.style.color = 'var(--success)';
        }
        
        addNotification('üéÆ Game Created', `New game "${gameName}" added to database`, 'success');
        
        setTimeout(() => {
            showGamesDashboard();
        }, 1500);
        
    } catch (error) {
        console.error('Error creating game:', error);
        if (statusEl) {
            statusEl.textContent = error.message || 'Failed to create game';
            statusEl.style.color = 'var(--danger)';
        }
        addNotification('‚ùå Error', error.message || 'Failed to create game', 'error');
    } finally {
        hideLoading();
    }
}

// Delete game
async function deleteGame(index) {
    if (!confirm('Delete this game and all its scripts? This action cannot be undone.')) return;
    
    showLoading('Deleting game...');
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        if (!data.games || !data.games[index]) {
            throw new Error('Game not found');
        }
        
        const gameName = data.games[index].name;
        data.games.splice(index, 1);
        data.settings.last_updated = Date.now();
        
        await docRef.update({
            games: data.games,
            settings: data.settings
        });
        
        addNotification('üóëÔ∏è Game Deleted', `Game "${gameName}" was removed`, 'warning');
        loadGamesDashboard();
        
    } catch (error) {
        console.error('Error deleting game:', error);
        addNotification('‚ùå Error', error.message || 'Failed to delete game', 'error');
    } finally {
        hideLoading();
    }
}

// Render game scripts
async function renderGameScripts() {
    if (currentGameIndex === -1) return;
    
    try {
        if (!dataCache) return;
        
        const game = dataCache.games[currentGameIndex];
        const scripts = game.scripts || [];
        const scriptsList = document.getElementById('scriptsList');
        
        if (!scriptsList) return;
        
        if (scripts.length === 0) {
            scriptsList.innerHTML = `
                <div class="script-empty-state">
                    <div class="icon">üìú</div>
                    <div>No scripts added yet</div>
                    <div style="font-size:11px; margin-top:5px;">Add your first script below</div>
                </div>
            `;
            return;
        }
        
        const scriptsHtml = scripts.map((script, index) => {
            const addedDate = new Date(script.added || Date.now()).toLocaleDateString();
            return `
                <div class="script-item">
                    <div class="script-header">
                        <div class="script-name">${script.name}</div>
                        <div class="script-actions">
                            <button class="mini danger" onclick="deleteScript(${index})">Delete</button>
                        </div>
                    </div>
                    <div class="script-url">${script.url}</div>
                    <div class="script-meta">
                        <span>Added: ${addedDate}</span>
                        <span>By: ${script.addedBy || 'system'}</span>
                    </div>
                </div>
            `;
        }).join('');
        
        scriptsList.innerHTML = scriptsHtml;
        
    } catch (error) {
        console.error('Error rendering scripts:', error);
        addNotification('‚ùå Error', 'Failed to load scripts', 'error');
    }
}

// Add script to game
async function addScriptToGame() {
    if (currentGameIndex === -1) {
        addNotification('‚ùå Error', 'No game selected', 'error');
        return;
    }
    
    const scriptName = document.getElementById('newScriptName').value.trim();
    const scriptUrl = document.getElementById('newScriptUrl').value.trim();
    const statusEl = document.getElementById('addScriptStatus');
    
    if (!scriptName || !scriptUrl) {
        if (statusEl) {
            statusEl.textContent = 'Please fill in all fields';
            statusEl.style.color = 'var(--danger)';
        }
        return;
    }
    
    if (!scriptUrl.startsWith('http://') && !scriptUrl.startsWith('https://')) {
        if (statusEl) {
            statusEl.textContent = 'Please enter a valid URL starting with http:// or https://';
            statusEl.style.color = 'var(--danger)';
        }
        return;
    }
    
    showLoading('Adding script...');
    if (statusEl) statusEl.textContent = '';
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        const game = data.games[currentGameIndex];
        
        if (!game.scripts) game.scripts = [];
        
        // Check for duplicate URL
        if (game.scripts.some(s => s.url === scriptUrl)) {
            throw new Error('Script with this URL already exists');
        }
        
        const newScript = {
            name: scriptName,
            url: scriptUrl,
            added: Date.now(),
            addedBy: getUserIdentifier()
        };
        
        game.scripts.push(newScript);
        data.settings.last_updated = Date.now();
        
        await docRef.update({
            games: data.games,
            settings: data.settings
        });
        
        // Clear form
        document.getElementById('newScriptName').value = '';
        document.getElementById('newScriptUrl').value = '';
        
        if (statusEl) {
            statusEl.textContent = '‚úÖ Script added successfully!';
            statusEl.style.color = 'var(--success)';
        }
        
        addNotification('üìú Script Added', `New script "${scriptName}" added to ${game.name}`, 'success');
        renderGameScripts();
        
        setTimeout(() => {
            if (statusEl) statusEl.textContent = '';
        }, 3000);
        
    } catch (error) {
        console.error('Error adding script:', error);
        if (statusEl) {
            statusEl.textContent = error.message || 'Failed to add script';
            statusEl.style.color = 'var(--danger)';
        }
        addNotification('‚ùå Error', error.message || 'Failed to add script', 'error');
    } finally {
        hideLoading();
    }
}

// Delete script
async function deleteScript(index) {
    if (currentGameIndex === -1) return;
    
    if (!confirm('Delete this script?')) return;
    
    showLoading('Deleting script...');
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        const game = data.games[currentGameIndex];
        
        if (!game.scripts || !game.scripts[index]) {
            throw new Error('Script not found');
        }
        
        const scriptName = game.scripts[index].name;
        game.scripts.splice(index, 1);
        data.settings.last_updated = Date.now();
        
        await docRef.update({
            games: data.games,
            settings: data.settings
        });
        
        addNotification('üóëÔ∏è Script Deleted', `Script "${scriptName}" was removed`, 'warning');
        renderGameScripts();
        
    } catch (error) {
        console.error('Error deleting script:', error);
        addNotification('‚ùå Error', error.message || 'Failed to delete script', 'error');
    } finally {
        hideLoading();
    }
}

// Delete current game
async function deleteCurrentGame() {
    if (currentGameIndex === -1) return;
    
    if (!confirm('Delete this game and all its scripts? This action cannot be undone.')) return;
    
    showLoading('Deleting game...');
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        if (!data.games || !data.games[currentGameIndex]) {
            throw new Error('Game not found');
        }
        
        const gameName = data.games[currentGameIndex].name;
        data.games.splice(currentGameIndex, 1);
        data.settings.last_updated = Date.now();
        
        await docRef.update({
            games: data.games,
            settings: data.settings
        });
        
        addNotification('üóëÔ∏è Game Deleted', `Game "${gameName}" was removed`, 'warning');
        showGamesDashboard();
        
    } catch (error) {
        console.error('Error deleting game:', error);
        addNotification('‚ùå Error', error.message || 'Failed to delete game', 'error');
    } finally {
        hideLoading();
    }
}

// Update stats display
function updateStatsDisplay() {
    const timeEl = document.getElementById('currentTime');
    if (timeEl) {
        const now = new Date();
        timeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
}

// Track view and activity
function trackViewAndActivity() {
    updateStatsDisplay();
}

// Update chat
function updateChat() {
    if (!dataCache || !dataCache.chats) return;
    
    const currentUserId = getUserIdentifier();
    const bans = dataCache.bans || {};
    
    // Check if user is banned
    if (bans[currentUserId]) {
        document.getElementById('chat-toggle').classList.add('hidden');
        document.getElementById('chat-window').classList.add('hidden');
        return;
    }
    
    const chatToggle = document.getElementById('chat-toggle');
    if (chatToggle) chatToggle.classList.remove('hidden');
    
    // Handle pinned message
    if (dataCache.pinned) {
        const pinnedArea = document.getElementById('pinned-area');
        const pinnedText = document.getElementById('pinnedText');
        if (pinnedArea && pinnedText) {
            pinnedArea.classList.remove('hidden');
            pinnedText.textContent = dataCache.pinned.text || dataCache.pinned;
        }
    }
    
    renderMessages();
}

// Render chat messages
function renderMessages() {
    if (!dataCache || !dataCache.chats) return;
    
    const msgsContainer = document.getElementById('chat-msgs');
    if (!msgsContainer) return;
    
    const chats = dataCache.chats;
    
    if (chats.length === 0) {
        msgsContainer.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üí¨</div>
                <div>No messages yet. Be the first to say hello!</div>
            </div>
        `;
        return;
    }
    
    const currentUserId = getUserIdentifier();
    
    const messagesHtml = chats.map((msg, index) => {
        const isSystem = msg.user === 'SYSTEM';
        const isOwner = msg.user === 'plstealme2';
        const msgTime = new Date(msg.timestamp || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        return `
            <div class="msg-item ${isSystem ? 'system' : ''} ${isOwner ? 'owner-msg' : ''}">
                <div class="msg-header">
                    <div class="msg-user">
                        ${msg.user}
                        ${isOwner ? '<span class="owner-badge">üëë</span>' : ''}
                    </div>
                    <div class="msg-time">${msgTime}</div>
                </div>
                <div class="msg-content">
                    ${msg.txt}
                </div>
            </div>
        `;
    }).join('');
    
    msgsContainer.innerHTML = messagesHtml;
    
    // Scroll to bottom
    if (msgsContainer.scrollHeight > msgsContainer.clientHeight) {
        msgsContainer.scrollTop = msgsContainer.scrollHeight;
    }
}

// Send chat message
async function sendChat() {
    const input = document.getElementById('chat-input');
    if (!input) return;
    
    const message = input.value.trim();
    if (!message) return;
    
    if (moderate(message)) {
        addNotification('‚ö†Ô∏è Message Blocked', 'Message contains blocked content', 'warning');
        return;
    }
    
    const currentUserId = getUserIdentifier();
    const bans = dataCache?.bans || {};
    
    if (bans[currentUserId]) {
        addNotification('‚ùå Chat Banned', 'You are banned from chat', 'error');
        return;
    }
    
    const newMsg = {
        user: currentUserId,
        txt: message,
        timestamp: Date.now()
    };
    
    try {
        const docRef = db.collection('system').doc('config');
        
        if (!dataCache.chats) dataCache.chats = [];
        dataCache.chats.push(newMsg);
        
        // Keep only last 100 messages
        if (dataCache.chats.length > 100) {
            dataCache.chats = dataCache.chats.slice(-100);
        }
        
        await docRef.update({ chats: dataCache.chats });
        
        input.value = '';
        renderMessages();
        
    } catch (error) {
        console.error('Error sending message:', error);
        addNotification('‚ùå Error', 'Failed to send message', 'error');
    }
}

// Toggle chat window
function toggleChat(show) {
    const chatWindow = document.getElementById('chat-window');
    if (!chatWindow) return;
    
    if (show) {
        chatWindow.classList.remove('hidden');
        chatUnreadCount = 0;
        updateUnreadBadge();
    } else {
        chatWindow.classList.add('hidden');
    }
}

// Render admin keys
async function renderAdminKeys() {
    try {
        if (!dataCache) return;
        
        const keys = dataCache.keys || {};
        const keyLogs = document.getElementById('keyLogs');
        const keyCount = document.getElementById('keyCount');
        
        if (keyCount) {
            keyCount.textContent = Object.keys(keys).length + ' key' + (Object.keys(keys).length !== 1 ? 's' : '');
        }
        
        if (!keyLogs) return;
        
        if (Object.keys(keys).length === 0) {
            keyLogs.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No keys in system</div>';
            return;
        }
        
        const keysHtml = Object.entries(keys).map(([keyId, keyData]) => {
            const createdDate = new Date(keyData.created || Date.now()).toLocaleString();
            return `
                <div class="fb-item">
                    <div style="flex:1;">
                        <div><strong>${keyId.substring(0, 8)}...</strong> (for UserID: ${keyData.rbx})</div>
                        <div style="font-size:10px; opacity:0.7;">
                            Generated by: ${keyData.generatedBy || 'system'} ‚Ä¢ ${createdDate}
                        </div>
                    </div>
                    <button class="mini danger" onclick="deleteAdminKey('${keyId}')">Delete</button>
                </div>
            `;
        }).join('');
        
        keyLogs.innerHTML = keysHtml;
        
    } catch (error) {
        console.error('Error rendering admin keys:', error);
        addNotification('‚ùå Error', 'Failed to load keys', 'error');
    }
}

// Delete admin key
async function deleteAdminKey(keyId) {
    if (!confirm('Delete this key?')) return;
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        if (!data.keys || !data.keys[keyId]) {
            throw new Error('Key not found');
        }
        
        const keyData = data.keys[keyId];
        delete data.keys[keyId];
        data.settings.last_updated = Date.now();
        
        await docRef.update({
            keys: data.keys,
            settings: data.settings
        });
        
        addNotification('üóëÔ∏è Key Deleted', `Key for UserID ${keyData.rbx} was removed`, 'warning');
        renderAdminKeys();
        
    } catch (error) {
        console.error('Error deleting key:', error);
        addNotification('‚ùå Error', 'Failed to delete key', 'error');
    }
}

// Render admin bans
async function renderAdminBans() {
    try {
        if (!dataCache) return;
        
        const bans = dataCache.bans || {};
        const banLogs = document.getElementById('banLogs');
        const banCount = document.getElementById('banCount');
        
        if (banCount) {
            banCount.textContent = Object.keys(bans).length + ' banned';
        }
        
        if (!banLogs) return;
        
        if (Object.keys(bans).length === 0) {
            banLogs.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No banned users</div>';
            return;
        }
        
        const bansHtml = Object.entries(bans).map(([userId, banData]) => {
            const banTime = new Date(banData.time || Date.now()).toLocaleString();
            return `
                <div class="fb-item">
                    <div style="flex:1;">
                        <div><strong>${banData.username || userId}</strong> (${userId})</div>
                        <div style="font-size:10px; opacity:0.7;">
                            Reason: ${banData.reason || 'No reason provided'}<br>
                            Banned by: ${banData.banned_by || 'system'} ‚Ä¢ ${banTime}
                        </div>
                    </div>
                    <button class="mini success" onclick="unbanUser('${userId}')">Unban</button>
                </div>
            `;
        }).join('');
        
        banLogs.innerHTML = bansHtml;
        
    } catch (error) {
        console.error('Error rendering bans:', error);
        addNotification('‚ùå Error', 'Failed to load bans', 'error');
    }
}

// Ban all key holders
async function banAllKeyHolders() {
    if (!confirm('Ban all key holders? This will ban every user who has a key.')) return;
    
    showLoading('Banning all key holders...');
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        const keys = data.keys || {};
        
        if (!data.bans) data.bans = {};
        
        let bannedCount = 0;
        
        for (const [_, keyData] of Object.entries(keys)) {
            if (keyData.rbx && !data.bans[keyData.rbx]) {
                data.bans[keyData.rbx] = {
                    reason: 'Mass ban of all key holders',
                    banned_by: getUserIdentifier(),
                    time: Date.now()
                };
                bannedCount++;
            }
        }
        
        data.settings.last_updated = Date.now();
        
        await docRef.update({
            bans: data.bans,
            settings: data.settings
        });
        
        addNotification('‚ö†Ô∏è Mass Ban', `Banned ${bannedCount} key holders`, 'warning');
        renderAdminBans();
        
    } catch (error) {
        console.error('Error banning key holders:', error);
        addNotification('‚ùå Error', 'Failed to ban key holders', 'error');
    } finally {
        hideLoading();
    }
}

// Unban all users
async function unbanEveryone() {
    if (!confirm('Unban all users?')) return;
    
    showLoading('Unbanning all users...');
    
    try {
        const docRef = db.collection('system').doc('config');
        
        await docRef.update({
            bans: {}
        });
        
        addNotification('‚úÖ Mass Unban', 'All users have been unbanned', 'success');
        renderAdminBans();
        
    } catch (error) {
        console.error('Error unbanning users:', error);
        addNotification('‚ùå Error', 'Failed to unban users', 'error');
    } finally {
        hideLoading();
    }
}

// Unban user
async function unbanUser(userId) {
    if (!confirm('Unban user ' + userId + '?')) return;
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        if (!data.bans || !data.bans[userId]) {
            throw new Error('User not banned');
        }
        
        delete data.bans[userId];
        data.settings.last_updated = Date.now();
        
        await docRef.update({
            bans: data.bans,
            settings: data.settings
        });
        
        addNotification('‚úÖ User Unbanned', `User ${userId} has been unbanned`, 'success');
        renderAdminBans();
        
    } catch (error) {
        console.error('Error unbanning user:', error);
        addNotification('‚ùå Error', 'Failed to unban user', 'error');
    }
}

// Show ban now modal
function showBanNowModal() {
    document.getElementById('banNowModal').classList.remove('hidden');
    document.getElementById('focusBanId').focus();
}

// Hide ban now modal
function hideBanNowModal() {
    document.getElementById('banNowModal').classList.add('hidden');
    document.getElementById('focusBanId').value = '';
    document.getElementById('focusBanUser').value = '';
    document.getElementById('focusBanReason').value = '';
}

// Execute focus ban
async function executeFocusBan() {
    const userId = document.getElementById('focusBanId').value.trim();
    const username = document.getElementById('focusBanUser').value.trim();
    const reason = document.getElementById('focusBanReason').value.trim();
    
    if (!userId) {
        addNotification('‚ùå Error', 'Please enter a UserID', 'error');
        return;
    }
    
    showLoading('Banning user...');
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        if (!data.bans) data.bans = {};
        
        data.bans[userId] = {
            reason: reason || 'Violation of terms',
            banned_by: getUserIdentifier(),
            time: Date.now(),
            username: username || 'Unknown'
        };
        
        data.settings.last_updated = Date.now();
        
        await docRef.update({
            bans: data.bans,
            settings: data.settings
        });
        
        hideBanNowModal();
        addNotification('‚õî User Banned', `User ${username || userId} has been banned`, 'warning');
        renderAdminBans();
        
    } catch (error) {
        console.error('Error banning user:', error);
        addNotification('‚ùå Error', 'Failed to ban user', 'error');
    } finally {
        hideLoading();
    }
}

// Send global message
async function sendGlobalMsg(isPin = false) {
    const input = document.getElementById('globalMsgInput');
    if (!input) return;
    
    const message = input.value.trim();
    
    if (!message) {
        addNotification('‚ùå Error', 'Please enter a message', 'error');
        return;
    }
    
    if (message.length > 200) {
        addNotification('‚ùå Error', 'Message must be 200 characters or less', 'error');
        return;
    }
    
    showLoading(isPin ? 'Pinning message...' : 'Sending broadcast...');
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        if (isPin) {
            data.pinned = {
                text: message,
                pinnedBy: getUserIdentifier(),
                pinnedAt: Date.now()
            };
            await docRef.update({ pinned: data.pinned });
            addNotification('üìå Message Pinned', 'A new message has been pinned', 'info');
        } else {
            const systemMsg = {
                user: 'SYSTEM',
                txt: message,
                timestamp: Date.now()
            };
            
            if (!data.chats) data.chats = [];
            data.chats.push(systemMsg);
            
            if (data.chats.length > 100) {
                data.chats = data.chats.slice(-100);
            }
            
            await docRef.update({ chats: data.chats });
            addNotification('üì¢ Broadcast', 'System announcement sent', 'info');
        }
        
        input.value = '';
        updateChat();
        
    } catch (error) {
        console.error('Error sending message:', error);
        addNotification('‚ùå Error', 'Failed to send message', 'error');
    } finally {
        hideLoading();
    }
}

// Clear globals (pinned and system messages)
async function clearGlobals() {
    if (!confirm('Clear all pinned and system messages?')) return;
    
    showLoading('Clearing messages...');
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        data.pinned = null;
        
        if (data.chats) {
            data.chats = data.chats.filter(msg => msg.user !== 'SYSTEM');
        }
        
        await docRef.update({
            pinned: data.pinned,
            chats: data.chats
        });
        
        addNotification('üßπ Messages Cleared', 'All pinned and system messages removed', 'info');
        updateChat();
        
    } catch (error) {
        console.error('Error clearing messages:', error);
        addNotification('‚ùå Error', 'Failed to clear messages', 'error');
    } finally {
        hideLoading();
    }
}

// Clear all chat
async function clearAllChat() {
    if (!confirm('Clear all chat messages? This cannot be undone.')) return;
    
    showLoading('Clearing chat...');
    
    try {
        const docRef = db.collection('system').doc('config');
        
        await docRef.update({
            chats: []
        });
        
        addNotification('üí¨ Chat Cleared', 'All chat messages have been cleared', 'info');
        updateChat();
        
    } catch (error) {
        console.error('Error clearing chat:', error);
        addNotification('‚ùå Error', 'Failed to clear chat', 'error');
    } finally {
        hideLoading();
    }
}

// Open admin feedbacks
function openAdminFeedbacks() {
    document.getElementById('feedbackModal').classList.remove('hidden');
    renderAdminFeedbacks();
}

// Hide feedback modal
function hideFeedbackModal() {
    document.getElementById('feedbackModal').classList.add('hidden');
}

// Render admin feedbacks
async function renderAdminFeedbacks() {
    try {
        if (!dataCache) return;
        
        const feedbacks = dataCache.feedbacks || [];
        const searchTerm = document.getElementById('fbSearch')?.value.toLowerCase() || '';
        
        const filtered = feedbacks.filter(fb => 
            fb.user.toLowerCase().includes(searchTerm) || 
            fb.userId.toLowerCase().includes(searchTerm)
        );
        
        const fbLogs = document.getElementById('fbLogs');
        
        if (!fbLogs) return;
        
        if (filtered.length === 0) {
            fbLogs.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No feedback submissions</div>';
            return;
        }
        
        const feedbacksHtml = filtered.map((fb, index) => {
            const fbDate = new Date(fb.timestamp).toLocaleString();
            return `
                <div class="fb-item">
                    <div style="flex:1;">
                        <div><strong>${fb.user}</strong> (${fb.userId})</div>
                        <div style="font-size:11px; margin:5px 0;">${fb.message}</div>
                        <div style="font-size:10px; opacity:0.7;">${fbDate}</div>
                    </div>
                    <div>
                        <button class="mini danger" onclick="deleteFeedback(${index})">Delete</button>
                    </div>
                </div>
            `;
        }).join('');
        
        fbLogs.innerHTML = feedbacksHtml;
        
    } catch (error) {
        console.error('Error rendering feedbacks:', error);
        addNotification('‚ùå Error', 'Failed to load feedbacks', 'error');
    }
}

// Delete feedback
async function deleteFeedback(index) {
    if (!confirm('Delete this feedback?')) return;
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        if (!data.feedbacks || !data.feedbacks[index]) {
            throw new Error('Feedback not found');
        }
        
        const feedback = data.feedbacks[index];
        data.feedbacks.splice(index, 1);
        data.settings.last_updated = Date.now();
        
        await docRef.update({
            feedbacks: data.feedbacks,
            settings: data.settings
        });
        
        addNotification('üóëÔ∏è Feedback Deleted', `Feedback from ${feedback.user} removed`, 'warning');
        renderAdminFeedbacks();
        
    } catch (error) {
        console.error('Error deleting feedback:', error);
        addNotification('‚ùå Error', 'Failed to delete feedback', 'error');
    }
}

// Master reset function
async function masterReset() {
    const resetTarget = document.getElementById('resetTarget')?.value;
    
    if (!resetTarget) return;
    
    let confirmMessage = '';
    
    switch(resetTarget) {
        case 'chat':
            confirmMessage = 'Clear all chat history?';
            break;
        case 'bans':
            confirmMessage = 'Clear all bans?';
            break;
        case 'users':
            confirmMessage = 'Clear all user accounts? This will remove all user data.';
            break;
        case 'all':
            confirmMessage = 'FACTORY RESET: This will wipe EVERYTHING and cannot be undone. Continue?';
            break;
        default:
            return;
    }
    
    if (!confirm(confirmMessage)) return;
    
    showLoading('Resetting system...');
    
    try {
        const docRef = db.collection('system').doc('config');
        
        if (resetTarget === 'all') {
            // Factory reset - recreate everything
            const initialData = {
                users: {
                    [ADMIN_USERNAME]: {
                        password: ADMIN_PASSWORD,
                        created: Date.now(),
                        role: 'SUPER_ADMIN'
                    }
                },
                keys: {},
                games: [],
                bans: {},
                feedbacks: [],
                chats: [],
                pinned: null,
                settings: {
                    version: '2.0',
                    created: Date.now(),
                    last_updated: Date.now()
                }
            };
            
            await docRef.set(initialData);
            dataCache = initialData;
            
            addNotification('‚ö†Ô∏è Factory Reset', 'System has been completely reset', 'warning');
            location.reload();
            return;
        }
        
        const doc = await docRef.get();
        const data = doc.data();
        
        switch(resetTarget) {
            case 'chat':
                data.chats = [];
                data.pinned = null;
                break;
            case 'bans':
                data.bans = {};
                break;
            case 'users':
                data.keys = {};
                data.feedbacks = [];
                break;
        }
        
        data.settings.last_updated = Date.now();
        
        await docRef.update(data);
        
        addNotification('‚úÖ Reset Complete', `System reset: ${resetTarget}`, 'success');
        
        // Refresh views
        updateChat();
        renderAdminKeys();
        renderAdminBans();
        loadGamesDashboard();
        
    } catch (error) {
        console.error('Error resetting system:', error);
        addNotification('‚ùå Error', 'Failed to reset system', 'error');
    } finally {
        hideLoading();
    }
}

// Toggle feedback UI
function toggleFeedbackUI(show) {
    const feedbackUI = document.getElementById('userFeedbackUI');
    const mainSystem = document.getElementById('mainSystem');
    
    if (show) {
        mainSystem.classList.add('hidden');
        feedbackUI.classList.remove('hidden');
    } else {
        feedbackUI.classList.add('hidden');
        mainSystem.classList.remove('hidden');
    }
}

// Submit feedback
async function submitFeedback() {
    const username = document.getElementById('fb-user')?.value.trim();
    const userId = document.getElementById('fb-id')?.value.trim();
    const message = document.getElementById('fb-msg')?.value.trim();
    const spinner = document.getElementById('fbSpinner');
    
    if (!username || !userId || !message) {
        addNotification('‚ùå Error', 'Please fill in all fields', 'error');
        return;
    }
    
    if (spinner) spinner.style.display = 'inline-block';
    
    try {
        const docRef = db.collection('system').doc('config');
        const doc = await docRef.get();
        const data = doc.data();
        
        if (!data.feedbacks) data.feedbacks = [];
        
        const newFeedback = {
            user: username,
            userId: userId,
            message: message,
            timestamp: Date.now(),
            status: 'pending'
        };
        
        data.feedbacks.push(newFeedback);
        data.settings.last_updated = Date.now();
        
        await docRef.update({
            feedbacks: data.feedbacks,
            settings: data.settings
        });
        
        // Clear form
        document.getElementById('fb-user').value = '';
        document.getElementById('fb-id').value = '';
        document.getElementById('fb-msg').value = '';
        
        addNotification('‚úÖ Feedback Submitted', 'Thank you for your feedback!', 'success');
        toggleFeedbackUI(false);
        
    } catch (error) {
        console.error('Error submitting feedback:', error);
        addNotification('‚ùå Error', 'Failed to submit feedback', 'error');
    } finally {
        if (spinner) spinner.style.display = 'none';
    }
}

// Cancel reply (placeholder function)
function cancelReply() {
    document.getElementById('reply-preview').classList.add('hidden');
}

// Image preview handler
document.getElementById('gameImageInput')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (file.size > 2 * 1024 * 1024) {
        addNotification('‚ùå Error', 'Image must be less than 2MB', 'error');
        return;
    }
    
    if (!file.type.match('image.*')) {
        addNotification('‚ùå Error', 'Please select an image file', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('gameImagePreview');
        const placeholder = document.getElementById('imagePlaceholder');
        if (preview && placeholder) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
        }
    };
    reader.readAsDataURL(file);
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
    updateStatsDisplay();
    setInterval(updateStatsDisplay, 60000);
    trackViewAndActivity();
    setInterval(trackViewAndActivity, 30000);
    
    await initializeDatabase();
    checkSession();
    
    if (!currentUser) {
        document.getElementById('authPanel').classList.remove('hidden');
        document.getElementById('mainSystem').classList.add('hidden');
    } else {
        updateChat();
        setInterval(updateChat, 5000);
    }
    
    // Chat enter key handler
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChat();
            }
        });
    }
    
    // UserID input handler for key cooldown check
    const userIdInput = document.getElementById('userid');
    if (userIdInput) {
        userIdInput.addEventListener('input', async () => {
            const userId = userIdInput.value.trim();
            if (userId && /^\d+$/.test(userId)) {
                // Check if user has a recent key
                const keys = dataCache?.keys || {};
                const existingKey = Object.entries(keys).find(([_, keyData]) => 
                    String(keyData.rbx) === String(userId) && keyData.generatedBy === currentUser?.username
                );
                
                if (existingKey) {
                    const [keyId, keyData] = existingKey;
                    const timeSinceCreation = Date.now() - keyData.created;
                    const hoursSinceCreation = timeSinceCreation / (1000 * 60 * 60);
                    
                    if (hoursSinceCreation < 24) {
                        const statusMsg = document.getElementById('statusMsg');
                        if (statusMsg) {
                            const hoursLeft = Math.ceil(24 - hoursSinceCreation);
                            statusMsg.innerHTML = `
                                <span style="color: var(--warning);">
                                    ‚è≥ You can generate a new key for this UserID in ${hoursLeft} hours ${Math.ceil(24 * 60 - hoursSinceCreation * 60)} minutes
                                </span>
                            `;
                        }
                    }
                }
            }
        });
    }
    
    addNotification('üöÄ System Ready', 'RSQ Elite System Overseer initialized', 'success');
});
</script>
</body>
</html>
