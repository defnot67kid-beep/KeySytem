<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RSQ Elite | System Overseer</title>

<style>
:root {
    --primary: #4f7cff;
    --secondary: #00d2ff;
    --danger: #ff3b30;
    --success: #28cd41;
    --warning: #ffcc00;
    --glass: rgba(15, 20, 30, 0.85);
    --border: rgba(255, 255, 255, 0.1);
}

body {
    margin: 0;
    background: #05070a;
    font-family: 'Segoe UI', system-ui, sans-serif;
    color: white;
    overflow: hidden;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Animations */
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(79, 124, 255, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(79, 124, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 124, 255, 0); } }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

.animate-fade { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
.animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
.animate-slide { animation: slideIn 0.3s ease-out forwards; }

#bg-wrap { position: fixed; inset: 0; background: radial-gradient(circle at center, #0f172a 0%, #05070a 100%); z-index: -1; }

.panel {
    position: relative;
    z-index: 10;
    width: 450px;
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 30px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

.hidden { display: none !important; }

input, select, textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 12px;
    margin-top: 10px;
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: white;
    outline: none;
    font-family: inherit;
}

button {
    width: 100%;
    padding: 12px;
    margin-top: 15px;
    border-radius: 10px;
    border: none;
    font-weight: 700;
    cursor: pointer;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    transition: 0.3s;
}

button:hover { transform: scale(1.02); filter: brightness(1.2); }
button.danger { background: linear-gradient(135deg, #ff3b30, #ff7b30); }
button.warning { background: linear-gradient(135deg, #ffcc00, #ffae00); color: #000; }
button.success { background: linear-gradient(135deg, #28cd41, #1fb335); }
button.mini { padding: 4px 8px; font-size: 10px; margin-top: 5px; width: auto; }

#chat-toggle {
    position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px;
    border-radius: 50%; background: white; display: flex;
    align-items: center; justify-content: center; cursor: pointer; z-index: 1000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    border: 3px solid var(--primary);
    transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
#chat-toggle svg { width: 30px; height: 30px; fill: var(--primary); }

/* CHAT WINDOW UPDATED FOR FULLSCREEN */
#chat-window {
    position: fixed; bottom: 100px; right: 25px; width: 340px; height: 500px;
    background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border);
    border-radius: 15px; display: flex; flex-direction: column; z-index: 999; overflow: hidden;
    transform-origin: bottom right; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.chat-fullscreen {
    bottom: 0 !important; right: 0 !important;
    width: 100vw !important; height: 100vh !important;
    border-radius: 0 !important;
    z-index: 5000 !important;
}

#chat-msgs { flex: 1; overflow-y: auto; padding: 15px; font-size: 13px; scroll-behavior: smooth;}
#pinned-area { background: rgba(255, 204, 0, 0.1); border-bottom: 1px solid var(--warning); padding: 10px; font-size: 12px; color: var(--warning); font-weight: bold; }

.back-btn-container {
    position: absolute; top: 15px; right: 15px; z-index: 5001;
}

/* CHAT INTERACTION STYLES */
.msg-item { 
    margin-bottom: 10px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; 
    animation: fadeIn 0.3s forwards; position: relative; border-left: 2px solid transparent;
}
.msg-item:hover .msg-hover-actions { display: flex; }

.msg-hover-actions {
    position: absolute; top: -12px; right: 5px; display: none; gap: 5px;
    background: #1a1f2b; border: 1px solid var(--border); border-radius: 15px; padding: 2px 8px; z-index: 10;
}
.hover-btn { cursor: pointer; font-size: 12px; transition: 0.2s; opacity: 0.8; }
.hover-btn:hover { opacity: 1; transform: scale(1.2); }

.emoji-select-box {
    position: absolute; bottom: 35px; right: 0; background: #1a1f2b; 
    border: 1px solid var(--border); border-radius: 10px; padding: 5px;
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; z-index: 100;
}

.reaction-bar { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
.react-tag { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 1px 6px; font-size: 10px; }

.reply-preview-bar {
    background: rgba(79, 124, 255, 0.1); padding: 5px 10px; font-size: 11px;
    border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
}

.msg-reply-quote {
    font-size: 10px; opacity: 0.6; font-style: italic; border-left: 2px solid var(--primary);
    padding-left: 8px; margin-bottom: 5px; display: block;
}

.msg-item.system { border-left-color: var(--primary); background: rgba(79, 124, 255, 0.1); animation: fadeIn 0.3s forwards, pulse 2s infinite; }
.msg-item.owner-msg { border-left-color: var(--warning); background: rgba(255, 204, 0, 0.08); box-shadow: inset 0 0 10px rgba(255, 204, 0, 0.05); }
.msg-item b { color: var(--secondary); font-size: 11px; display: block; margin-bottom: 3px;}

.del-btn { 
    color: var(--danger); cursor: pointer; font-weight: 800; font-size: 10px; 
    background: rgba(255,0,0,0.1); padding: 2px 5px; border-radius: 4px;
}

.adminFull {
    position: fixed; inset: 15px; background: #0b0f1a; border-radius: 20px;
    padding: 25px; z-index: 2000; overflow-y: auto; border: 1px solid var(--border);
}
.log-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; height: 350px; overflow-y: auto; }

.key-item {
    background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 10px;
    border-left: 3px solid var(--secondary);
}
.key-txt { font-family: monospace; color: var(--secondary); font-weight: bold; font-size: 14px; }
.key-meta { font-size: 10px; opacity: 0.6; margin: 4px 0; }
.key-actions { display: flex; gap: 5px; margin-top: 8px; }

.fb-item {
    display: flex; justify-content: space-between; align-items: center; 
    padding: 12px; background: rgba(255,255,255,0.05); margin-bottom: 8px; border-radius: 8px;
}

.ban-focus-container {
    max-width: 400px; margin: 50px auto; background: rgba(255, 255, 255, 0.03);
    padding: 30px; border-radius: 20px; border: 1px solid var(--danger);
}

/* NEW: REACTION BUTTON STYLES */
.reaction-btn {
    background: rgba(79, 124, 255, 0.15);
    border: 1px solid rgba(79, 124, 255, 0.3);
    border-radius: 12px;
    padding: 3px 8px;
    margin: 2px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    transition: all 0.2s ease;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

.reaction-btn:hover {
    background: rgba(79, 124, 255, 0.25);
    transform: scale(1.05);
}

.reaction-btn.active {
    background: rgba(79, 124, 255, 0.35);
    border-color: var(--primary);
    box-shadow: 0 0 8px rgba(79, 124, 255, 0.2);
}

.reaction-emoji {
    font-size: 12px;
}

.reaction-count {
    font-weight: bold;
    color: var(--secondary);
}

/* NEW: CACHE STATUS INDICATOR */
.cache-status {
    position: fixed;
    bottom: 10px;
    left: 10px;
    background: rgba(0,0,0,0.7);
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 9px;
    color: #0f0;
    z-index: 10000;
    opacity: 0.5;
    transition: opacity 0.3s;
}

.cache-status:hover {
    opacity: 1;
}

/* NEW: TOAST NOTIFICATION */
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 20px;
    z-index: 10000;
    animation: slideIn 0.3s ease-out, fadeIn 0.3s ease-out;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    max-width: 300px;
}

.toast.success { border-left: 4px solid var(--success); }
.toast.warning { border-left: 4px solid var(--warning); }
.toast.error { border-left: 4px solid var(--danger); }
.toast.info { border-left: 4px solid var(--primary); }

/* NEW: LOADING SPINNER */
.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* NEW: PERFORMANCE METRICS */
.perf-metrics {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.7);
    padding: 5px 10px;
    border-radius: 8px;
    font-size: 9px;
    color: #00ffcc;
    z-index: 10000;
    opacity: 0.5;
    font-family: monospace;
}

.perf-metrics:hover {
    opacity: 1;
}
</style>
</head>
<body>

<div id="bg-wrap"></div>

<!-- NEW: PERFORMANCE METRICS DISPLAY -->
<div id="perfMetrics" class="perf-metrics hidden">
    API: <span id="apiLatency">0ms</span> | Cache: <span id="cacheHitRate">100%</span>
</div>

<div id="authPanel" class="panel animate-fade">
    <h1 style="text-align:center; margin:0;">RSQ <span style="color:var(--secondary)">GATE</span></h1>
    <div id="loginView">
        <input id="l-user" placeholder="Username">
        <input id="l-pass" type="password" placeholder="Password">
        <button onclick="handleAuth('login')">Sign In</button>
        <p style="text-align:center; font-size:12px;">New? <a href="#" onclick="toggleAuth(true)" style="color:var(--secondary)">Create Account</a></p>
    </div>
    <div id="signupView" class="hidden">
        <input id="s-user" placeholder="Choose Username">
        <input id="s-pass" type="password" placeholder="Choose Password">
        <button onclick="handleAuth('signup')">Sign Up</button>
        <p style="text-align:center; font-size:12px;">Have account? <a href="#" onclick="toggleAuth(false)" style="color:var(--secondary)">Sign In</a></p>
    </div>
    <div id="authStatus" style="text-align:center; color:var(--danger); font-size:12px; margin-top:10px;"></div>
</div>

<div id="userFeedbackUI" class="panel animate-fade hidden">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">FEEDBACK</h2>
        <button class="mini danger" onclick="toggleFeedbackUI(false)">Exit Feedback</button>
    </div>
    <input id="fb-user" placeholder="Roblox Username">
    <input id="fb-id" placeholder="Roblox UserID">
    <textarea id="fb-msg" placeholder="Write your feedback here..." style="width:100%; height:120px; margin-top:10px; background:rgba(0,0,0,0.4); color:white; border:1px solid var(--border); border-radius:10px; padding:10px; resize:none;"></textarea>
    <button onclick="submitFeedback()">Submit Feedback</button>
</div>

<div id="mainSystem" class="hidden">
    <div id="mainContentWrapper">
        <div id="userPanel" class="panel animate-fade">
            <h1 style="text-align:center; margin:0;">RSQ <span style="color:var(--secondary)">ELITE</span></h1>
            <p id="welcomeUser" style="text-align:center; opacity:0.5; font-size: 11px;"></p>
            
            <input id="userid" placeholder="Roblox UserID">
            <button id="genBtn" onclick="generateKey()">Generate Access Key</button>
            <div id="statusMsg" style="text-align:center; margin-top:10px; font-size:12px; color:var(--danger);"></div>
            <div id="keyOut" style="text-align:center; margin-top:10px; color:var(--secondary); font-family:monospace; font-weight:bold;"></div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                <button id="adminBtn" class="danger hidden">Admin</button>
                <div style="display:flex; gap:10px;">
                    <button onclick="toggleFeedbackUI(true)">Feedback</button>
                    <button style="background:none; border: 1px solid var(--border);" onclick="logout()">Logout</button>
                </div>
            </div>
            <input id="adminInput" class="hidden" type="password" placeholder="Master Key">
        </div>
    </div>

    <div id="chat-toggle" onclick="toggleChat(true)">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
    </div>

    <div id="chat-window" class="hidden">
        <div class="back-btn-container">
            <button onclick="toggleChat(false)" class="mini danger" style="width:120px; margin:0; padding:8px;">BACK TO MAIN</button>
        </div>
        
        <div style="padding:15px; background:rgba(255,255,255,0.05); font-size:14px; font-weight:bold; letter-spacing:1px;">NETWORK CHAT</div>
        <div id="pinned-area" class="hidden"></div>
        <div id="chat-msgs"></div>
        
        <div id="reply-preview" class="reply-preview-bar hidden">
            <span id="reply-preview-text">Replying to...</span>
            <span style="cursor:pointer; color:var(--danger)" onclick="cancelReply()">‚úï</span>
        </div>

        <div id="chat-controls" style="padding:15px; display:flex; gap:10px; background: rgba(0,0,0,0.3);">
            <input id="chatIn" placeholder="Type a message..." style="margin:0; font-size:14px;">
            <button id="sendChatBtn" style="margin:0; width:70px;" onclick="sendChat()">SEND</button>
        </div>
    </div>
</div>

<div id="adminPanel" class="adminFull hidden">
    <div id="adminDefaultView">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>üëë OVERSEER CONTROL</h2>
            <div style="display:flex; gap:10px;">
                <button class="danger" onclick="toggleBanNowView(true)" style="width:auto; margin:0;">BAN NOW</button>
                <button class="warning" onclick="openAdminFeedbacks()" style="width:auto; margin:0;">Feedbacks</button>
                <button onclick="closeAdmin()" style="width:auto; margin:0; background:#444;">Exit</button>
            </div>
        </div>

        <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:15px; margin-top:20px;">
            <h3 style="margin-top:0">üî® Broadcast & Chat Controls</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input id="globalMsgInput" placeholder="Broadcast Text">
                <div style="display:flex; gap:10px;">
                    <button class="warning" onclick="sendGlobalMsg(true)" style="margin:0">PIN LIVE</button>
                    <button class="warning" onclick="sendGlobalMsg(false)" style="margin:0">ANNOUNCE</button>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <button class="danger" onclick="clearGlobals()">PURGE GLOBALS</button>
                <button class="danger" onclick="clearAllChat()">WIPE CHAT</button>
            </div>
        </div>

        <div style="background:rgba(255, 59, 48, 0.15); padding:20px; border-radius:15px; margin-top:20px; border: 1px solid var(--danger);">
            <h3 style="margin-top:0; color:var(--danger);">‚ö†Ô∏è GLOBAL ACCESS CONTROL</h3>
            <p style="font-size: 11px; opacity: 0.8; margin-top: -10px; margin-bottom: 15px;">Warning: "Ban All" will blacklist every user who currently has an active key.</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="danger" onclick="banAllKeyHolders()" style="margin:0">BAN ALL KEY HOLDERS</button>
                <button class="success" onclick="unbanEveryone()" style="margin:0">UNBAN ALL USERS</button>
            </div>
        </div>

        <div style="background:rgba(255, 59, 48, 0.1); padding:20px; border-radius:15px; margin-top:20px; border: 1px solid var(--danger);">
            <h3 style="margin-top:0; color:var(--danger);">‚ò¢Ô∏è SYSTEM RESET</h3>
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;">
                <select id="resetTarget">
                    <option value="chat">Clear Chat History Only</option>
                    <option value="bans">Clear All Blacklists (Bans)</option>
                    <option value="users">Clear All User Accounts</option>
                    <option value="all">FACTORY RESET (Wipe Everything)</option>
                </select>
                <button class="danger" onclick="masterReset()" style="margin:0">EXECUTE RESET</button>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
            <div><h3>Active Blacklist</h3><div id="banLogs" class="log-box"></div></div>
            <div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>System Keys</h3>
                    <button class="mini" onclick="renderAdminKeys()">Refresh</button>
                </div>
                <div id="keyLogs" class="log-box"></div>
            </div>
        </div>
    </div>

    <div id="banNowView" class="hidden">
        <div class="ban-focus-container">
            <h2 style="color:var(--danger); text-align:center;">üî® RESTRICT USER</h2>
            <input id="focusBanId" placeholder="Roblox UserID">
            <input id="focusBanUser" placeholder="Username to Ban">
            <textarea id="focusBanReason" placeholder="Reason for restriction..." style="height:100px; resize:none;"></textarea>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="danger" onclick="executeFocusBan()">BAN USER</button>
                <button onclick="toggleBanNowView(false)" style="background:#444;">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="adminFeedbackListView" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>üì© USER FEEDBACKS</h2>
            <button onclick="returnToAdminPanel()" style="width:auto; margin:0; background:#444;">Return to Admin Panel</button>
        </div>
        <input id="fbSearch" placeholder="Search UserID or Username..." oninput="renderAdminFeedbacks()">
        <div id="fbLogs" class="log-box" style="margin-top:15px; height: 500px;"></div>
    </div>

    <div id="adminViewFeedbackUI" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="viewFbTitle">FEEDBACK VIEW</h2>
            <button onclick="closeSingleFeedback()" style="width:auto; margin:0; background:var(--danger);">Close Feedback</button>
        </div>
        <div id="viewFbContent" style="background:rgba(255,255,255,0.05); padding:20px; border-radius:15px; margin-top:20px; line-height: 1.6; min-height: 200px;"></div>
    </div>
</div>

<script>
// ========== CONFIGURATION ==========
const BIN_ID = "694c4aefae596e708faef157";
const JSON_KEY = "$2a$10$DgQd.qgYLB2nv9e9ZFktKeUUkzZfmqPnL4Fk7JLvnN/ASlctW.8Cu";
const MASTER_KEY = "roblox";
const SUPER_ADMIN = "plstealme2";
const OWNER_PASS = "RSQ-OWNER-PLSTEALME2";

const MOD_CONFIG = {
    BANNED: [/fuck/gi, /shit/gi, /nigger/gi, /faggot/gi, /retard/gi, /bitch/gi, /porn/gi, /sex/gi],
    LEET: { '0':'o', '1':'i', '3':'e', '4':'a', '5':'s', '7':'t', '8':'b', '@':'a', '$':'s', '!':'i', '*':'' }
};

// ========== PERFORMANCE OPTIMIZATION ==========
let dataCache = null;
let lastFetchTime = 0;
let cacheHits = 0;
let cacheMisses = 0;
const CACHE_TTL = 1000; // 1 second cache
let pendingUpdates = [];
let isUpdating = false;
let performanceMetrics = {
    apiCalls: 0,
    avgLatency: 0,
    lastLatency: 0
};

// ========== APPLICATION STATE ==========
let currentUser = null;
let isAdminAuthenticated = false;
let globalData = null;
let activeEmojiMsgIndex = null;
let activeReplyTarget = null;
let chatPollingInterval = null;

const now = () => Math.floor(Date.now()/1000);

// ========== UTILITY FUNCTIONS ==========
function moderate(text) {
    if (!text) return false;
    let clean = text.toLowerCase();
    for (let key in MOD_CONFIG.LEET) { clean = clean.split(key).join(MOD_CONFIG.LEET[key]); }
    clean = clean.replace(/[^a-zA-Z ]/g, "");
    return MOD_CONFIG.BANNED.some(regex => regex.test(clean) || regex.test(text));
}

function triggerShake(id) { 
    const el = document.getElementById(id);
    if (el) {
        el.classList.add('animate-shake'); 
        setTimeout(() => el.classList.remove('animate-shake'), 400);
    }
}

function showToast(message, type = 'info', duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

// ========== OPTIMIZED API FUNCTIONS ==========
async function api(method, data = null, force = false) {
    const startTime = performance.now();
    
    // Use cache for GET if not forcing and cache is fresh
    if (method === 'GET' && !force && dataCache && (Date.now() - lastFetchTime) < CACHE_TTL) {
        cacheHits++;
        updatePerformanceMetrics(performance.now() - startTime);
        updateCacheStatus();
        return dataCache;
    }
    
    try {
        cacheMisses++;
        const r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}${method==='GET'?'/latest':''}`, {
            method: method,
            headers: { 
                "Content-Type": "application/json", 
                "X-Master-Key": JSON_KEY,
                "X-Bin-Versioning": "false" 
            },
            body: data ? JSON.stringify(data) : null
        });
        
        const res = await r.json();
        const latency = performance.now() - startTime;
        performanceMetrics.lastLatency = latency;
        performanceMetrics.apiCalls++;
        updatePerformanceMetrics(latency);
        
        if (method === 'GET') {
            dataCache = res.record;
            lastFetchTime = Date.now();
            // Apply any pending updates to cache
            if (pendingUpdates.length > 0) {
                for (const update of pendingUpdates) {
                    Object.assign(dataCache, update);
                }
                pendingUpdates = [];
            }
        } else if (method === 'PUT') {
            dataCache = data;
            lastFetchTime = Date.now();
        }
        
        globalData = dataCache;
        updateCacheStatus();
        return dataCache;
    } catch (e) { 
        console.error("API Error:", e);
        showToast('Connection error - using cached data', 'warning', 2000);
        return dataCache || null;
    }
}

// ========== BATCH UPDATE SYSTEM ==========
async function batchUpdate(updates) {
    if (isUpdating) {
        pendingUpdates.push(updates);
        return;
    }
    
    isUpdating = true;
    try {
        const currentData = await api('GET', null, true);
        Object.assign(currentData, updates);
        await api('PUT', currentData);
        
        // Process any pending updates
        while (pendingUpdates.length > 0) {
            const nextUpdate = pendingUpdates.shift();
            Object.assign(currentData, nextUpdate);
            await api('PUT', currentData);
        }
    } catch (e) {
        console.error("Batch update failed:", e);
        // Still apply to cache for UI responsiveness
        if (dataCache) {
            Object.assign(dataCache, updates);
        }
    } finally {
        isUpdating = false;
    }
}

// ========== IMPROVED REACTION SYSTEM ==========
async function reactToMsg(index, emoji) {
    if (!currentUser) return;
    
    const data = await api('GET');
    if (!data.chat || !data.chat[index]) return;
    
    // Initialize reaction structures
    if (!data.chat[index].reactions) data.chat[index].reactions = {};
    if (!data.chat[index].reactionUsers) data.chat[index].reactionUsers = {};
    if (!data.chat[index].reactionUsers[emoji]) data.chat[index].reactionUsers[emoji] = [];
    
    const usersReacted = data.chat[index].reactionUsers[emoji];
    const userIndex = usersReacted.indexOf(currentUser);
    
    if (userIndex === -1) {
        // User hasn't reacted yet - add reaction
        data.chat[index].reactions[emoji] = (data.chat[index].reactions[emoji] || 0) + 1;
        usersReacted.push(currentUser);
        showToast(`Reacted with ${emoji}`, 'success', 1500);
    } else {
        // User already reacted - remove reaction
        data.chat[index].reactions[emoji] -= 1;
        if (data.chat[index].reactions[emoji] <= 0) {
            delete data.chat[index].reactions[emoji];
        }
        usersReacted.splice(userIndex, 1);
        if (usersReacted.length === 0) {
            delete data.chat[index].reactionUsers[emoji];
        }
        showToast(`Removed ${emoji} reaction`, 'info', 1500);
    }
    
    // Optimistic UI update
    updateChatOptimistic(data);
    
    // Batch update
    await batchUpdate({
        chat: data.chat
    });
    
    activeEmojiMsgIndex = null;
}

// ========== OPTIMISTIC UI UPDATES ==========
function updateChatOptimistic(newData) {
    dataCache = newData;
    updateChatDisplay(newData);
}

function updateChatDisplay(data) {
    if (!data) return;

    const chatToggle = document.getElementById('chat-toggle');
    const chatWindow = document.getElementById('chat-window');
    
    if (data.bans && data.bans[currentUser]) {
        chatToggle.classList.add('hidden');
        chatWindow.classList.add('hidden');
        return; 
    } else {
        if (chatWindow.classList.contains('hidden')) chatToggle.classList.remove('hidden');
    }

    const pinArea = document.getElementById('pinned-area');
    if (data.pinned && data.pinned.active) {
        pinArea.innerText = `üìå ${data.pinned.text}`;
        pinArea.classList.remove('hidden');
    } else { 
        pinArea.classList.add('hidden'); 
    }

    const box = document.getElementById('chat-msgs');
    box.innerHTML = (data.chat || []).map((m, i) => {
        const isOwner = m.user === SUPER_ADMIN;
        const isSystem = m.user === "SYSTEM";
        
        // Build Reactions with buttons
        let reactsHtml = "";
        if (m.reactions && Object.keys(m.reactions).length > 0) {
            reactsHtml = `<div class="reaction-bar">` + 
                Object.entries(m.reactions).map(([emoji, count]) => {
                    const usersReacted = m.reactionUsers?.[emoji] || [];
                    const isUserReacted = usersReacted.includes(currentUser);
                    
                    return `
                    <button class="reaction-btn ${isUserReacted ? 'active' : ''}" 
                            onclick="reactToMsg(${i}, '${emoji}')"
                            title="${usersReacted.join(', ') || 'No reactions yet'}"
                            oncontextmenu="event.preventDefault(); return false;">
                        <span class="reaction-emoji">${emoji}</span>
                        <span class="reaction-count">${count}</span>
                    </button>`;
                }).join('') + 
                `</div>`;
        }

        // Build Reply Quote
        let replyHtml = "";
        if (m.replyTo) {
            replyHtml = `<span class="msg-reply-quote">" ${m.replyTo.text} " ‚Äî ${m.replyTo.user}</span>`;
        }

        return `
        <div class="msg-item ${isOwner ? 'owner-msg' : ''} ${isSystem ? 'system' : ''}">
            <div class="msg-hover-actions">
                <span class="hover-btn" onclick="openEmojiPicker(${i})">üòä</span>
                <span class="hover-btn" onclick="setupReply(${i}, '${m.user}', '${m.txt.replace(/'/g, "\\'")}')">‚Ü©Ô∏è</span>
                ${isAdminAuthenticated ? `<span class="hover-btn del-btn" onclick="deleteChatMessage(${i})">üóëÔ∏è</span>` : ''}
            </div>

            ${activeEmojiMsgIndex === i ? `
            <div class="emoji-select-box">
                ${['‚ù§Ô∏è','üòÇ','üî•','üíÄ','‚úÖ','üëÄ','üëç','üòÆ'].map(e => `
                <span class="hover-btn" onclick="reactToMsg(${i}, '${e}')">${e}</span>`).join('')}
            </div>` : ''}

            ${replyHtml}
            <b>${isOwner ? 'üëë ' : ''}${m.user}</b> ${m.txt}
            ${reactsHtml}
        </div>`;
    }).join('');
    
    if (activeEmojiMsgIndex === null) {
        box.scrollTop = box.scrollHeight;
    }
}

// ========== CHAT FUNCTIONS ==========
async function updateChat() {
    const data = await api('GET');
    updateChatDisplay(data);
}

function openEmojiPicker(index) {
    activeEmojiMsgIndex = (activeEmojiMsgIndex === index) ? null : index;
    if (dataCache) {
        updateChatDisplay(dataCache);
    }
}

function setupReply(index, user, text) {
    activeReplyTarget = { user, text: text.substring(0, 30) + (text.length > 30 ? "..." : "") };
    const preview = document.getElementById('reply-preview');
    document.getElementById('reply-preview-text').innerText = `Replying to: ${user}`;
    preview.classList.remove('hidden');
    document.getElementById('chatIn').focus();
}

function cancelReply() {
    activeReplyTarget = null;
    document.getElementById('reply-preview').classList.add('hidden');
}

async function sendChat() {
    const input = document.getElementById('chatIn');
    let txt = input.value.trim();
    if (!txt) return;
    
    if (moderate(txt)) { 
        input.value = ""; 
        showToast('Message blocked: inappropriate content', 'error', 2000);
        return;
    }

    const data = await api('GET');
    if (data.bans && data.bans[currentUser]) {
        showToast('You are banned from chat', 'error', 2000);
        return;
    }

    const msgObj = { 
        user: currentUser, 
        txt: txt,
        timestamp: Date.now()
    };
    
    if (activeReplyTarget) {
        msgObj.replyTo = activeReplyTarget;
    }

    data.chat ||= [];
    data.chat.push(msgObj);
    if (data.chat.length > 50) data.chat.shift();
    
    // Optimistic update
    updateChatOptimistic(data);
    
    // Batch update
    await batchUpdate({
        chat: data.chat
    });
    
    input.value = "";
    cancelReply();
    showToast('Message sent', 'success', 1500);
}

async function deleteChatMessage(index) {
    if (!isAdminAuthenticated) return;
    
    if (!confirm("Delete this message?")) return;
    
    const data = await api('GET');
    if (data.chat && data.chat[index]) {
        const deletedMsg = data.chat.splice(index, 1)[0];
        
        // Optimistic update
        updateChatOptimistic(data);
        
        // Batch update
        await batchUpdate({
            chat: data.chat
        });
        
        showToast(`Deleted message from ${deletedMsg.user}`, 'warning', 2000);
    }
}

// ========== PERFORMANCE MONITORING ==========
function updatePerformanceMetrics(latency) {
    performanceMetrics.avgLatency = 
        (performanceMetrics.avgLatency * (performanceMetrics.apiCalls - 1) + latency) / performanceMetrics.apiCalls;
    
    const perfEl = document.getElementById('perfMetrics');
    if (perfEl) {
        perfEl.innerHTML = `API: <span id="apiLatency">${Math.round(latency)}ms</span> | Cache: <span id="cacheHitRate">${getCacheHitRate()}%</span>`;
    }
}

function getCacheHitRate() {
    const total = cacheHits + cacheMisses;
    return total > 0 ? Math.round((cacheHits / total) * 100) : 100;
}

function updateCacheStatus() {
    const status = document.getElementById('cacheStatus');
    if (status && dataCache) {
        const age = Date.now() - lastFetchTime;
        if (age < 500) {
            status.innerText = 'üü¢ Fresh';
            status.style.color = '#0f0';
        } else if (age < 1500) {
            status.innerText = 'üü° Syncing...';
            status.style.color = '#ff0';
        } else {
            status.innerText = 'üî¥ Stale';
            status.style.color = '#f00';
        }
    }
}

function addCacheStatus() {
    if (!document.getElementById('cacheStatus')) {
        const status = document.createElement('div');
        status.className = 'cache-status';
        status.id = 'cacheStatus';
        status.innerText = 'üü¢ Fresh';
        status.onclick = () => {
            dataCache = null;
            lastFetchTime = 0;
            updateChat();
            showToast('Cache cleared', 'info', 1500);
        };
        document.body.appendChild(status);
    }
}

function addPerformanceMetrics() {
    if (!document.getElementById('perfMetrics')) {
        const metrics = document.createElement('div');
        metrics.className = 'perf-metrics';
        metrics.id = 'perfMetrics';
        metrics.innerHTML = `API: <span id="apiLatency">0ms</span> | Cache: <span id="cacheHitRate">100%</span>`;
        document.body.appendChild(metrics);
    }
}

// ========== AUTHENTICATION ==========
window.onload = () => {
    const saved = localStorage.getItem('rsq_session');
    if(saved) {
        try {
            const session = JSON.parse(saved);
            document.getElementById('l-user').value = session.u;
            document.getElementById('l-pass').value = session.p;
            handleAuth('login');
        } catch (e) {
            localStorage.removeItem('rsq_session');
        }
    }
    addPerformanceMetrics();
}

async function handleAuth(type) {
    const status = document.getElementById('authStatus');
    status.innerText = "Syncing...";
    
    // Clear cache on auth to get fresh data
    dataCache = null;
    lastFetchTime = 0;
    
    const data = await api('GET', null, true);
    if(!data.users || Array.isArray(data.users)) data.users = {};

    const u = document.getElementById(type === 'signup' ? 's-user' : 'l-user').value.trim();
    const p = document.getElementById(type === 'signup' ? 's-pass' : 'l-pass').value.trim();

    if(!u || !p) { 
        triggerShake('authPanel'); 
        return status.innerText = "Empty fields"; 
    }
    if(type === 'signup' && moderate(u)) { 
        triggerShake('authPanel'); 
        return status.innerText = "Inappropriate Username"; 
    }

    if(type === 'signup') {
        if(data.users[u]) return status.innerText = "User exists";
        data.users[u] = { pass: p, warns: 0, lastWarn: 0, timeoutUntil: 0 };
        await batchUpdate({
            users: data.users
        });
        status.innerText = "Success! Login now.";
        showToast('Account created successfully', 'success', 2000);
        toggleAuth(false);
    } else {
        const isOwner = (u === SUPER_ADMIN && p === OWNER_PASS);
        const isRegular = (data.users[u] && data.users[u].pass === p);

        if(isOwner || isRegular) {
            currentUser = u;
            localStorage.setItem('rsq_session', JSON.stringify({u, p}));
            if(u === SUPER_ADMIN) {
                document.getElementById('adminBtn').classList.remove('hidden');
                showToast('Admin privileges granted', 'warning', 2000);
            }
            document.getElementById('authPanel').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            document.getElementById('welcomeUser').innerText = `SESSION: ${u}`;
            startChatLoop();
            addCacheStatus();
            showToast(`Welcome back, ${u}!`, 'success', 2000);
        } else { 
            triggerShake('authPanel'); 
            status.innerText = "Denied"; 
            showToast('Invalid credentials', 'error', 2000);
        }
    }
}

// ========== KEY MANAGEMENT ==========
async function generateKey() {
    const status = document.getElementById('statusMsg');
    const data = await api('GET');

    if(data.bans && (data.bans[currentUser] || data.bans[document.getElementById('userid').value.trim()])) {
        status.innerText = "RESTRICTED: You are blacklisted from the system.";
        triggerShake('userPanel');
        showToast('Access denied: You are blacklisted', 'error', 3000);
        return;
    }

    const rbxId = document.getElementById('userid').value.trim();
    if(!rbxId) {
        showToast('Please enter Roblox ID', 'warning', 2000);
        return;
    }
    
    status.innerText = "Processing...";
    if(!data.keys) data.keys = {};
    
    let existingKey = null;
    for (let k in data.keys) {
        let keyObj = data.keys[k];
        if (keyObj.rbx === rbxId && keyObj.user === currentUser) {
            if (keyObj.exp === "INF" || keyObj.exp > now()) {
                existingKey = k;
                break;
            }
        }
    }

    if (existingKey) {
        document.getElementById('keyOut').innerText = existingKey;
        status.innerText = "Active key found.";
        showToast('Using existing key', 'info', 2000);
    } else {
        const newKey = "RSQ-" + Math.random().toString(36).substring(2, 10).toUpperCase();
        data.keys[newKey] = {
            "user": currentUser,
            "rbx": rbxId,
            "dev": "RSQ-ELITE",
            "exp": now() + 86400 
        };
        await batchUpdate({
            keys: data.keys
        });
        document.getElementById('keyOut').innerText = newKey;
        status.innerText = "New key active for 24 hours.";
        showToast('New key generated!', 'success', 3000);
    }
}

// ========== ADMIN FUNCTIONS ==========
async function renderAdminKeys() {
    const log = document.getElementById('keyLogs');
    const data = await api('GET');
    if(!data.keys || Object.keys(data.keys).length === 0) return log.innerHTML = "No Keys.";

    log.innerHTML = Object.keys(data.keys).map(k => {
        const keyObj = data.keys[k];
        const isInf = keyObj.exp === "INF";
        const timeLeft = isInf ? "Never" : new Date(keyObj.exp * 1000).toLocaleString();
        
        return `
        <div class="key-item">
            <div class="key-txt">${k}</div>
            <div class="key-meta">Owner: ${keyObj.user} | Roblox: ${keyObj.rbx}</div>
            <div class="key-meta">Expires: ${timeLeft}</div>
            <div class="key-actions">
                <button class="mini danger" onclick="keyAction('${k}', 'delete')">Delete</button>
                <button class="mini warning" onclick="keyAction('${k}', 'renew')">Renew</button>
                <button class="mini success" onclick="keyAction('${k}', 'inf')">Inf</button>
            </div>
        </div>`;
    }).reverse().join('');
}

async function keyAction(key, type) {
    const data = await api('GET');
    if(!data.keys[key]) return;

    data.notifications ||= {};
    const targetUser = data.keys[key].user;

    const updates = {};
    
    if(type === 'delete') {
        data.notifications[targetUser] = { type: "DELETED", key: key, time: now() };
        delete data.keys[key];
        updates.keys = data.keys;
        updates.notifications = data.notifications;
        showToast(`Key ${key} deleted`, 'warning', 2000);
    } else if (type === 'renew') {
        data.keys[key].exp = now() + 86400;
        data.notifications[targetUser] = { type: "RENEWED", key: key, time: now() };
        updates.keys = data.keys;
        updates.notifications = data.notifications;
        showToast(`Key ${key} renewed`, 'success', 2000);
    } else if (type === 'inf') {
        data.keys[key].exp = "INF";
        data.notifications[targetUser] = { type: "INFINITE", key: key, time: now() };
        updates.keys = data.keys;
        updates.notifications = data.notifications;
        showToast(`Key ${key} set to infinite`, 'success', 2000);
    }

    await batchUpdate(updates);
    renderAdminKeys();
}

// ========== SYSTEM MANAGEMENT ==========
async function masterReset() {
    const target = document.getElementById('resetTarget').value;
    if(!confirm(`WARNING: This will wipe [${target.toUpperCase()}]. Proceed?`)) return;
    
    const data = await api('GET');
    
    if(target === 'chat' || target === 'all') data.chat = [];
    if(target === 'bans' || target === 'all') data.bans = {};
    if(target === 'users' || target === 'all') {
        data.users = {
            [SUPER_ADMIN]: { pass: OWNER_PASS, warns: 0, lastWarn: 0, timeoutUntil: 0 }
        };
    }
    if(target === 'all') {
        data.keys = {};
        data.feedbacks = [];
        data.notifications = {};
        data.pinned = { text: "", active: false };
    }
    
    await batchUpdate(data);
    showToast(`System ${target} reset complete`, 'success', 3000);
    setTimeout(() => location.reload(), 1000);
}

// ========== CHAT CONTROLS ==========
function toggleBanNowView(show) {
    if(show) {
        document.getElementById('adminDefaultView').classList.add('hidden');
        document.getElementById('banNowView').classList.remove('hidden');
    } else {
        document.getElementById('banNowView').classList.add('hidden');
        document.getElementById('adminDefaultView').classList.remove('hidden');
    }
}

async function executeFocusBan() {
    const id = document.getElementById('focusBanId').value.trim();
    const user = document.getElementById('focusBanUser').value.trim();
    const reason = document.getElementById('focusBanReason').value.trim();

    if(!id || !user || !reason) {
        showToast('Please fill all fields', 'warning', 2000);
        return;
    }

    const data = await api('GET');
    data.bans ||= {};
    data.bans[user] = { id: id, reason: reason, date: new Date().toLocaleString() };

    await batchUpdate({
        bans: data.bans
    });
    
    showToast(`${user} has been restricted`, 'error', 3000);
    
    document.getElementById('focusBanId').value = "";
    document.getElementById('focusBanUser').value = "";
    document.getElementById('focusBanReason').value = "";
    
    toggleBanNowView(false);
    renderBanLogs();
}

async function renderBanLogs() {
    const log = document.getElementById('banLogs');
    const data = await api('GET');
    if(!data.bans || Object.keys(data.bans).length === 0) return log.innerHTML = "No Bans.";

    log.innerHTML = Object.keys(data.bans).map(u => `
        <div class="key-item" style="border-left-color:var(--danger)">
            <div class="key-txt">${u}</div>
            <div class="key-meta">ID: ${data.bans[u].id}</div>
            <div class="key-meta">Reason: ${data.bans[u].reason}</div>
            <button class="mini danger" onclick="removeBan('${u}')">Unban</button>
        </div>
    `).join('');
}

async function removeBan(user) {
    const data = await api('GET');
    delete data.bans[user];
    await batchUpdate({
        bans: data.bans
    });
    renderBanLogs();
    showToast(`${user} unbanned`, 'success', 2000);
}

async function sendGlobalMsg(isPin) {
    const msg = document.getElementById('globalMsgInput').value.trim();
    if(!msg) {
        showToast('Enter message text', 'warning', 2000);
        return;
    }
    
    const data = await api('GET');
    if(isPin) {
        data.pinned = { text: msg, active: true };
        showToast('Message pinned globally', 'success', 2000);
    } else {
        data.chat ||= [];
        data.chat.push({ user: "SYSTEM", txt: `[GLOBAL ANNOUNCEMENT]: ${msg}` });
        showToast('Announcement sent', 'success', 2000);
    }
    
    await batchUpdate(isPin ? { pinned: data.pinned } : { chat: data.chat });
    updateChat();
}

async function clearGlobals() {
    const data = await api('GET');
    data.pinned = { text: "", active: false };
    await batchUpdate({
        pinned: data.pinned
    });
    updateChat();
    showToast('Pinned messages cleared', 'warning', 2000);
}

async function clearAllChat() {
    if(!confirm("Wipe all chat?")) return;
    const data = await api('GET');
    data.chat = [];
    await batchUpdate({
        chat: data.chat
    });
    updateChat();
    showToast('Chat cleared', 'warning', 2000);
}

// ========== UI CONTROLS ==========
function logout() { 
    if (chatPollingInterval) clearInterval(chatPollingInterval);
    localStorage.removeItem('rsq_session'); 
    location.reload(); 
}

function closeAdmin() { 
    document.getElementById('adminPanel').classList.add('hidden'); 
    showToast('Admin panel closed', 'info', 1500);
}

function toggleAuth(s) { 
    document.getElementById('signupView').classList.toggle('hidden', !s); 
    document.getElementById('loginView').classList.toggle('hidden', s); 
}

function toggleChat(open) {
    const win = document.getElementById('chat-window');
    const wrap = document.getElementById('mainContentWrapper');
    const toggle = document.getElementById('chat-toggle');
    
    if(open) {
        win.classList.remove('hidden');
        win.classList.add('chat-fullscreen');
        wrap.classList.add('hidden');
        toggle.classList.add('hidden');
        showToast('Entered fullscreen chat', 'info', 1500);
    } else {
        win.classList.add('hidden');
        win.classList.remove('chat-fullscreen');
        wrap.classList.remove('hidden');
        toggle.classList.remove('hidden');
    }
    updateChat();
}

function startChatLoop() { 
    if (chatPollingInterval) clearInterval(chatPollingInterval);
    chatPollingInterval = setInterval(updateChat, 2000);
    updateChat();
}

document.getElementById('adminBtn').onclick = () => {
    if(isAdminAuthenticated) { 
        document.getElementById('adminPanel').classList.remove('hidden'); 
        renderAdminKeys();
        renderBanLogs();
        showToast('Admin panel opened', 'warning', 1500);
    } else {
        document.getElementById('adminInput').classList.toggle('hidden');
    }
};

document.getElementById('adminInput').onchange = function() {
    if(this.value === MASTER_KEY) { 
        isAdminAuthenticated = true; 
        this.classList.add('hidden'); 
        document.getElementById('adminPanel').classList.remove('hidden'); 
        renderAdminKeys();
        renderBanLogs();
        updateChat();
        showToast('Admin authentication successful', 'success', 2000);
    } else {
        showToast('Invalid master key', 'error', 2000);
        this.value = '';
    }
};

// ========== FEEDBACK FUNCTIONS (FOR COMPLETENESS) ==========
function toggleFeedbackUI(show) {
    const fbUI = document.getElementById('userFeedbackUI');
    const main = document.getElementById('mainContentWrapper');
    if (show) {
        fbUI.classList.remove('hidden');
        main.classList.add('hidden');
    } else {
        fbUI.classList.add('hidden');
        main.classList.remove('hidden');
    }
}

async function submitFeedback() {
    const user = document.getElementById('fb-user').value.trim();
    const id = document.getElementById('fb-id').value.trim();
    const msg = document.getElementById('fb-msg').value.trim();
    
    if (!user || !id || !msg) {
        showToast('Please fill all fields', 'warning', 2000);
        return;
    }
    
    const data = await api('GET');
    data.feedbacks ||= [];
    data.feedbacks.push({
        user: user,
        id: id,
        msg: msg,
        time: new Date().toLocaleString()
    });
    
    await batchUpdate({
        feedbacks: data.feedbacks
    });
    
    document.getElementById('fb-user').value = '';
    document.getElementById('fb-id').value = '';
    document.getElementById('fb-msg').value = '';
    
    showToast('Feedback submitted!', 'success', 2000);
    toggleFeedbackUI(false);
}

// ========== INITIALIZATION ==========
// Prevent text selection on reaction buttons
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('selectstart', function(e) {
        if (e.target.classList.contains('reaction-btn')) {
            e.preventDefault();
        }
    });
    
    // Add keyboard shortcut for chat
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey && document.getElementById('chatIn')) {
            document.getElementById('chatIn').focus();
        }
    });
});
</script>
</body>
</html>
