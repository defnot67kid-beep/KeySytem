<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RSQ Elite | System Overseer</title>

<style>
:root {
    --primary: #4f7cff;
    --secondary: #00d2ff;
    --danger: #ff3b30;
    --success: #28cd41;
    --warning: #ffcc00;
    --glass: rgba(15, 20, 30, 0.95);
    --border: rgba(255, 255, 255, 0.08);
    --chat-bg: rgba(10, 12, 18, 0.95);
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    background: #05070a;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    color: #f0f0f0;
    overflow: hidden;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Animations */
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
@keyframes spin { to { transform: rotate(360deg); } }

.animate-fade { animation: fadeIn 0.3s ease forwards; }
.animate-slide { animation: slideIn 0.3s ease forwards; }

#bg-wrap { 
    position: fixed; 
    inset: 0; 
    background: radial-gradient(ellipse at top, #0a0e1a 0%, #05070a 70%); 
    z-index: -2; 
}

/* Particle Background */
#particles {
    position: fixed;
    inset: 0;
    z-index: -1;
    pointer-events: none;
}

/* Stats Bar */
.stats-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(10, 12, 18, 0.9);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 8px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    z-index: 9999;
    height: 36px;
}

.stats-item {
    display: flex;
    align-items: center;
    gap: 6px;
    opacity: 0.8;
    transition: opacity 0.2s;
}

.stats-item:hover {
    opacity: 1;
}

.stats-icon {
    font-size: 11px;
}

.stats-value {
    font-weight: 600;
    color: var(--secondary);
    font-family: 'Monaco', 'Consolas', monospace;
}

.stats-label {
    font-size: 10px;
    opacity: 0.7;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Panel Styling */
.panel {
    position: relative;
    z-index: 10;
    width: 420px;
    background: var(--glass);
    backdrop-filter: blur(30px);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.hidden { display: none !important; }

/* Form Elements */
input, select, textarea {
    width: 100%;
    padding: 12px 16px;
    margin-top: 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: white;
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s;
    outline: none;
}

input:focus, select:focus, textarea:focus {
    border-color: var(--primary);
    background: rgba(0, 0, 0, 0.4);
    box-shadow: 0 0 0 2px rgba(79, 124, 255, 0.1);
}

/* Buttons */
button {
    width: 100%;
    padding: 12px 20px;
    margin-top: 16px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
}

button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: 0.5s;
}

button:hover::before {
    left: 100%;
}

button:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(79, 124, 255, 0.2);
}

button:active {
    transform: translateY(0);
}

button.danger { background: linear-gradient(135deg, #ff3b30, #ff6b52); }
button.warning { background: linear-gradient(135deg, #ffcc00, #ffaa00); color: #000; }
button.success { background: linear-gradient(135deg, #28cd41, #2ee058); }
button.mini { 
    padding: 4px 10px; 
    font-size: 11px; 
    margin-top: 0; 
    width: auto; 
    border-radius: 8px; 
}

/* Chat Toggle */
#chat-toggle {
    position: fixed; 
    bottom: 25px; 
    right: 25px; 
    width: 56px; 
    height: 56px;
    border-radius: 50%; 
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    display: flex;
    align-items: center; 
    justify-content: center; 
    cursor: pointer; 
    z-index: 1000;
    box-shadow: 
        0 6px 20px rgba(0,0,0,0.3),
        0 0 0 1px rgba(255, 255, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
}

#chat-toggle:hover {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 
        0 10px 30px rgba(79, 124, 255, 0.3),
        0 0 0 1px rgba(255, 255, 255, 0.2);
}

#chat-toggle svg { 
    width: 24px; 
    height: 24px; 
    fill: white; 
}

#unread-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--danger);
    color: white;
    font-size: 10px;
    font-weight: 700;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

/* Chat Window */
#chat-window {
    position: fixed;
    bottom: 100px;
    right: 25px;
    width: 380px;
    height: 520px;
    background: var(--chat-bg);
    backdrop-filter: blur(30px);
    border: 1px solid var(--border);
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    z-index: 999;
    overflow: hidden;
    box-shadow: 
        0 25px 80px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.chat-fullscreen {
    bottom: 0 !important; 
    right: 0 !important;
    width: 100vw !important; 
    height: 100vh !important;
    border-radius: 0 !important;
    z-index: 5000 !important;
}

/* Chat Header */
.chat-header {
    padding: 16px 20px;
    background: rgba(255, 255, 255, 0.03);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
}

.chat-header-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--secondary);
    letter-spacing: 0.5px;
}

.chat-header-stats {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 11px;
    opacity: 0.7;
}

.chat-header-stats span {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Chat Messages Container */
#chat-msgs {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    scroll-behavior: smooth;
    background: rgba(5, 7, 10, 0.4);
}

/* Pinned Message */
#pinned-area {
    background: linear-gradient(90deg, rgba(255, 204, 0, 0.1), rgba(255, 204, 0, 0.05));
    border-bottom: 1px solid rgba(255, 204, 0, 0.3);
    padding: 10px 16px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
}

#pinned-area .pin-icon {
    color: var(--warning);
    font-size: 12px;
    flex-shrink: 0;
}

#pinned-area .pin-text {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Message Items */
.msg-item {
    margin-bottom: 12px;
    padding: 12px;
    border-radius: 12px;
    animation: fadeIn 0.2s ease forwards;
    position: relative;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.2s;
}

.msg-item:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

.msg-item.system {
    background: rgba(79, 124, 255, 0.08);
    border-color: rgba(79, 124, 255, 0.2);
    border-left: 3px solid var(--primary);
}

.msg-item.owner-msg {
    background: rgba(255, 204, 0, 0.05);
    border-color: rgba(255, 204, 0, 0.15);
    border-left: 3px solid var(--warning);
}

.msg-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
}

.msg-user {
    font-weight: 600;
    font-size: 12px;
    color: var(--secondary);
    display: flex;
    align-items: center;
    gap: 6px;
}

.msg-user .owner-badge {
    color: var(--warning);
    font-size: 10px;
}

.msg-time {
    font-size: 10px;
    opacity: 0.5;
    font-family: 'Monaco', 'Consolas', monospace;
}

.msg-content {
    font-size: 13px;
    line-height: 1.4;
    margin-bottom: 8px;
    word-break: break-word;
}

/* Reply Quote */
.reply-quote {
    font-size: 11px;
    opacity: 0.7;
    padding-left: 10px;
    border-left: 2px solid var(--primary);
    margin-bottom: 8px;
    font-style: italic;
    background: rgba(79, 124, 255, 0.05);
    padding: 6px 10px;
    border-radius: 6px;
}

/* Message Actions */
.msg-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: none;
    gap: 4px;
    background: rgba(20, 25, 35, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px;
    z-index: 10;
}

.msg-item:hover .msg-actions {
    display: flex;
}

.action-btn {
    width: 24px;
    height: 24px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 11px;
    transition: all 0.2s;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    padding: 0;
    margin: 0;
}

.action-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    transform: scale(1.1);
}

.action-btn.delete:hover {
    background: rgba(255, 59, 48, 0.2);
    color: var(--danger);
}

/* Emoji Picker */
.emoji-picker {
    position: absolute;
    bottom: 45px;
    right: 8px;
    background: rgba(20, 25, 35, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 8px;
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 4px;
    z-index: 100;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    animation: fadeIn 0.2s ease;
}

.emoji-btn {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    background: transparent;
    border: none;
    padding: 0;
}

.emoji-btn:hover {
    background: rgba(79, 124, 255, 0.2);
    transform: scale(1.2);
}

/* Reactions */
.reactions-container {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
    margin-top: 6px;
    padding-top: 6px;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.reaction-btn-small {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    padding: 1px 6px;
    background: rgba(79, 124, 255, 0.1);
    border: 1px solid rgba(79, 124, 255, 0.15);
    border-radius: 8px;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
    height: 20px;
    line-height: 1;
}

.reaction-btn-small:hover {
    background: rgba(79, 124, 255, 0.2);
    border-color: rgba(79, 124, 255, 0.3);
    transform: translateY(-1px);
}

.reaction-btn-small.active {
    background: rgba(79, 124, 255, 0.25);
    border-color: var(--primary);
    box-shadow: 0 0 0 1px rgba(79, 124, 255, 0.3);
}

.reaction-emoji-small {
    font-size: 10px;
}

.reaction-count-small {
    font-weight: 600;
    color: var(--secondary);
    font-size: 9px;
    min-width: 8px;
}

/* Chat Input Area */
.chat-input-area {
    padding: 16px;
    background: rgba(255, 255, 255, 0.02);
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex-shrink: 0;
}

.reply-preview {
    background: rgba(79, 124, 255, 0.1);
    border-radius: 8px;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 11px;
    animation: slideIn 0.2s ease;
}

.reply-preview-text {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    opacity: 0.9;
}

.cancel-reply {
    cursor: pointer;
    color: var(--danger);
    font-size: 12px;
    padding: 2px;
    border-radius: 4px;
    transition: all 0.2s;
}

.cancel-reply:hover {
    background: rgba(255, 59, 48, 0.1);
}

.chat-input-row {
    display: flex;
    gap: 10px;
    align-items: center;
}

#chat-input {
    flex: 1;
    margin: 0;
    padding: 12px 16px;
    font-size: 13px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border);
    border-radius: 10px;
    min-height: 40px;
    resize: none;
    line-height: 1.4;
}

#chat-input:focus {
    background: rgba(0, 0, 0, 0.4);
    border-color: var(--primary);
}

#send-chat-btn {
    margin: 0;
    width: 80px;
    padding: 10px;
    font-size: 12px;
    font-weight: 600;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
}

/* Scrollbar Styling */
#chat-msgs::-webkit-scrollbar {
    width: 6px;
}

#chat-msgs::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 3px;
}

#chat-msgs::-webkit-scrollbar-thumb {
    background: rgba(79, 124, 255, 0.2);
    border-radius: 3px;
}

#chat-msgs::-webkit-scrollbar-thumb:hover {
    background: rgba(79, 124, 255, 0.3);
}

/* Admin Panel */
.adminFull {
    position: fixed;
    inset: 15px;
    background: rgba(10, 12, 18, 0.98);
    backdrop-filter: blur(30px);
    border-radius: 20px;
    padding: 25px;
    z-index: 2000;
    overflow-y: auto;
    border: 1px solid var(--border);
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
}

.log-box {
    background: rgba(255, 255, 255, 0.03);
    padding: 15px;
    border-radius: 12px;
    height: 350px;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

/* Toast Notifications */
.toast {
    position: fixed;
    top: 50px;
    right: 20px;
    background: rgba(20, 25, 35, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 18px;
    z-index: 10000;
    animation: slideIn 0.3s ease;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    max-width: 300px;
    border-left: 3px solid var(--primary);
}

.toast.success { border-left-color: var(--success); }
.toast.warning { border-left-color: var(--warning); }
.toast.error { border-left-color: var(--danger); }

/* Spinner */
.spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 0.8s linear infinite;
}

/* Back Button */
.back-btn-container {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 100;
}

/* Typing Indicator */
.typing-indicator {
    font-size: 11px;
    opacity: 0.7;
    padding: 0 16px 8px;
    font-style: italic;
    color: var(--secondary);
}

.typing-dots {
    display: inline-block;
}

.typing-dots span {
    animation: pulse 1.4s infinite;
    display: inline-block;
}

.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }

/* Empty State */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: rgba(255, 255, 255, 0.5);
    font-size: 13px;
}

.empty-state-icon {
    font-size: 32px;
    margin-bottom: 10px;
    opacity: 0.3;
}

/* Connection Status */
.connection-status {
    position: fixed;
    bottom: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    padding: 4px 10px;
    border-radius: 10px;
    font-size: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
    z-index: 10000;
    opacity: 0.7;
    transition: opacity 0.3s;
}

.connection-status:hover {
    opacity: 1;
}

.connection-status.connected .status-dot {
    background: var(--success);
    box-shadow: 0 0 8px var(--success);
}

.connection-status.disconnected .status-dot {
    background: var(--danger);
    box-shadow: 0 0 8px var(--danger);
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

/* NEW: GAME MANAGEMENT STYLES */
.game-management-section {
    background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.3s ease;
}

.game-management-section:hover {
    border-color: rgba(255,255,255,0.1);
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.game-create-container {
    max-width: 500px;
    margin: 0 auto;
    padding: 25px;
    background: rgba(255,255,255,0.02);
    border-radius: 15px;
    border: 1px solid var(--border);
}

.image-preview-container {
    width: 120px;
    height: 120px;
    border-radius: 12px;
    border: 2px dashed var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 15px auto;
    overflow: hidden;
    background: rgba(0,0,0,0.3);
    cursor: pointer;
    transition: all 0.3s ease;
}

.image-preview-container:hover {
    border-color: var(--primary);
    background: rgba(79, 124, 255, 0.05);
}

.image-preview {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
}

.image-placeholder {
    text-align: center;
    color: rgba(255,255,255,0.5);
    font-size: 12px;
    padding: 10px;
}

.image-placeholder .icon {
    font-size: 24px;
    margin-bottom: 8px;
    display: block;
}

/* Games Dashboard */
.games-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.game-card {
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    padding: 15px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.game-card:hover {
    background: rgba(255,255,255,0.05);
    border-color: var(--primary);
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(79, 124, 255, 0.1);
}

.game-card-image {
    width: 100%;
    height: 100px;
    border-radius: 8px;
    object-fit: cover;
    margin-bottom: 10px;
    background: rgba(0,0,0,0.3);
}

.game-card-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 5px;
    color: white;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.game-card-id {
    font-size: 10px;
    opacity: 0.7;
    font-family: monospace;
    margin-bottom: 8px;
}

.game-card-scripts {
    font-size: 11px;
    opacity: 0.8;
    background: rgba(79, 124, 255, 0.1);
    padding: 3px 8px;
    border-radius: 10px;
    display: inline-block;
}

/* Script Management */
.script-management-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 25px;
    background: rgba(255,255,255,0.02);
    border-radius: 15px;
    border: 1px solid var(--border);
}

.current-game-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border);
}

.current-game-image {
    width: 60px;
    height: 60px;
    border-radius: 10px;
    object-fit: cover;
}

.current-game-info h3 {
    margin: 0;
    font-size: 18px;
    color: white;
}

.current-game-info p {
    margin: 5px 0 0;
    font-size: 12px;
    opacity: 0.7;
    font-family: monospace;
}

.scripts-list {
    max-height: 400px;
    overflow-y: auto;
    margin: 20px 0;
    padding-right: 10px;
}

.script-item {
    background: rgba(255,255,255,0.03);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.2s ease;
}

.script-item:hover {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.1);
}

.script-url {
    font-family: monospace;
    font-size: 12px;
    color: var(--secondary);
    word-break: break-all;
    margin-bottom: 8px;
}

.script-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.add-script-form {
    background: rgba(79, 124, 255, 0.05);
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
    border: 1px solid rgba(79, 124, 255, 0.1);
}

.add-script-form h4 {
    margin-top: 0;
    margin-bottom: 15px;
    color: var(--secondary);
}

.empty-state-games {
    text-align: center;
    padding: 60px 20px;
    color: rgba(255,255,255,0.5);
}

.empty-state-games .icon {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.3;
}

.empty-state-games p {
    font-size: 14px;
    margin-bottom: 20px;
}

/* File Input */
.file-input-wrapper {
    position: relative;
    margin: 15px 0;
}

.file-input-wrapper input[type="file"] {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.file-input-label {
    display: block;
    padding: 12px 20px;
    background: rgba(79, 124, 255, 0.1);
    border: 2px dashed rgba(79, 124, 255, 0.3);
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--secondary);
    font-weight: 500;
}

.file-input-label:hover {
    background: rgba(79, 124, 255, 0.15);
    border-color: var(--primary);
}

.file-input-label .icon {
    margin-right: 8px;
}

/* Back Navigation */
.back-nav {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    cursor: pointer;
    color: var(--secondary);
    font-weight: 500;
    transition: all 0.2s ease;
}

.back-nav:hover {
    color: white;
    transform: translateX(-3px);
}

.back-nav .icon {
    font-size: 18px;
}

/* Game Actions */
.game-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.game-card:hover .game-actions {
    opacity: 1;
}

.game-action-btn {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    color: rgba(255,255,255,0.7);
    transition: all 0.2s ease;
}

.game-action-btn:hover {
    background: rgba(255,255,255,0.1);
    color: white;
    transform: scale(1.1);
}

.game-action-btn.delete:hover {
    background: rgba(255, 59, 48, 0.2);
    color: var(--danger);
}

/* Dashboard Header */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.dashboard-header h3 {
    margin: 0;
}

.dashboard-stats {
    display: flex;
    gap: 15px;
    font-size: 12px;
    opacity: 0.8;
}

.dashboard-stats span {
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(5, 7, 10, 0.9);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    flex-direction: column;
    gap: 20px;
}

.loading-spinner-large {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255,255,255,0.1);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s linear infinite;
}

.loading-text {
    color: var(--secondary);
    font-size: 14px;
    font-weight: 500;
}

/* Feedback UI */
.fb-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    margin-bottom: 8px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.2s ease;
}

.fb-item:hover {
    background: rgba(255,255,255,0.08);
    border-color: rgba(255,255,255,0.1);
}

/* Gradient Text */
.gradient-text {
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
</style>
</head>
<body>

<!-- Stats Bar -->
<div class="stats-bar">
    <div class="stats-item">
        <span class="stats-icon">üëÅÔ∏è</span>
        <span class="stats-label">Views:</span>
        <span class="stats-value" id="viewCount">0</span>
    </div>
    <div class="stats-item">
        <span class="stats-icon">‚ö°</span>
        <span class="stats-label">Live Active:</span>
        <span class="stats-value" id="activeCount">0</span>
    </div>
    <div class="stats-item">
        <span class="stats-icon">üïí</span>
        <span class="stats-label" id="currentTime">00:00</span>
    </div>
</div>

<!-- Particle Background -->
<canvas id="particles"></canvas>
<div id="bg-wrap"></div>

<!-- Connection Status -->
<div class="connection-status connected" id="connectionStatus">
    <div class="status-dot"></div>
    <span>Connected</span>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner-large"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
</div>

<!-- Auth Panel -->
<div id="authPanel" class="panel animate-fade">
    <div style="text-align:center; margin-bottom:30px;">
        <h1 style="margin:0; font-size:32px;" class="gradient-text">RSQ GATE</h1>
        <p style="font-size:12px; opacity:0.7; margin-top:8px;">Secure Access System</p>
    </div>
    
    <div id="loginView">
        <input id="l-user" placeholder="Username" autocomplete="username">
        <input id="l-pass" type="password" placeholder="Password" autocomplete="current-password">
        <button onclick="handleAuth('login')">
            <span>Sign In</span>
            <span class="spinner" style="display:none; margin-left:10px;" id="loginSpinner"></span>
        </button>
        <p style="text-align:center; font-size:12px; margin-top:20px; opacity:0.7;">
            New here? <a href="#" onclick="toggleAuth(true)" style="color:var(--secondary); text-decoration:none; font-weight:600;">Create Account</a>
        </p>
    </div>
    
    <div id="signupView" class="hidden">
        <input id="s-user" placeholder="Choose Username" autocomplete="username">
        <input id="s-pass" type="password" placeholder="Choose Password" autocomplete="new-password">
        <button onclick="handleAuth('signup')">
            <span>Sign Up</span>
            <span class="spinner" style="display:none; margin-left:10px;" id="signupSpinner"></span>
        </button>
        <p style="text-align:center; font-size:12px; margin-top:20px; opacity:0.7;">
            Have account? <a href="#" onclick="toggleAuth(false)" style="color:var(--secondary); text-decoration:none; font-weight:600;">Sign In</a>
        </p>
    </div>
    
    <div id="authStatus" style="text-align:center; color:var(--danger); font-size:12px; margin-top:15px; min-height:18px;"></div>
</div>

<!-- User Feedback UI -->
<div id="userFeedbackUI" class="panel animate-fade hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;" class="gradient-text">üìù FEEDBACK</h2>
        <button class="mini danger" onclick="toggleFeedbackUI(false)" style="padding:6px 12px;">‚úï Exit</button>
    </div>
    
    <input id="fb-user" placeholder="Roblox Username" style="margin-bottom:10px;">
    <input id="fb-id" placeholder="Roblox UserID" style="margin-bottom:15px;">
    
    <div style="position:relative;">
        <textarea id="fb-msg" placeholder="Write your feedback here..." style="width:100%; height:120px; background:rgba(0,0,0,0.3); color:white; border:1px solid var(--border); border-radius:10px; padding:12px; resize:none; font-size:13px;"></textarea>
        <div style="position:absolute; right:12px; bottom:12px; font-size:10px; opacity:0.5;" id="fbCharCount">0/500</div>
    </div>
    
    <button onclick="submitFeedback()" style="margin-top:15px;">
        <span>Submit Feedback</span>
        <span class="spinner" style="display:none; margin-left:10px;" id="fbSpinner"></span>
    </button>
</div>

<!-- Main System -->
<div id="mainSystem" class="hidden">
    <div id="mainContentWrapper">
        <div id="userPanel" class="panel animate-fade">
            <div style="text-align:center; margin-bottom:25px;">
                <h1 style="margin:0; font-size:28px;" class="gradient-text">RSQ ELITE</h1>
                <p id="welcomeUser" style="font-size:11px; opacity:0.5; margin-top:5px;"></p>
            </div>
            
            <input id="userid" placeholder="Roblox UserID">
            <button id="genBtn" onclick="generateKey()">
                <span>Generate Access Key</span>
                <span class="spinner" style="display:none; margin-left:10px;" id="keySpinner"></span>
            </button>
            
            <div id="statusMsg" style="text-align:center; margin-top:15px; font-size:12px; color:var(--danger); min-height:18px;"></div>
            
            <div id="keyOut" style="text-align:center; margin-top:15px; color:var(--secondary); font-family:monospace; font-weight:bold; font-size:16px; padding:12px; background:rgba(0,0,0,0.3); border-radius:10px; border:1px solid rgba(79, 124, 255, 0.3); word-break: break-all;"></div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:25px;">
                <button id="adminBtn" class="danger hidden">üëë Admin</button>
                <div style="display:flex; gap:10px;">
                    <button onclick="toggleFeedbackUI(true)" style="background:linear-gradient(135deg, #8a2be2, #4f7cff);">üí¨ Feedback</button>
                    <button onclick="logout()" style="background:rgba(255,255,255,0.05); border:1px solid var(--border);">üö™ Logout</button>
                </div>
            </div>
            
            <input id="adminInput" class="hidden" type="password" placeholder="Master Key" style="margin-top:15px;">
        </div>
    </div>

    <!-- Chat Toggle -->
    <div id="chat-toggle" onclick="toggleChat(true)">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
        <div id="unread-badge" class="hidden">0</div>
    </div>

    <!-- Chat Window -->
    <div id="chat-window" class="hidden">
        <div class="back-btn-container">
            <button onclick="toggleChat(false)" class="mini danger" style="background:rgba(255,59,48,0.2); border:1px solid var(--danger);">‚Üê BACK</button>
        </div>
        
        <div class="chat-header">
            <div class="chat-header-title">NETWORK CHAT</div>
            <div class="chat-header-stats">
                <span><span class="stats-icon">üë§</span> <span id="chatOnlineCount">0</span></span>
                <span><span class="stats-icon">üí¨</span> <span id="chatMessageCount">0</span></span>
            </div>
        </div>
        
        <div id="pinned-area" class="hidden">
            <span class="pin-icon">üìå</span>
            <span class="pin-text" id="pinnedText"></span>
        </div>
        
        <div id="chat-msgs"></div>
        
        <!-- Typing Indicator -->
        <div id="typingIndicator" class="typing-indicator hidden">
            <span id="typingUsers"></span>
            <span class="typing-dots">
                <span>.</span><span>.</span><span>.</span>
            </span>
        </div>
        
        <!-- Input Area -->
        <div class="chat-input-area">
            <div id="reply-preview" class="reply-preview hidden">
                <span class="reply-preview-text" id="replyPreviewText"></span>
                <span class="cancel-reply" onclick="cancelReply()">‚úï</span>
            </div>
            
            <div class="chat-input-row">
                <textarea id="chat-input" placeholder="Type a message..." rows="1"></textarea>
                <button id="send-chat-btn" onclick="sendChat()">SEND</button>
            </div>
        </div>
    </div>
</div>

<!-- COMPLETE ADMIN PANEL WITH GAME MANAGEMENT -->
<div id="adminPanel" class="adminFull hidden">
    <!-- Default Admin View -->
    <div id="adminDefaultView">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <div>
                <h2 style="margin:0;" class="gradient-text">üëë OVERSEER CONTROL</h2>
                <p style="font-size:11px; opacity:0.7; margin-top:5px;">Total Control Panel v2.1</p>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="success" onclick="showGameCreateView()" style="width:auto; margin:0; padding:10px 20px;">
                    üéÆ Create Game
                </button>
                <button class="danger" onclick="toggleBanNowView(true)" style="width:auto; margin:0; padding:10px 20px;">
                    ‚ö° BAN NOW
                </button>
                <button class="warning" onclick="openAdminFeedbacks()" style="width:auto; margin:0; padding:10px 20px;">
                    üì© Feedbacks
                </button>
                <button onclick="closeAdmin()" style="width:auto; margin:0; background:#444; padding:10px 20px;">
                    üö™ Exit
                </button>
            </div>
        </div>

        <!-- Games Dashboard -->
        <div class="game-management-section">
            <div class="dashboard-header">
                <h3>üéÆ Game Management</h3>
                <div class="dashboard-stats">
                    <span><span class="stats-icon">üìÅ</span> <span id="totalGames">0 games</span></span>
                    <span><span class="stats-icon">üìú</span> <span id="totalScripts">0 scripts</span></span>
                </div>
            </div>
            
            <div id="gamesDashboard" class="games-dashboard">
                <!-- Games will be loaded here -->
            </div>
            
            <div id="noGamesMessage" class="empty-state-games hidden">
                <div class="icon">üéÆ</div>
                <p>No games created yet. Create your first game to get started!</p>
                <button class="success" onclick="showGameCreateView()" style="width:auto; margin:0; padding:10px 25px;">
                    üéÆ Create First Game
                </button>
            </div>
        </div>

        <!-- Broadcast & Chat Controls -->
        <div class="admin-section">
            <h3 style="margin-top:0; display:flex; align-items:center; gap:10px;">üî® Broadcast & Chat Controls</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div>
                    <input id="globalMsgInput" placeholder="Broadcast Text" style="margin:0;">
                    <p style="font-size:10px; opacity:0.7; margin-top:5px;">Maximum 200 characters</p>
                </div>
                <div style="display:flex; gap:10px; align-items:flex-start;">
                    <button class="warning" onclick="sendGlobalMsg(true)" style="margin:0; flex:1;">üìå PIN LIVE</button>
                    <button class="warning" onclick="sendGlobalMsg(false)" style="margin:0; flex:1;">üì¢ ANNOUNCE</button>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                <button class="danger" onclick="clearGlobals()">üßπ PURGE GLOBALS</button>
                <button class="danger" onclick="clearAllChat()">üí• WIPE CHAT</button>
            </div>
        </div>

        <!-- Global Access Control -->
        <div class="admin-section" style="border-color:var(--danger); background:linear-gradient(145deg, rgba(255, 59, 48, 0.1), rgba(255, 59, 48, 0.05));">
            <h3 style="margin-top:0; color:var(--danger); display:flex; align-items:center; gap:10px;">‚ö†Ô∏è GLOBAL ACCESS CONTROL</h3>
            <p style="font-size: 11px; opacity: 0.8; margin-top: -5px; margin-bottom: 15px;">Warning: These actions affect all users system-wide.</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <button class="danger" onclick="banAllKeyHolders()" style="margin:0; padding:12px;">‚õî BAN ALL KEY HOLDERS</button>
                <button class="success" onclick="unbanEveryone()" style="margin:0; padding:12px;">‚úÖ UNBAN ALL USERS</button>
            </div>
        </div>

        <!-- System Reset -->
        <div class="admin-section" style="border-color:var(--danger);">
            <h3 style="margin-top:0; color:var(--danger); display:flex; align-items:center; gap:10px;">‚ò¢Ô∏è SYSTEM RESET</h3>
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px; align-items:center;">
                <div>
                    <select id="resetTarget" style="margin:0; padding:12px;">
                        <option value="chat">üóëÔ∏è Clear Chat History Only</option>
                        <option value="bans">üö´ Clear All Blacklists (Bans)</option>
                        <option value="users">üë• Clear All User Accounts</option>
                        <option value="all">üí£ FACTORY RESET (Wipe Everything)</option>
                    </select>
                    <p style="font-size:10px; opacity:0.7; margin-top:5px;">Select reset target</p>
                </div>
                <button class="danger" onclick="masterReset()" style="margin:0; padding:12px;">üöÄ EXECUTE</button>
            </div>
        </div>

        <!-- Blacklist and Keys -->
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
            <div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0;">üö´ Active Blacklist</h3>
                    <span style="font-size:10px; opacity:0.7;" id="banCount">0 banned</span>
                </div>
                <div id="banLogs" class="log-box"></div>
            </div>
            <div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0;">üîë System Keys</h3>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <span style="font-size:10px; opacity:0.7;" id="keyCount">0 keys</span>
                        <button class="mini" onclick="renderAdminKeys()" style="padding:4px 8px;">üîÑ</button>
                    </div>
                </div>
                <div id="keyLogs" class="log-box"></div>
            </div>
        </div>
    </div>

    <!-- Game Creation View -->
    <div id="gameCreateView" class="hidden">
        <div class="back-nav" onclick="showGamesDashboard()">
            <span class="icon">‚Üê</span>
            <span>Back to Dashboard</span>
        </div>
        
        <div class="game-create-container">
            <h2 style="margin-top:0; text-align:center; margin-bottom:25px;">üéÆ Create New Game</h2>
            
            <!-- Image Preview -->
            <div class="image-preview-container" onclick="document.getElementById('gameImageInput').click()">
                <img id="gameImagePreview" class="image-preview" alt="Game Image">
                <div class="image-placeholder" id="imagePlaceholder">
                    <span class="icon">üìÅ</span>
                    Click to upload image
                    <br>
                    <small style="font-size:10px;">Max 2MB ‚Ä¢ JPG, PNG, GIF</small>
                </div>
            </div>
            
            <input type="file" id="gameImageInput" accept="image/*" class="hidden">
            
            <!-- Game Name -->
            <div style="margin: 20px 0;">
                <label style="font-size:12px; opacity:0.8; margin-bottom:5px; display:block;">Game Name</label>
                <input type="text" id="gameNameInput" placeholder="Enter game name" maxlength="50">
            </div>
            
            <!-- Game ID -->
            <div style="margin: 20px 0;">
                <label style="font-size:12px; opacity:0.8; margin-bottom:5px; display:block;">Roblox Game ID</label>
                <input type="text" id="gameIdInput" placeholder="Enter Roblox Place ID" pattern="\d+" maxlength="10">
                <p style="font-size:10px; opacity:0.7; margin-top:5px;">Enter the numeric Place ID from Roblox</p>
            </div>
            
            <!-- Create Button -->
            <button class="success" onclick="createGame()" style="margin-top:25px;">
                <span>üéÆ Create Game</span>
            </button>
            
            <div id="gameCreateStatus" style="text-align:center; margin-top:15px; font-size:12px; color:var(--danger); min-height:18px;"></div>
        </div>
    </div>

    <!-- Script Management View -->
    <div id="scriptManagementView" class="hidden">
        <div class="back-nav" onclick="showGamesDashboard()">
            <span class="icon">‚Üê</span>
            <span>Back to Dashboard</span>
        </div>
        
        <div class="script-management-container">
            <div class="current-game-header">
                <img id="currentGameImage" class="current-game-image" alt="Game Image">
                <div class="current-game-info">
                    <h3 id="currentGameName"></h3>
                    <p id="currentGameId"></p>
                </div>
            </div>
            
            <h3 style="margin-top:0;">üìú Script Management</h3>
            
            <div id="scriptsList" class="scripts-list">
                <!-- Scripts will be loaded here -->
            </div>
            
            <div id="noScriptsMessage" class="empty-state-games hidden">
                <div class="icon">üìú</div>
                <p>No scripts added yet. Add your first script below.</p>
            </div>
            
            <!-- Add Script Form -->
            <div class="add-script-form">
                <h4>‚ûï Add New Script</h4>
                <input type="text" id="scriptUrlInput" placeholder="Paste script URL here..." style="margin-bottom:15px;">
                <p style="font-size:11px; opacity:0.7; margin-top:5px; margin-bottom:15px;">
                    Paste the direct URL to your script. Make sure it's accessible.
                </p>
                <button onclick="addScriptToGame()" style="width:auto; margin:0;">
                    <span>‚ûï Add Script</span>
                </button>
                <div id="scriptAddStatus" style="text-align:center; margin-top:10px; font-size:12px; color:var(--danger); min-height:18px;"></div>
            </div>
        </div>
    </div>

    <!-- Ban Now View -->
    <div id="banNowView" class="hidden">
        <div class="ban-focus-container">
            <div style="text-align:center; margin-bottom:25px;">
                <h2 style="color:var(--danger); margin:0; font-size:24px;" class="gradient-text">üî® RESTRICT USER</h2>
                <p style="font-size:11px; opacity:0.7; margin-top:5px;">Immediate action required</p>
            </div>
            
            <input id="focusBanId" placeholder="Roblox UserID" style="margin-bottom:15px;">
            <input id="focusBanUser" placeholder="Username to Ban" style="margin-bottom:15px;">
            
            <div style="position:relative;">
                <textarea id="focusBanReason" placeholder="Reason for restriction..." style="height:100px; resize:none; margin-bottom:20px;"></textarea>
                <div style="position:absolute; right:12px; bottom:30px; font-size:10px; opacity:0.5;" id="reasonCharCount">0/200</div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <button class="danger" onclick="executeFocusBan()" style="padding:12px;">‚ö° BAN USER</button>
                <button onclick="toggleBanNowView(false)" style="background:#444; padding:12px;">‚Ü©Ô∏è CANCEL</button>
            </div>
        </div>
    </div>

    <!-- Admin Feedback List View -->
    <div id="adminFeedbackListView" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div>
                <h2 style="margin:0;" class="gradient-text">üì© USER FEEDBACKS</h2>
                <p style="font-size:11px; opacity:0.7; margin-top:5px;">Read and manage user submissions</p>
            </div>
            <button onclick="returnToAdminPanel()" style="width:auto; margin:0; background:#444; padding:10px 20px;">‚Ü©Ô∏è Return</button>
        </div>
        
        <div style="position:relative;">
            <input id="fbSearch" placeholder="Search UserID or Username..." oninput="renderAdminFeedbacks()" style="padding:12px; font-size:13px;">
            <div style="position:absolute; right:12px; top:50%; transform:translateY(-50%); opacity:0.5;">üîç</div>
        </div>
        
        <div id="fbLogs" class="log-box" style="margin-top:15px; height: 500px;"></div>
    </div>

    <!-- Admin View Feedback UI -->
    <div id="adminViewFeedbackUI" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 id="viewFbTitle" style="margin:0;" class="gradient-text">üìÑ FEEDBACK VIEW</h2>
            <button onclick="closeSingleFeedback()" style="width:auto; margin:0; background:var(--danger); padding:10px 20px;">‚úï Close</button>
        </div>
        <div id="viewFbContent" style="background:linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); padding:25px; border-radius:15px; margin-top:20px; line-height: 1.6; min-height: 200px; border:1px solid rgba(255,255,255,0.1);"></div>
    </div>
</div>

<script>
// ========== CONFIGURATION ==========
const BIN_ID = "694c4aefae596e708faef157";
const JSON_KEY = "$2a$10$DgQd.qgYLB2nv9e9ZFktKeUUkzZfmqPnL4Fk7JLvnN/ASlctW.8Cu";
const MASTER_KEY = "roblox";
const SUPER_ADMIN = "plstealme2";
const OWNER_PASS = "RSQ-OWNER-PLSTEALME2";

const MOD_CONFIG = {
    BANNED: [/fuck/gi, /shit/gi, /nigger/gi, /faggot/gi, /retard/gi, /bitch/gi, /porn/gi, /sex/gi],
    LEET: { '0':'o', '1':'i', '3':'e', '4':'a', '5':'s', '7':'t', '8':'b', '@':'a', '$':'s', '!':'i', '*':'' }
};

// ========== STATE MANAGEMENT ==========
let dataCache = null;
let lastFetchTime = 0;
const CACHE_TTL = 1000;
let pendingUpdates = [];
let isUpdating = false;

let currentUser = null;
let isAdminAuthenticated = false;
let activeReplyTarget = null;
let activeEmojiPicker = null;
let chatPollingInterval = null;
let statsPollingInterval = null;
let typingTimeout = null;
let lastTypingTime = 0;

let unreadCount = 0;
let lastSeenMessageTime = 0;

// User activity tracking
let userLastActivity = {};
const ACTIVITY_TIMEOUT = 30000;

// View tracking
let hasTrackedView = false;
const USER_ID_KEY = 'rsq_user_id';

// Game management
let currentGameId = null;
let selectedGame = null;
let gameImageData = null;

// ========== UTILITY FUNCTIONS ==========
function now() { return Math.floor(Date.now()/1000); }

function moderate(text) {
    if (!text) return false;
    let clean = text.toLowerCase();
    for (let key in MOD_CONFIG.LEET) { 
        clean = clean.split(key).join(MOD_CONFIG.LEET[key]); 
    }
    clean = clean.replace(/[^a-zA-Z ]/g, "");
    return MOD_CONFIG.BANNED.some(regex => regex.test(clean) || regex.test(text));
}

function showToast(message, type = 'info', duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

function generateUserId() {
    return 'user_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
}

function getUserIdentifier() {
    let userId = localStorage.getItem(USER_ID_KEY);
    if (!userId) {
        userId = generateUserId();
        localStorage.setItem(USER_ID_KEY, userId);
    }
    return userId;
}

// ========== LOADING FUNCTIONS ==========
function showLoading(message = 'Loading...') {
    document.getElementById('loadingText').textContent = message;
    document.getElementById('loadingOverlay').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
}

// ========== VIEW & ACTIVE TRACKING ==========
async function trackViewAndActivity() {
    const userId = getUserIdentifier();
    const currentTime = Date.now();
    
    const data = await api('GET');
    
    if (!data.views) data.views = {};
    if (!data.activity) data.activity = {};
    
    if (!data.views[userId]) {
        data.views[userId] = currentTime;
        hasTrackedView = true;
    }
    
    data.activity[userId] = currentTime;
    
    for (const activeUserId in data.activity) {
        if (currentTime - data.activity[activeUserId] > ACTIVITY_TIMEOUT) {
            delete data.activity[activeUserId];
        }
    }
    
    await batchUpdate({
        views: data.views,
        activity: data.activity
    });
    
    updateStatsDisplay(data);
}

function updateStatsDisplay(data) {
    const viewCount = data.views ? Object.keys(data.views).length : 0;
    const activeCount = data.activity ? Object.keys(data.activity).length : 0;
    
    document.getElementById('viewCount').textContent = viewCount.toLocaleString();
    document.getElementById('activeCount').textContent = activeCount;
    
    const chatUsers = new Set();
    if (data.chat) {
        data.chat.forEach(msg => chatUsers.add(msg.user));
    }
    document.getElementById('chatOnlineCount').textContent = chatUsers.size;
    document.getElementById('chatMessageCount').textContent = data.chat ? data.chat.length : 0;
}

// ========== API FUNCTIONS ==========
async function api(method, data = null, force = false) {
    if (method === 'GET' && !force && dataCache && (Date.now() - lastFetchTime) < CACHE_TTL) {
        return dataCache;
    }
    
    try {
        const startTime = Date.now();
        const r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}${method==='GET'?'/latest':''}`, {
            method: method,
            headers: { 
                "Content-Type": "application/json", 
                "X-Master-Key": JSON_KEY,
                "X-Bin-Versioning": "false" 
            },
            body: data ? JSON.stringify(data) : null
        });
        
        const res = await r.json();
        
        if (method === 'GET') {
            dataCache = res.record;
            lastFetchTime = Date.now();
            
            if (pendingUpdates.length > 0) {
                for (const update of pendingUpdates) {
                    Object.assign(dataCache, update);
                }
                pendingUpdates = [];
            }
        } else if (method === 'PUT') {
            dataCache = data;
            lastFetchTime = Date.now();
        }
        
        document.getElementById('connectionStatus').className = 'connection-status connected';
        document.getElementById('connectionStatus').innerHTML = '<div class="status-dot"></div><span>Connected</span>';
        
        return dataCache;
    } catch (e) {
        console.error("API Error:", e);
        document.getElementById('connectionStatus').className = 'connection-status disconnected';
        document.getElementById('connectionStatus').innerHTML = '<div class="status-dot"></div><span>Disconnected</span>';
        return dataCache || null;
    }
}

async function batchUpdate(updates) {
    if (isUpdating) {
        pendingUpdates.push(updates);
        return;
    }
    
    isUpdating = true;
    try {
        const currentData = await api('GET', null, true);
        Object.assign(currentData, updates);
        await api('PUT', currentData);
        
        while (pendingUpdates.length > 0) {
            const nextUpdate = pendingUpdates.shift();
            Object.assign(currentData, nextUpdate);
            await api('PUT', currentData);
        }
    } catch (e) {
        console.error("Batch update failed:", e);
        if (dataCache) {
            Object.assign(dataCache, updates);
        }
    } finally {
        isUpdating = false;
    }
}

// ========== CHAT SYSTEM ==========
async function updateChat() {
    const data = await api('GET');
    if (!data) return;
    
    updateStatsDisplay(data);
    
    if (data.bans && data.bans[currentUser]) {
        document.getElementById('chat-toggle').classList.add('hidden');
        document.getElementById('chat-window').classList.add('hidden');
        return;
    }
    
    const chatWindow = document.getElementById('chat-window');
    const chatToggle = document.getElementById('chat-toggle');
    
    if (chatWindow.classList.contains('hidden')) {
        chatToggle.classList.remove('hidden');
    }
    
    const pinnedArea = document.getElementById('pinned-area');
    if (data.pinned && data.pinned.active && data.pinned.text) {
        pinnedArea.classList.remove('hidden');
        document.getElementById('pinnedText').textContent = data.pinned.text;
    } else {
        pinnedArea.classList.add('hidden');
    }
    
    renderMessages(data.chat || []);
}

function renderMessages(messages) {
    const container = document.getElementById('chat-msgs');
    const currentTime = Date.now();
    
    if (messages.length > 0) {
        const latestMsg = messages[messages.length - 1];
        const latestTime = latestMsg.timestamp || 0;
        const chatWindowHidden = document.getElementById('chat-window').classList.contains('hidden');
        
        if (latestTime > lastSeenMessageTime && chatWindowHidden && latestMsg.user !== currentUser) {
            lastSeenMessageTime = latestTime;
            unreadCount++;
            updateUnreadBadge();
        }
    }
    
    if (messages.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üí¨</div>
                <div>No messages yet. Be the first to say hello!</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = messages.map((msg, index) => {
        const isOwner = msg.user === SUPER_ADMIN;
        const isSystem = msg.user === "SYSTEM";
        const isCurrentUser = msg.user === currentUser;
        
        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Just now';
        
        let replyHtml = '';
        if (msg.replyTo) {
            replyHtml = `
                <div class="reply-quote">
                    Replying to <strong>${msg.replyTo.user}</strong>: ${msg.replyTo.text}
                </div>
            `;
        }
        
        let reactionsHtml = '';
        if (msg.reactions && Object.keys(msg.reactions).length > 0) {
            reactionsHtml = `
                <div class="reactions-container">
                    ${Object.entries(msg.reactions).map(([emoji, count]) => {
                        const usersReacted = msg.reactionUsers?.[emoji] || [];
                        const isUserReacted = usersReacted.includes(currentUser);
                        const initiator = usersReacted.length > 0 ? usersReacted[0] : null;
                        
                        return `
                            <button class="reaction-btn-small ${isUserReacted ? 'active' : ''}" 
                                    onclick="handleReaction(${index}, '${emoji}')"
                                    title="${usersReacted.join(', ') || 'No reactions yet'}">
                                <span class="reaction-emoji-small">${emoji}</span>
                                <span class="reaction-count-small">${count}</span>
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        return `
            <div class="msg-item ${isSystem ? 'system' : ''} ${isOwner ? 'owner-msg' : ''} ${isCurrentUser ? 'current-user' : ''}" 
                 data-index="${index}"
                 onmouseenter="showMessageActions(${index})"
                 onmouseleave="hideMessageActions(${index})">
                
                <div class="msg-header">
                    <div class="msg-user">
                        ${isOwner ? '<span class="owner-badge">üëë</span>' : ''}
                        ${msg.user}
                    </div>
                    <div class="msg-time">${time}</div>
                </div>
                
                ${replyHtml}
                
                <div class="msg-content">
                    ${msg.txt}
                </div>
                
                ${reactionsHtml}
                
                <div class="msg-actions" id="msg-actions-${index}">
                    <button class="action-btn" onclick="openEmojiPicker(${index})" title="Add reaction">üòä</button>
                    <button class="action-btn" onclick="setupReply(${index}, '${msg.user}', '${msg.txt}')" title="Reply">‚Ü©Ô∏è</button>
                    ${isAdminAuthenticated ? `<button class="action-btn delete" onclick="deleteMessage(${index})" title="Delete">üóëÔ∏è</button>` : ''}
                </div>
                
                ${activeEmojiPicker === index ? renderEmojiPicker(index) : ''}
            </div>
        `;
    }).join('');
    
    if (activeEmojiPicker === null) {
        container.scrollTop = container.scrollHeight;
    }
}

function renderEmojiPicker(index) {
    return `
        <div class="emoji-picker" id="emoji-picker-${index}">
            ${['‚ù§Ô∏è','üòÇ','üî•','üíÄ','üòÆ','üò¢','üëç','üëé','üéâ','üëè','ü§î','üòç'].map(emoji => `
                <button class="emoji-btn" onclick="handleReaction(${index}, '${emoji}')">${emoji}</button>
            `).join('')}
        </div>
    `;
}

// ========== CHAT INTERACTIONS ==========
function openEmojiPicker(index) {
    if (activeEmojiPicker === index) {
        activeEmojiPicker = null;
    } else {
        activeEmojiPicker = index;
    }
    updateChat();
}

function hideEmojiPicker() {
    activeEmojiPicker = null;
    updateChat();
}

function showMessageActions(index) {
    const actions = document.getElementById(`msg-actions-${index}`);
    if (actions) {
        actions.style.display = 'flex';
    }
}

function hideMessageActions(index) {
    const actions = document.getElementById(`msg-actions-${index}`);
    if (actions) {
        actions.style.display = 'none';
    }
}

async function handleReaction(index, emoji) {
    if (!currentUser) return;
    
    const data = await api('GET');
    if (!data.chat || !data.chat[index]) return;
    
    if (!data.chat[index].reactions) data.chat[index].reactions = {};
    if (!data.chat[index].reactionUsers) data.chat[index].reactionUsers = {};
    if (!data.chat[index].reactionUsers[emoji]) data.chat[index].reactionUsers[emoji] = [];
    
    const usersReacted = data.chat[index].reactionUsers[emoji];
    const userIndex = usersReacted.indexOf(currentUser);
    const currentCount = data.chat[index].reactions[emoji] || 0;
    
    if (currentCount === 1 && usersReacted.length === 1 && usersReacted[0] === currentUser) {
        delete data.chat[index].reactions[emoji];
        delete data.chat[index].reactionUsers[emoji];
        showToast('Reaction removed', 'info', 1500);
    } else if (userIndex === -1) {
        data.chat[index].reactions[emoji] = currentCount + 1;
        usersReacted.push(currentUser);
        showToast(`Reacted with ${emoji}`, 'success', 1500);
    } else {
        data.chat[index].reactions[emoji] = currentCount - 1;
        usersReacted.splice(userIndex, 1);
        
        if (data.chat[index].reactions[emoji] <= 0) {
            delete data.chat[index].reactions[emoji];
        }
        if (usersReacted.length === 0) {
            delete data.chat[index].reactionUsers[emoji];
        }
        showToast('Reaction removed', 'info', 1500);
    }
    
    renderMessages(data.chat);
    await batchUpdate({ chat: data.chat });
    activeEmojiPicker = null;
}

function setupReply(index, user, text) {
    activeReplyTarget = {
        index: index,
        user: user,
        text: text.substring(0, 50) + (text.length > 50 ? '...' : '')
    };
    
    document.getElementById('replyPreviewText').textContent = `Replying to ${user}: ${activeReplyTarget.text}`;
    document.getElementById('reply-preview').classList.remove('hidden');
    document.getElementById('chat-input').focus();
}

function cancelReply() {
    activeReplyTarget = null;
    document.getElementById('reply-preview').classList.add('hidden');
}

async function sendChat() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    
    if (!text) return;
    
    if (moderate(text)) {
        showToast('Message contains blocked content', 'error', 2000);
        input.value = '';
        return;
    }
    
    const data = await api('GET');
    
    if (data.bans && data.bans[currentUser]) {
        showToast('You are banned from chat', 'error', 3000);
        return;
    }
    
    const message = {
        user: currentUser,
        txt: text,
        timestamp: Date.now(),
        replyTo: activeReplyTarget
    };
    
    data.chat = data.chat || [];
    data.chat.push(message);
    
    if (data.chat.length > 100) {
        data.chat = data.chat.slice(-100);
    }
    
    renderMessages(data.chat);
    await batchUpdate({ chat: data.chat });
    
    input.value = '';
    cancelReply();
    
    clearTimeout(typingTimeout);
    document.getElementById('typingIndicator').classList.add('hidden');
}

async function deleteMessage(index) {
    if (!isAdminAuthenticated) return;
    
    if (!confirm('Delete this message?')) return;
    
    const data = await api('GET');
    if (data.chat && data.chat[index]) {
        data.chat.splice(index, 1);
        
        renderMessages(data.chat);
        await batchUpdate({ chat: data.chat });
        
        showToast('Message deleted', 'warning', 2000);
    }
}

function updateUnreadBadge() {
    const badge = document.getElementById('unread-badge');
    if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

function handleTyping() {
    if (!currentUser) return;
    
    lastTypingTime = Date.now();
    clearTimeout(typingTimeout);
    document.getElementById('typingIndicator').classList.add('hidden');
}

// ========== GAME MANAGEMENT ==========
function showGameCreateView() {
    document.getElementById('adminDefaultView').classList.add('hidden');
    document.getElementById('gameCreateView').classList.remove('hidden');
    
    document.getElementById('gameNameInput').value = '';
    document.getElementById('gameIdInput').value = '';
    document.getElementById('gameImagePreview').style.display = 'none';
    document.getElementById('imagePlaceholder').style.display = 'block';
    gameImageData = null;
    document.getElementById('gameCreateStatus').textContent = '';
}

function showGamesDashboard() {
    document.getElementById('gameCreateView').classList.add('hidden');
    document.getElementById('scriptManagementView').classList.add('hidden');
    document.getElementById('adminDefaultView').classList.remove('hidden');
    loadGamesDashboard();
}

function showScriptManagement(game) {
    selectedGame = game;
    currentGameId = game.id;
    
    document.getElementById('currentGameName').textContent = game.name;
    document.getElementById('currentGameId').textContent = `ID: ${game.id}`;
    
    const gameImage = document.getElementById('currentGameImage');
    if (game.image) {
        gameImage.src = game.image;
        gameImage.style.display = 'block';
    } else {
        gameImage.style.display = 'none';
    }
    
    document.getElementById('adminDefaultView').classList.add('hidden');
    document.getElementById('scriptManagementView').classList.remove('hidden');
    
    loadGameScripts();
}

// Image upload
document.getElementById('gameImageInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (file.size > 2 * 1024 * 1024) {
        showToast('Image too large. Max 2MB allowed.', 'error');
        return;
    }
    
    if (!file.type.match('image.*')) {
        showToast('Please select an image file.', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const maxWidth = 400;
            const maxHeight = 400;
            
            let width = img.width;
            let height = img.height;
            
            if (width > height) {
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width *= maxHeight / height;
                    height = maxHeight;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            
            gameImageData = canvas.toDataURL('image/jpeg', 0.8);
            
            const preview = document.getElementById('gameImagePreview');
            preview.src = gameImageData;
            preview.style.display = 'block';
            document.getElementById('imagePlaceholder').style.display = 'none';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
});

async function createGame() {
    const gameName = document.getElementById('gameNameInput').value.trim();
    const gameId = document.getElementById('gameIdInput').value.trim();
    const status = document.getElementById('gameCreateStatus');
    
    if (!gameName || !gameId) {
        status.textContent = 'Please fill in all fields';
        return;
    }
    
    if (!/^\d+$/.test(gameId)) {
        status.textContent = 'Game ID must be numeric';
        return;
    }
    
    showLoading('Creating game...');
    
    try {
        const data = await api('GET');
        
        if (!data.games) data.games = [];
        
        if (data.games.some(game => game.id === gameId)) {
            status.textContent = 'Game with this ID already exists';
            hideLoading();
            return;
        }
        
        const game = {
            id: gameId,
            name: gameName,
            image: gameImageData || null,
            scripts: [],
            createdBy: currentUser,
            createdAt: Date.now(),
            updatedAt: Date.now()
        };
        
        data.games.push(game);
        await batchUpdate({ games: data.games });
        
        hideLoading();
        showToast('Game created successfully!', 'success');
        showGamesDashboard();
        
    } catch (error) {
        hideLoading();
        status.textContent = 'Error creating game';
        console.error('Create game error:', error);
    }
}

async function loadGamesDashboard() {
    const data = await api('GET');
    const games = data.games || [];
    
    document.getElementById('totalGames').textContent = `${games.length} game${games.length !== 1 ? 's' : ''}`;
    
    let totalScripts = 0;
    games.forEach(game => {
        totalScripts += (game.scripts || []).length;
    });
    document.getElementById('totalScripts').textContent = `${totalScripts} script${totalScripts !== 1 ? 's' : ''}`;
    
    const dashboard = document.getElementById('gamesDashboard');
    const noGamesMsg = document.getElementById('noGamesMessage');
    
    if (games.length === 0) {
        dashboard.innerHTML = '';
        noGamesMsg.classList.remove('hidden');
        return;
    }
    
    noGamesMsg.classList.add('hidden');
    
    dashboard.innerHTML = games.map(game => {
        const scriptCount = (game.scripts || []).length;
        
        return `
            <div class="game-card" onclick="showScriptManagement(${JSON.stringify(game).replace(/"/g, '&quot;')})">
                <div class="game-actions">
                    <button class="game-action-btn delete" onclick="event.stopPropagation(); deleteGame('${game.id}')" title="Delete Game">üóëÔ∏è</button>
                </div>
                ${game.image ? 
                    `<img src="${game.image}" class="game-card-image" alt="${game.name}">` :
                    `<div class="game-card-image" style="display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg, var(--primary), var(--secondary));">
                        <span style="font-size:24px; opacity:0.8;">üéÆ</span>
                    </div>`
                }
                <div class="game-card-title">${game.name}</div>
                <div class="game-card-id">ID: ${game.id}</div>
                <div class="game-card-scripts">${scriptCount} script${scriptCount !== 1 ? 's' : ''}</div>
            </div>
        `;
    }).join('');
}

async function loadGameScripts() {
    if (!selectedGame) return;
    
    const data = await api('GET');
    const games = data.games || [];
    const game = games.find(g => g.id === selectedGame.id);
    
    if (!game) {
        showToast('Game not found', 'error');
        showGamesDashboard();
        return;
    }
    
    const scriptsList = document.getElementById('scriptsList');
    const noScriptsMsg = document.getElementById('noScriptsMessage');
    const scripts = game.scripts || [];
    
    if (scripts.length === 0) {
        scriptsList.innerHTML = '';
        noScriptsMsg.classList.remove('hidden');
        return;
    }
    
    noScriptsMsg.classList.add('hidden');
    
    scriptsList.innerHTML = scripts.map((script, index) => {
        return `
            <div class="script-item">
                <div class="script-url">${script.url}</div>
                <div class="script-actions">
                    <button class="mini danger" onclick="deleteScript(${index})">Delete</button>
                    <button class="mini warning" onclick="testScript('${script.url}')">Test</button>
                </div>
            </div>
        `;
    }).join('');
}

async function addScriptToGame() {
    if (!selectedGame) return;
    
    const scriptUrl = document.getElementById('scriptUrlInput').value.trim();
    const status = document.getElementById('scriptAddStatus');
    
    if (!scriptUrl) {
        status.textContent = 'Please enter a script URL';
        return;
    }
    
    if (!scriptUrl.startsWith('http://') && !scriptUrl.startsWith('https://')) {
        status.textContent = 'Please enter a valid URL starting with http:// or https://';
        return;
    }
    
    showLoading('Adding script...');
    
    try {
        const data = await api('GET');
        const games = data.games || [];
        const gameIndex = games.findIndex(g => g.id === selectedGame.id);
        
        if (gameIndex === -1) {
            showToast('Game not found', 'error');
            hideLoading();
            return;
        }
        
        if (!games[gameIndex].scripts) games[gameIndex].scripts = [];
        
        games[gameIndex].scripts.push({
            url: scriptUrl,
            addedBy: currentUser,
            addedAt: Date.now()
        });
        
        games[gameIndex].updatedAt = Date.now();
        await batchUpdate({ games: games });
        
        document.getElementById('scriptUrlInput').value = '';
        status.textContent = '';
        
        hideLoading();
        showToast('Script added successfully!', 'success');
        
        selectedGame = games[gameIndex];
        loadGameScripts();
        
    } catch (error) {
        hideLoading();
        status.textContent = 'Error adding script';
        console.error('Add script error:', error);
    }
}

async function deleteScript(scriptIndex) {
    if (!selectedGame || !confirm('Delete this script?')) return;
    
    showLoading('Deleting script...');
    
    try {
        const data = await api('GET');
        const games = data.games || [];
        const gameIndex = games.findIndex(g => g.id === selectedGame.id);
        
        if (gameIndex === -1) {
            showToast('Game not found', 'error');
            hideLoading();
            return;
        }
        
        games[gameIndex].scripts.splice(scriptIndex, 1);
        games[gameIndex].updatedAt = Date.now();
        await batchUpdate({ games: games });
        
        hideLoading();
        showToast('Script deleted!', 'warning');
        
        selectedGame = games[gameIndex];
        loadGameScripts();
        
    } catch (error) {
        hideLoading();
        showToast('Error deleting script', 'error');
        console.error('Delete script error:', error);
    }
}

async function deleteGame(gameId) {
    if (!confirm('Are you sure you want to delete this game and all its scripts?')) return;
    
    showLoading('Deleting game...');
    
    try {
        const data = await api('GET');
        const games = data.games || [];
        const gameIndex = games.findIndex(g => g.id === gameId);
        
        if (gameIndex === -1) {
            showToast('Game not found', 'error');
            hideLoading();
            return;
        }
        
        games.splice(gameIndex, 1);
        await batchUpdate({ games: games });
        
        hideLoading();
        showToast('Game deleted!', 'warning');
        loadGamesDashboard();
        
    } catch (error) {
        hideLoading();
        showToast('Error deleting game', 'error');
        console.error('Delete game error:', error);
    }
}

async function testScript(url) {
    showLoading('Testing script...');
    
    try {
        const response = await fetch(url, { method: 'HEAD' });
        
        hideLoading();
        
        if (response.ok) {
            showToast('Script URL is accessible!', 'success');
            
            navigator.clipboard.writeText(url).then(() => {
                showToast('URL copied to clipboard', 'info');
            });
        } else {
            showToast('Script URL returned error ' + response.status, 'warning');
        }
    } catch (error) {
        hideLoading();
        showToast('Script URL is not accessible', 'error');
    }
}

// ========== UI CONTROLS ==========
function toggleChat(open) {
    const win = document.getElementById('chat-window');
    const toggle = document.getElementById('chat-toggle');
    
    if (open) {
        win.classList.remove('hidden');
        toggle.classList.add('hidden');
        
        unreadCount = 0;
        updateUnreadBadge();
        
        if (dataCache && dataCache.chat && dataCache.chat.length > 0) {
            const lastMsg = dataCache.chat[dataCache.chat.length - 1];
            lastSeenMessageTime = lastMsg.timestamp || Date.now();
        }
    } else {
        win.classList.add('hidden');
        toggle.classList.remove('hidden');
    }
    
    updateChat();
}

function toggleAuth(showSignup) {
    document.getElementById('signupView').classList.toggle('hidden', !showSignup);
    document.getElementById('loginView').classList.toggle('hidden', showSignup);
}

function toggleFeedbackUI(show) {
    const fbUI = document.getElementById('userFeedbackUI');
    const main = document.getElementById('mainContentWrapper');
    if (show) {
        fbUI.classList.remove('hidden');
        main.classList.add('hidden');
    } else {
        fbUI.classList.add('hidden');
        main.classList.remove('hidden');
    }
}

// ========== INITIALIZATION ==========
window.onload = async () => {
    initParticleBackground();
    
    function updateTime() {
        const now = new Date();
        document.getElementById('currentTime').textContent = 
            now.getHours().toString().padStart(2, '0') + ':' + 
            now.getMinutes().toString().padStart(2, '0');
    }
    updateTime();
    setInterval(updateTime, 60000);
    
    const saved = localStorage.getItem('rsq_session');
    if (saved) {
        try {
            const session = JSON.parse(saved);
            document.getElementById('l-user').value = session.u;
            document.getElementById('l-pass').value = session.p;
            handleAuth('login');
        } catch (e) {
            localStorage.removeItem('rsq_session');
        }
    }
    
    statsPollingInterval = setInterval(trackViewAndActivity, 5000);
    trackViewAndActivity();
    
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.addEventListener('input', handleTyping);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChat();
            }
        });
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });
    }
    
    document.addEventListener('click', (e) => {
        if (activeEmojiPicker !== null && !e.target.closest('.emoji-picker') && !e.target.closest('.action-btn')) {
            hideEmojiPicker();
        }
    });
    
    document.getElementById('gameImageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.size > 2 * 1024 * 1024) {
            showToast('Image too large. Max 2MB allowed.', 'error');
            this.value = '';
        }
    });
    
    document.getElementById('fb-msg')?.addEventListener('input', function() {
        const count = this.value.length;
        document.getElementById('fbCharCount').textContent = `${count}/500`;
    });
    
    document.getElementById('focusBanReason')?.addEventListener('input', function() {
        const count = this.value.length;
        document.getElementById('reasonCharCount').textContent = `${count}/200`;
    });
};

function initParticleBackground() {
    const canvas = document.getElementById('particles');
    const ctx = canvas.getContext('2d');
    let particles = [];
    
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    
    function createParticles() {
        particles = [];
        const particleCount = Math.min(50, Math.floor((canvas.width * canvas.height) / 20000));
        
        for (let i = 0; i < particleCount; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 1.5 + 0.5,
                speedX: Math.random() * 0.3 - 0.15,
                speedY: Math.random() * 0.3 - 0.15,
                color: `rgba(79, 124, 255, ${Math.random() * 0.1 + 0.05})`
            });
        }
    }
    
    function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        for (let particle of particles) {
            particle.x += particle.speedX;
            particle.y += particle.speedY;
            
            if (particle.x < 0) particle.x = canvas.width;
            if (particle.x > canvas.width) particle.x = 0;
            if (particle.y < 0) particle.y = canvas.height;
            if (particle.y > canvas.height) particle.y = 0;
            
            ctx.beginPath();
            ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
            ctx.fillStyle = particle.color;
            ctx.fill();
        }
        
        requestAnimationFrame(animateParticles);
    }
    
    window.addEventListener('resize', () => {
        resizeCanvas();
        createParticles();
    });
    
    resizeCanvas();
    createParticles();
    animateParticles();
}

// ========== AUTHENTICATION ==========
async function handleAuth(type) {
    const status = document.getElementById('authStatus');
    const spinnerId = type === 'signup' ? 'signupSpinner' : 'loginSpinner';
    const spinner = document.getElementById(spinnerId);
    
    status.textContent = '';
    spinner.style.display = 'inline-block';
    
    const u = document.getElementById(type === 'signup' ? 's-user' : 'l-user').value.trim();
    const p = document.getElementById(type === 'signup' ? 's-pass' : 'l-pass').value.trim();
    
    if (!u || !p) {
        status.textContent = 'Please fill in all fields';
        spinner.style.display = 'none';
        return;
    }
    
    const data = await api('GET', null, true);
    if (!data.users) data.users = {};
    
    if (type === 'signup') {
        if (data.users[u]) {
            status.textContent = 'Username already exists';
            spinner.style.display = 'none';
            return;
        }
        
        if (moderate(u)) {
            status.textContent = 'Invalid username';
            spinner.style.display = 'none';
            return;
        }
        
        data.users[u] = { pass: p, created: now() };
        await batchUpdate({ users: data.users });
        
        status.textContent = 'Account created! Please sign in.';
        showToast('Account created successfully', 'success');
        spinner.style.display = 'none';
        toggleAuth(false);
        
    } else {
        const isOwner = (u === SUPER_ADMIN && p === OWNER_PASS);
        const isRegular = (data.users[u] && data.users[u].pass === p);
        
        if (isOwner || isRegular) {
            currentUser = u;
            localStorage.setItem('rsq_session', JSON.stringify({ u, p }));
            
            if (u === SUPER_ADMIN) {
                document.getElementById('adminBtn').classList.remove('hidden');
                showToast('Admin privileges granted', 'warning');
            }
            
            document.getElementById('authPanel').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            document.getElementById('welcomeUser').textContent = `Logged in as ${u}`;
            
            chatPollingInterval = setInterval(updateChat, 2000);
            updateChat();
            
            setInterval(trackViewAndActivity, 10000);
            
            showToast(`Welcome back, ${u}!`, 'success');
            
        } else {
            status.textContent = 'Invalid credentials';
            spinner.style.display = 'none';
            showToast('Invalid username or password', 'error');
        }
    }
}

// ========== KEY GENERATION ==========
async function generateKey() {
    const status = document.getElementById('statusMsg');
    const spinner = document.getElementById('keySpinner');
    
    status.textContent = '';
    spinner.style.display = 'inline-block';
    
    const rbxId = document.getElementById('userid').value.trim();
    if (!rbxId) {
        status.textContent = 'Please enter a Roblox UserID';
        spinner.style.display = 'none';
        return;
    }
    
    const data = await api('GET');
    
    if (data.bans && (data.bans[currentUser] || data.bans[rbxId])) {
        status.textContent = 'You are restricted from generating keys';
        spinner.style.display = 'none';
        showToast('Access denied: Account is restricted', 'error');
        return;
    }
    
    data.keys = data.keys || {};
    
    let existingKey = null;
    for (const [key, keyData] of Object.entries(data.keys)) {
        if (keyData.user === currentUser && keyData.rbx === rbxId) {
            if (keyData.exp === "INF" || keyData.exp > now()) {
                existingKey = key;
                break;
            }
        }
    }
    
    if (existingKey) {
        document.getElementById('keyOut').textContent = existingKey;
        status.textContent = 'Existing key found';
        showToast('Using existing key', 'info');
    } else {
        const newKey = 'RSQ-' + Math.random().toString(36).substring(2, 10).toUpperCase();
        data.keys[newKey] = {
            user: currentUser,
            rbx: rbxId,
            created: now(),
            exp: now() + 86400
        };
        
        await batchUpdate({ keys: data.keys });
        
        document.getElementById('keyOut').textContent = newKey;
        status.textContent = 'Key generated (valid 24 hours)';
        showToast('New key generated!', 'success');
    }
    
    spinner.style.display = 'none';
}

// ========== FEEDBACK FUNCTIONS ==========
async function submitFeedback() {
    const user = document.getElementById('fb-user').value.trim();
    const id = document.getElementById('fb-id').value.trim();
    const msg = document.getElementById('fb-msg').value.trim();
    
    if (!user || !id || !msg) {
        showToast('Please fill all fields', 'warning', 2000);
        return;
    }
    
    const spinner = document.getElementById('fbSpinner');
    spinner.style.display = 'inline-block';
    
    const data = await api('GET');
    data.feedbacks ||= [];
    data.feedbacks.push({
        user: user,
        id: id,
        msg: msg,
        time: new Date().toLocaleString(),
        read: false
    });
    
    await batchUpdate({ feedbacks: data.feedbacks });
    
    document.getElementById('fb-user').value = '';
    document.getElementById('fb-id').value = '';
    document.getElementById('fb-msg').value = '';
    document.getElementById('fbCharCount').textContent = '0/500';
    
    spinner.style.display = 'none';
    showToast('Feedback submitted! Thank you.', 'success', 2000);
    toggleFeedbackUI(false);
}

async function renderAdminFeedbacks() {
    const data = await api('GET');
    const feedbacks = data.feedbacks || [];
    const search = document.getElementById('fbSearch').value.toLowerCase();
    
    const filtered = feedbacks.filter(fb => 
        !search || 
        fb.user.toLowerCase().includes(search) || 
        fb.id.toLowerCase().includes(search) ||
        fb.msg.toLowerCase().includes(search)
    );
    
    const fbLogs = document.getElementById('fbLogs');
    if (filtered.length === 0) {
        fbLogs.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><div>No feedbacks found</div></div>';
        return;
    }
    
    fbLogs.innerHTML = filtered.reverse().map((fb, index) => `
        <div class="fb-item" onclick="viewSingleFeedback(${index})">
            <div>
                <div style="font-weight:600; font-size:12px; color:var(--secondary);">${fb.user} (${fb.id})</div>
                <div style="font-size:11px; opacity:0.8; margin-top:3px;">${fb.msg.substring(0, 60)}${fb.msg.length > 60 ? '...' : ''}</div>
                <div style="font-size:9px; opacity:0.6; margin-top:3px;">${fb.time}</div>
            </div>
            ${!fb.read ? '<span style="background:var(--primary); color:white; font-size:9px; padding:2px 6px; border-radius:10px;">NEW</span>' : ''}
        </div>
    `).join('');
}

function viewSingleFeedback(index) {
    const data = dataCache;
    if (!data.feedbacks || !data.feedbacks[index]) return;
    
    const fb = data.feedbacks[index];
    document.getElementById('viewFbTitle').textContent = `Feedback from ${fb.user}`;
    document.getElementById('viewFbContent').innerHTML = `
        <div style="margin-bottom:15px;">
            <div style="font-size:12px; opacity:0.8; margin-bottom:5px;">User Information</div>
            <div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:8px;">
                <div><strong>Username:</strong> ${fb.user}</div>
                <div><strong>UserID:</strong> ${fb.id}</div>
                <div><strong>Submitted:</strong> ${fb.time}</div>
            </div>
        </div>
        <div>
            <div style="font-size:12px; opacity:0.8; margin-bottom:5px;">Feedback Message</div>
            <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:8px; white-space:pre-wrap; font-size:13px; line-height:1.5;">${fb.msg}</div>
        </div>
    `;
    
    document.getElementById('adminFeedbackListView').classList.add('hidden');
    document.getElementById('adminViewFeedbackUI').classList.remove('hidden');
    
    if (!fb.read) {
        data.feedbacks[index].read = true;
        batchUpdate({ feedbacks: data.feedbacks });
    }
}

function closeSingleFeedback() {
    document.getElementById('adminViewFeedbackUI').classList.add('hidden');
    document.getElementById('adminFeedbackListView').classList.remove('hidden');
}

function openAdminFeedbacks() {
    document.getElementById('adminDefaultView').classList.add('hidden');
    document.getElementById('adminFeedbackListView').classList.remove('hidden');
    renderAdminFeedbacks();
}

function returnToAdminPanel() {
    document.getElementById('adminFeedbackListView').classList.add('hidden');
    document.getElementById('adminViewFeedbackUI').classList.add('hidden');
    document.getElementById('adminDefaultView').classList.remove('hidden');
}

// ========== ADMIN FUNCTIONS ==========
async function renderAdminKeys() {
    const log = document.getElementById('keyLogs');
    const data = await api('GET');
    
    const keyCount = data.keys ? Object.keys(data.keys).length : 0;
    document.getElementById('keyCount').textContent = `${keyCount} key${keyCount !== 1 ? 's' : ''}`;
    
    if(!data.keys || Object.keys(data.keys).length === 0) {
        log.innerHTML = '<div style="text-align:center; padding:40px; opacity:0.5;">No active keys found.</div>';
        return;
    }

    log.innerHTML = Object.keys(data.keys).map(k => {
        const keyObj = data.keys[k];
        const isInf = keyObj.exp === "INF";
        const timeLeft = isInf ? "Never" : new Date(keyObj.exp * 1000).toLocaleString();
        
        return `
        <div class="fb-item">
            <div>
                <div style="font-family:monospace; color:var(--secondary); font-weight:bold; font-size:12px;">${k}</div>
                <div style="font-size:10px; opacity:0.6; margin-top:2px;">üë§ Owner: ${keyObj.user}</div>
                <div style="font-size:10px; opacity:0.6;">üéÆ Roblox: ${keyObj.rbx}</div>
                <div style="font-size:10px; opacity:0.6;">‚è∞ Expires: ${timeLeft}</div>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="mini danger" onclick="keyAction('${k}', 'delete')" title="Delete key">üóëÔ∏è</button>
                <button class="mini warning" onclick="keyAction('${k}', 'renew')" title="Renew for 24h">üîÑ</button>
                <button class="mini success" onclick="keyAction('${k}', 'inf')" title="Make infinite">‚àû</button>
            </div>
        </div>`;
    }).reverse().join('');
}

async function keyAction(key, type) {
    const data = await api('GET');
    if(!data.keys[key]) return;

    data.notifications ||= {};
    const targetUser = data.keys[key].user;

    const updates = {};
    
    if(type === 'delete') {
        if (!confirm(`Delete key "${key}"?`)) return;
        data.notifications[targetUser] = { type: "DELETED", key: key, time: now() };
        delete data.keys[key];
        updates.keys = data.keys;
        updates.notifications = data.notifications;
        showToast(`Key ${key} deleted`, 'warning', 2000);
    } else if (type === 'renew') {
        data.keys[key].exp = now() + 86400;
        data.notifications[targetUser] = { type: "RENEWED", key: key, time: now() };
        updates.keys = data.keys;
        updates.notifications = data.notifications;
        showToast(`Key ${key} renewed`, 'success', 2000);
    } else if (type === 'inf') {
        data.keys[key].exp = "INF";
        data.notifications[targetUser] = { type: "INFINITE", key: key, time: now() };
        updates.keys = data.keys;
        updates.notifications = data.notifications;
        showToast(`Key ${key} set to infinite`, 'success', 2000);
    }

    await batchUpdate(updates);
    renderAdminKeys();
}

async function renderBanLogs() {
    const log = document.getElementById('banLogs');
    const data = await api('GET');
    
    const banCount = data.bans ? Object.keys(data.bans).length : 0;
    document.getElementById('banCount').textContent = `${banCount} banned`;
    
    if(!data.bans || Object.keys(data.bans).length === 0) {
        log.innerHTML = '<div style="text-align:center; padding:40px; opacity:0.5;">No users are banned.</div>';
        return;
    }

    log.innerHTML = Object.keys(data.bans).map(u => `
        <div class="fb-item">
            <div>
                <div style="font-weight:600; font-size:12px; color:var(--danger);">${u}</div>
                <div style="font-size:10px; opacity:0.6; margin-top:2px;">üÜî ID: ${data.bans[u].id}</div>
                <div style="font-size:10px; opacity:0.6;">üìù Reason: ${data.bans[u].reason}</div>
                <div style="font-size:10px; opacity:0.6;">üìÖ Date: ${data.bans[u].date}</div>
            </div>
            <button class="mini danger" onclick="removeBan('${u}')" title="Unban user">üîì</button>
        </div>
    `).join('');
}

async function removeBan(user) {
    if (!confirm(`Unban ${user}?`)) return;
    
    const data = await api('GET');
    delete data.bans[user];
    await batchUpdate({ bans: data.bans });
    renderBanLogs();
    showToast(`${user} unbanned`, 'success', 2000);
}

function toggleBanNowView(show) {
    if(show) {
        document.getElementById('adminDefaultView').classList.add('hidden');
        document.getElementById('banNowView').classList.remove('hidden');
    } else {
        document.getElementById('banNowView').classList.add('hidden');
        document.getElementById('adminDefaultView').classList.remove('hidden');
    }
}

async function executeFocusBan() {
    const id = document.getElementById('focusBanId').value.trim();
    const user = document.getElementById('focusBanUser').value.trim();
    const reason = document.getElementById('focusBanReason').value.trim();

    if(!id || !user || !reason) {
        showToast('Please fill all fields', 'warning', 2000);
        return;
    }

    const data = await api('GET');
    data.bans ||= {};
    data.bans[user] = { id: id, reason: reason, date: new Date().toLocaleString() };

    await batchUpdate({ bans: data.bans });
    
    showToast(`${user} has been restricted`, 'error', 3000);
    
    document.getElementById('focusBanId').value = "";
    document.getElementById('focusBanUser').value = "";
    document.getElementById('focusBanReason').value = "";
    
    toggleBanNowView(false);
    renderBanLogs();
}

async function sendGlobalMsg(isPin) {
    const msg = document.getElementById('globalMsgInput').value.trim();
    if(!msg) {
        showToast('Enter message text', 'warning', 2000);
        return;
    }
    
    const data = await api('GET');
    if(isPin) {
        data.pinned = { text: msg, active: true };
        showToast('Message pinned globally', 'success', 2000);
    } else {
        data.chat ||= [];
        data.chat.push({ user: "SYSTEM", txt: `[GLOBAL ANNOUNCEMENT]: ${msg}`, timestamp: Date.now() });
        showToast('Announcement sent', 'success', 2000);
    }
    
    await batchUpdate(isPin ? { pinned: data.pinned } : { chat: data.chat });
    updateChat();
}

async function clearGlobals() {
    if (!confirm("Clear all pinned messages?")) return;
    
    const data = await api('GET');
    data.pinned = { text: "", active: false };
    await batchUpdate({ pinned: data.pinned });
    updateChat();
    showToast('Pinned messages cleared', 'warning', 2000);
}

async function clearAllChat() {
    if(!confirm("Wipe all chat messages?\nThis cannot be undone!")) return;
    const data = await api('GET');
    data.chat = [];
    await batchUpdate({ chat: data.chat });
    updateChat();
    showToast('Chat cleared', 'warning', 2000);
}

async function banAllKeyHolders() {
    if(!confirm("WARNING: This will ban ALL users who have active keys!\n\nAre you absolutely sure?")) return;
    
    showLoading('Banning all key holders...');
    
    try {
        const data = await api('GET');
        data.bans ||= {};
        
        const keys = data.keys || {};
        let count = 0;
        
        for (const key in keys) {
            const keyData = keys[key];
            if (!data.bans[keyData.user]) {
                data.bans[keyData.user] = {
                    id: keyData.rbx,
                    reason: "Mass ban - All key holders",
                    date: new Date().toLocaleString()
                };
                count++;
            }
        }
        
        await batchUpdate({ bans: data.bans });
        
        hideLoading();
        showToast(`Banned ${count} key holders`, 'warning', 3000);
        renderBanLogs();
        
    } catch (error) {
        hideLoading();
        showToast('Error banning key holders', 'error');
    }
}

async function unbanEveryone() {
    if(!confirm("Unban ALL users?\nThis cannot be undone.")) return;
    
    showLoading('Unbanning all users...');
    
    try {
        const data = await api('GET');
        const count = Object.keys(data.bans || {}).length;
        data.bans = {};
        
        await batchUpdate({ bans: data.bans });
        
        hideLoading();
        showToast(`Unbanned ${count} users`, 'success', 3000);
        renderBanLogs();
        
    } catch (error) {
        hideLoading();
        showToast('Error unbanning users', 'error');
    }
}

async function masterReset() {
    const target = document.getElementById('resetTarget').value;
    if(!confirm(`‚ö†Ô∏è CRITICAL WARNING:\nThis will PERMANENTLY wipe [${target.toUpperCase()}].\n\nThis action cannot be undone!`)) return;
    
    showLoading('Performing system reset...');
    
    try {
        const data = await api('GET');
        
        if(target === 'chat' || target === 'all') data.chat = [];
        if(target === 'bans' || target === 'all') data.bans = {};
        if(target === 'users' || target === 'all') {
            data.users = {
                [SUPER_ADMIN]: { pass: OWNER_PASS, warns: 0, lastWarn: 0, timeoutUntil: 0 }
            };
        }
        if(target === 'all') {
            data.keys = {};
            data.feedbacks = [];
            data.notifications = {};
            data.pinned = { text: "", active: false };
            data.games = [];
        }
        
        await batchUpdate(data);
        
        hideLoading();
        showToast(`System ${target} reset complete`, 'success', 3000);
        setTimeout(() => location.reload(), 1000);
        
    } catch (error) {
        hideLoading();
        showToast('Error performing reset', 'error');
    }
}

// ========== ADMIN PANEL LOAD ==========
document.getElementById('adminBtn').onclick = function() {
    if (isAdminAuthenticated) {
        document.getElementById('adminPanel').classList.remove('hidden');
        showToast('Admin panel opened', 'warning');
        
        loadGamesDashboard();
        renderAdminKeys();
        renderBanLogs();
    } else {
        document.getElementById('adminInput').classList.toggle('hidden');
    }
};

document.getElementById('adminInput').onchange = function() {
    if (this.value === MASTER_KEY) {
        isAdminAuthenticated = true;
        this.classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        showToast('Admin authentication successful', 'success');
        
        loadGamesDashboard();
        renderAdminKeys();
        renderBanLogs();
    } else {
        showToast('Invalid master key', 'error');
        this.value = '';
    }
};

function closeAdmin() {
    document.getElementById('adminPanel').classList.add('hidden');
    showToast('Admin panel closed', 'info', 1500);
}

// ========== LOGOUT ==========
function logout() {
    if (chatPollingInterval) clearInterval(chatPollingInterval);
    if (statsPollingInterval) clearInterval(statsPollingInterval);
    
    localStorage.removeItem('rsq_session');
    showToast('Logged out successfully', 'info');
    
    setTimeout(() => location.reload(), 500);
}
</script>
</body>
</html>
